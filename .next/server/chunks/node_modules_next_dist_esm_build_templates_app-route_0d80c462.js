module.exports=[74492,e=>{"use strict";var t=e.i(47909),n=e.i(74017),a=e.i(96250),s=e.i(59756),r=e.i(61916),o=e.i(14444),i=e.i(37092),l=e.i(69741),c=e.i(16795),d=e.i(87718),u=e.i(95169),m=e.i(47587),p=e.i(66012),h=e.i(70101),v=e.i(26937),g=e.i(10372),y=e.i(93695);e.i(52474);var _=e.i(220),f=e.i(89171),E=e.i(69122),w=e.i(3030);let{MAX_REQUEST_SIZE:C,REQUEST_TIMEOUT:R,RATE_LIMIT:b}=e.r(982);async function $(){return(0,w.handlePreflight)(new f.NextRequest("http://localhost",{method:"OPTIONS"}))}async function A(t){let n=await (0,w.handlePreflight)(t);if(n)return n;let a=(0,w.getClientIP)(t);if(!(0,w.checkRateLimit)(a,b.WINDOW,b.MAX_REQUESTS))return(0,w.sendErrorResponse)(Error("Too many requests. Please try again in a minute."),429);let s=(0,w.validateRequestSize)(t,C.LARGE);if(!s.valid)return(0,w.sendErrorResponse)(Error(s.error.message),s.error.status);let r=process.env.GEMINI_API_KEY;if(!r)return(0,w.logError)("GEMINI_API_KEY environment variable is not set"),(0,w.sendErrorResponse)(Error("Server configuration error"),500);try{let n,{transcription:a,salesforceContext:s,userId:i,accountId:l,salesforceAccountId:c,customerIdentifier:d,forceRefresh:u}=await t.json();if(null==a||!s)return(0,w.sendErrorResponse)(Error("Missing required parameters: transcription and salesforceContext"),400);if("string"!=typeof a||a.length>5e4)return(0,w.sendErrorResponse)(Error("Invalid transcription: must be a string under 50,000 characters"),400);if("object"!=typeof s||null===s)return(0,w.sendErrorResponse)(Error("Invalid salesforceContext: must be an object"),400);let m=e.r(54799),p=a?`${a.substring(0,1e3)}|${a.length}|${a.substring(Math.max(0,a.length-100))}`:"",h=m.createHash("sha256").update(JSON.stringify({transcriptionFingerprint:p,transcriptionLength:a?.length||0,casesCount:s.total_cases_count||0,avomaCallsTotal:s.total_avoma_calls||0,avomaCallsReady:s.ready_avoma_calls||0,contactLevels:s.contact_levels?{cLevelInCases:s.contact_levels.c_level_in_cases||0,srLevelInCases:s.contact_levels.sr_level_in_cases||0}:null,caseSignatures:s.recent_tickets?(s.recent_tickets||[]).slice(0,50).map(e=>({status:e.status||null,priority:e.priority||null,createdDay:e.created_date?new Date(e.created_date).toISOString().split("T")[0]:null})).sort((e,t)=>{let n=e.createdDay||"",a=t.createdDay||"";if(n!==a)return a.localeCompare(n);let s=e.status||"",r=t.status||"";if(s!==r)return s.localeCompare(r);let o=e.priority||"",i=t.priority||"";return o.localeCompare(i)}):null})).digest("hex");if(u)(0,w.log)("Force refresh requested - skipping cache check");else try{let e=(0,E.getSupabaseClient)();if(e&&(l||c)){let t=null;if(l&&l.includes("-")&&36===l.length)t=l,(0,w.log)(`accountId ${l} is a UUID, using directly for cache check`);else{let n=l||c;if(n){(0,w.log)(`Resolving account UUID from salesforce_id: ${n}`);let{data:a,error:s}=await e.from("accounts").select("id").eq("salesforce_id",n).maybeSingle();s?((0,w.logError)("Error looking up account for cache check:",s),t=null):a&&(t=a.id)}}if(t){let{data:n,error:r}=await e.from("sentiment_history").select("*").eq("account_id",t).eq("input_hash",h).order("analyzed_at",{ascending:!1}).limit(1).maybeSingle();if(r)(0,w.log)(`Error checking exact match cache: ${r.message}`);else if(n)return(0,w.log)(`✅ Found cached sentiment analysis with identical input data (analyzed at ${n.analyzed_at}) - returning cached result (no changes detected)`),(0,w.sendSuccessResponse)({score:n.score,summary:n.summary,comprehensiveAnalysis:n.comprehensive_analysis||n.summary,cached:!0,analyzedAt:n.analyzed_at,sentimentId:n.id});let o=new Date(Date.now()-6048e5).toISOString(),{data:i,error:l}=await e.from("sentiment_history").select("*").eq("account_id",t).gte("analyzed_at",o).eq("transcription_length",a?.length||0).eq("cases_count",s.total_cases_count||0).eq("avoma_calls_total",s.total_avoma_calls||0).eq("avoma_calls_ready",s.ready_avoma_calls||0).order("analyzed_at",{ascending:!1}).limit(1).maybeSingle();if(l)(0,w.logError)("Error checking recent analysis cache:",l);else if(i)return(0,w.log)(`✅ Using cached sentiment analysis from ${new Date(i.analyzed_at).toLocaleString()}`),(0,w.sendSuccessResponse)({score:i.score,summary:i.summary,comprehensiveAnalysis:i.comprehensive_analysis||i.summary,cached:!0,analyzedAt:i.analyzed_at,sentimentId:i.id})}}}catch(e){(0,w.logError)("Cache check failed, proceeding with new analysis:",e)}let v=process.env.GEMINI_MODEL||"gemini-1.5-pro",g={contents:[{parts:[{text:`Analyze the customer sentiment from the following conversation transcription and Salesforce account context.

=== CONVERSATION TRANSCRIPTION ===
${a||"(No transcription available)"}

=== SALESFORCE ACCOUNT CONTEXT ===
${JSON.stringify(s,null,2)}

=== ANALYSIS INSTRUCTIONS ===
Provide a comprehensive sentiment analysis considering:

1. **Conversation Sentiment**:
   - Initial customer tone and emotional state
   - Language patterns (positive/negative indicators, urgency, frustration)
   - Resolution quality and how concerns were addressed
   - Final outcome and customer satisfaction level

2. **Support Case Context**:
   - Number of recent support cases (${s.total_cases_count||0} total)
   - Case priorities and statuses (high priority or unresolved cases indicate issues)
   - Case descriptions (customer feedback and issue details)
   - Case types and reasons (patterns in support needs)
   - Resolution timelines (closed dates vs created dates)
   - **CRITICAL: Contact Level Involvement in Cases**:
     ${s.contact_levels?`
     * C-Level contacts involved in cases: ${s.contact_levels.c_level_in_cases||0} (${s.contact_levels.c_level_count||0} total C-Level contacts)
       - ⚠️ This is a MAJOR RED FLAG - C-Level executives submitting support cases indicates serious issues
       - C-Level involvement suggests problems have escalated to the highest levels
     * Sr. Level contacts involved in cases: ${s.contact_levels.sr_level_in_cases||0} (${s.contact_levels.sr_level_count||0} total Sr. Level contacts)
       - ⚠️ This is a SIGNIFICANT CONCERN - Senior leadership involvement indicates problems are not being resolved
       - Sr. Level (VP, Director, etc.) involvement suggests frustration and escalation
     * Other contacts involved in cases: ${s.contact_levels.other_in_cases||0} (${s.contact_levels.other_count||0} total other contacts)
     `:"Contact level data not available"}
     - **Weight case involvement by contact level heavily** - C-Level or Sr. Level on cases is a strong negative signal

3. **Account Profile**:
   - Account tier: ${s.account_tier||"Unknown"}
   - Contract value: ${s.contract_value||"Unknown"}
   - Industry: ${s.industry||"Unknown"}
   - Account manager: ${s.account_manager||"Unknown"}

4. **Engagement Metrics**:
   - Total Avoma calls: ${s.total_avoma_calls||0}
   - Ready transcripts: ${s.ready_avoma_calls||0}

5. **Contact Intelligence & Professional Context**${s.linkedin_data?`:
   - Total contacts: ${s.linkedin_data.total_contacts||0}
   - Contact breakdown by level:
     * C-Level: ${s.linkedin_data.contact_level_counts?.["C-Level"]||0} contacts
     * Sr. Level: ${s.linkedin_data.contact_level_counts?.["Sr. Level"]||0} contacts
     * Other: ${s.linkedin_data.contact_level_counts?.Other||0} contacts
   - Contacts involved in support cases by level:
     * C-Level: ${s.linkedin_data.case_involved_by_level?.["C-Level"]||0} (${s.linkedin_data.case_involved_by_level?.["C-Level"]>0?"⚠️ MAJOR CONCERN":"Good"})
     * Sr. Level: ${s.linkedin_data.case_involved_by_level?.["Sr. Level"]||0} (${s.linkedin_data.case_involved_by_level?.["Sr. Level"]>0?"⚠️ SIGNIFICANT CONCERN":"Good"})
     * Other: ${s.linkedin_data.case_involved_by_level?.Other||0}
   - Enriched profile data available: ${s.linkedin_data.contacts_with_enriched_data||0}
   - Key contact insights:
${s.linkedin_data.contacts.map(e=>{let t=[];if(t.push(`     * ${e.name}: ${e.current_title||"Title unknown"} at ${e.current_company||"Company unknown"}`),e.department&&t.push(`       - Department: ${e.department}`),e.reports_to_name&&t.push(`       - Reports to: ${e.reports_to_name} (hierarchy context)`),e.owner_name&&t.push(`       - Relationship owner: ${e.owner_name}`),e.last_activity_date){let n=Math.floor((new Date-new Date(e.last_activity_date))/864e5);t.push(`       - Last activity: ${n} days ago ${n>90?"(STALE - potential risk)":""}`)}return e.job_changed_recently&&t.push(`       - ⚠️ RECENT JOB CHANGE (${e.days_in_current_role||"unknown"} days in role - potential account risk)`),e.job_change_likelihood&&e.job_change_likelihood>50&&t.push(`       - ⚠️ High job change likelihood: ${e.job_change_likelihood}%`),e.company_industry&&t.push(`       - Company industry: ${e.company_industry}`),e.company_size&&t.push(`       - Company size: ${e.company_size} employees`),e.company_technologies&&e.company_technologies.length>0&&t.push(`       - Technologies: ${e.company_technologies.slice(0,5).join(", ")}`),e.previous_companies&&e.previous_companies.length>0&&t.push(`       - Previous companies: ${e.previous_companies.slice(0,3).join(", ")}`),"verified"===e.email_status&&t.push(`       - ✅ Verified email`),"invalid"===e.email_status&&t.push(`       - ❌ Invalid email`),t.join("\n")}).join("\n")}
   - Engagement signals: ${s.linkedin_data.contacts.reduce((e,t)=>e+(t.engagement_with_company?.posts_about_company||0)+(t.engagement_with_company?.comments_on_company_posts||0)+(t.engagement_with_company?.shares_of_company_content||0),0)} total interactions with company content
   - Risk indicators: ${s.linkedin_data.contacts.filter(e=>e.job_changed_recently||e.job_change_likelihood&&e.job_change_likelihood>50).length} contacts with job change signals
   - Stale relationships: ${s.linkedin_data.contacts.filter(e=>!!e.last_activity_date&&Math.floor((new Date-new Date(e.last_activity_date))/864e5)>90).length} contacts with no activity in 90+ days`:" (No contact enrichment data available)"}

6. **Overall Assessment**:
   - Customer relationship health (at-risk, stable, or thriving)
   - Key risk factors or positive indicators
   - Recommended actions or areas of concern

Provide TWO analyses:

1. **Executive Summary** (150 words max): A concise, high-level overview suitable for C-level executives. Focus on:
   - Overall sentiment score and key takeaway
   - Top 2-3 critical factors
   - Immediate action required (if any)
   - Relationship health status

2. **Comprehensive Analysis** (500-800 words): A detailed, in-depth analysis for CSMs and Account Managers. Include:
   - Detailed breakdown of all factors influencing the score
   - Specific concerns or positive signals with examples
   - Relationship trajectory analysis (improving, declining, stable) with evidence
   - Contact level involvement analysis (C-Level/Sr. Level in cases is a major red flag)
   - Support case patterns and implications
   - Engagement metrics and their meaning
   - Risk factors and opportunities
   - Detailed actionable recommendations
   - Account-specific context and nuances
   - Comparison to account tier expectations`}]}],systemInstruction:{parts:[{text:`You are an expert Customer Sentiment Analyst specializing in B2B customer relationship analysis. Your role is to provide comprehensive sentiment analysis by evaluating:

1. **Conversation Analysis**: Tone, language patterns, emotional indicators, frustration levels, satisfaction signals
2. **Support Context**: Recent support cases, their status, priority, and descriptions - these reveal underlying issues
3. **Account Health**: Account tier, contract value, industry context - higher value accounts may have different expectations
4. **Resolution Quality**: How effectively concerns were addressed, response time indicators, solution completeness
5. **Relationship Trajectory**: Whether sentiment is improving, declining, or stable over time

Consider the full customer journey from initial contact through resolution. Weight recent interactions more heavily but consider historical context. Account for account value and industry norms when assessing expectations.

Provide scores from 1 (very negative - at risk of churn) to 10 (very positive - strong advocate) with detailed, actionable summaries that explain the reasoning and highlight key factors influencing the sentiment.`}]},generationConfig:{responseMimeType:"application/json",responseSchema:{type:"object",properties:{score:{type:"integer",description:"Sentiment score from 1 to 10, where 1 is very negative and 10 is very positive."},summary:{type:"string",description:"Executive summary (150 words max) - concise, high-level overview for C-level executives. Focus on overall sentiment, top 2-3 critical factors, immediate actions, and relationship health status."},comprehensiveAnalysis:{type:"string",description:"Comprehensive analysis (500-800 words) - detailed, in-depth analysis for CSMs and Account Managers. Include detailed factor breakdown, specific concerns/positive signals with examples, relationship trajectory with evidence, contact level involvement analysis, support case patterns, engagement metrics, risk factors, opportunities, detailed recommendations, account-specific context, and comparison to account tier expectations."}},required:["score","summary","comprehensiveAnalysis"]},temperature:.7,topP:.8,topK:40}},y=async(e,t=3,n=1e3)=>{for(let a=0;a<t;a++)try{let s=await e();if(429===s.status){let e=n*Math.pow(2,a);if(a<t-1){await new Promise(t=>setTimeout(t,e));continue}}if(!s.ok){let e="";try{let t=await s.clone().json();e=t.error?JSON.stringify(t.error):""}catch(t){try{e=await s.clone().text()}catch(e){}}let t=e?`API error: ${s.status} ${s.statusText} - ${e}`:`API error: ${s.status} ${s.statusText}`;throw 403===s.status?(0,w.logError)("Gemini API 403 Forbidden - Possible causes:",{status:s.status,statusText:s.statusText,errorDetails:e,model:v,apiKeyPresent:!!r,apiKeyLength:r?r.length:0,apiKeyPrefix:r?r.substring(0,10)+"...":"missing"}):404===s.status&&(0,w.logError)("Gemini API 404 Not Found - Model not available:",{status:s.status,statusText:s.statusText,errorDetails:e,model:v,suggestion:"Try using gemini-pro, gemini-1.5-pro-latest, or gemini-flash-latest"}),Error(t)}return s}catch(s){if(a===t-1)throw s;let e=n*Math.pow(2,a);await new Promise(t=>setTimeout(t,e))}};async function o(e){try{let t=`https://generativelanguage.googleapis.com/${e}/models?key=${r}`;(0,w.log)(`Querying ListModels API for ${e} to discover available models...`);let n=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}});if(!n.ok)return(0,w.log)(`ListModels API returned ${n.status} ${n.statusText} for ${e}`),[];let a=(await n.json()).models||[];(0,w.log)(`ListModels API returned ${a.length} total models for ${e}`);let s=a.filter(e=>(e.supportedGenerationMethods||[]).includes("generateContent")).map(t=>({name:t.name.replace("models/",""),displayName:t.displayName,version:e}));return(0,w.log)(`Found ${s.length} models supporting generateContent in ${e}: ${s.map(e=>e.name).join(", ")}`),s}catch(t){return(0,w.logError)(`Error discovering models for ${e}:`,t),[]}}let _="false"!==process.env.SKIP_MODEL_DISCOVERY,f=[];if(_)f=[{model:"gemini-flash-latest",version:"v1beta"},{model:"gemini-1.5-pro-latest",version:"v1beta"},{model:"gemini-1.5-pro",version:"v1beta"},{model:v,version:"v1beta"},{model:"gemini-pro",version:"v1"}];else{let e=[];for(let t of["v1","v1beta"]){let n=await o(t);if(n.length>0){(0,w.log)(`Discovered ${n.length} available models in ${t} API`),e=n;break}}e.length>0?(f=e.sort((e,t)=>{let n=e.name.includes("flash"),a=t.name.includes("flash");if(n!==a)return a?1:-1;let s=e.name.includes("pro"),r=t.name.includes("pro");return s!==r?r?1:-1:e.name.length-t.name.length}).slice(0,5).map(e=>({model:e.name,version:e.version})),(0,w.log)(`Will try models in order: ${f.map(e=>`${e.model} (${e.version})`).join(", ")}`)):((0,w.log)("Could not discover models via API, using fallback list"),f=[{model:"gemini-flash-latest",version:"v1beta"},{model:"gemini-1.5-pro-latest",version:"v1beta"},{model:v,version:"v1beta"},{model:"gemini-1.5-pro",version:"v1beta"},{model:"gemini-pro",version:"v1"}])}let C=null,R=null,b=null;for(let{model:e,version:t}of(Date.now(),f)){b=`${e} (${t})`;let n=Date.now();try{let a=`https://generativelanguage.googleapis.com/${t}/models/${e}:generateContent?key=${r}`;(0,w.log)(`Attempting Gemini model: ${e} with API version: ${t} (attempt started at ${new Date().toISOString()})`);let s=g;if("v1"===t){let e=g.systemInstruction.parts[0].text;s={contents:[{parts:[{text:`${e}

${g.contents[0].parts[0].text}

IMPORTANT: You must respond with RAW JSON only (no markdown, no code blocks, no backticks). Start your response with { and end with }. Format your response EXACTLY as: {"score": <number 1-10>, "summary": "<text>", "comprehensiveAnalysis": "<text>"}`}]}],generationConfig:{temperature:.7,topP:.8,topK:40}}}let o=async()=>{let t=new Promise((t,n)=>{setTimeout(()=>n(Error(`Request timeout for model ${e}`)),45e3)}),n=fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});return Promise.race([n,t])};if((C=await y(o))&&404!==C.status){let a=Date.now()-n;(0,w.log)(`Using Gemini model: ${e} (${t}) - ${a}ms`),b=`${e} (${t})`;break}if(C&&(404===C.status||400===C.status))continue}catch(e){if(R=e,e.message&&(e.message.includes("404")||e.message.includes("400")))continue;throw e}}if(!C){let e=R?.message||"All Gemini models failed.";throw Error(`${e}

Unable to find a working Gemini model. Please check:
1. Your GEMINI_API_KEY is valid and has access to Gemini models
2. The API key has the necessary permissions
3. Your Google Cloud project has the Generative Language API enabled
4. Try setting GEMINI_MODEL environment variable to a specific model name

To see available models, call: https://generativelanguage.googleapis.com/v1beta/models?key=YOUR_API_KEY

Last attempted models: ${f.map(e=>`${e.model} (${e.version})`).join(", ")}`)}if(!C.ok){let e="";try{let t=await C.json();e=t.error?JSON.stringify(t.error):JSON.stringify(t)}catch(t){try{e=await C.text()}catch(t){e=`Status: ${C.status} ${C.statusText}`}}if((0,w.logError)("Gemini API request failed:",{status:C.status,statusText:C.statusText,errorDetails:e,model:b||v}),403===C.status)return(0,w.sendErrorResponse)(Error(`Gemini API access forbidden (403). Please check:
1. Your GEMINI_API_KEY is valid and has access to Gemini models
2. The API key has the necessary permissions
3. Your Google Cloud project has the Generative Language API enabled
4. The API key is not restricted to specific APIs

Error details: ${e}`),403);if(404===C.status)return(0,w.sendErrorResponse)(Error(`Gemini API model not found (404). The model '${v}' is not available.
        
Please try one of these models by setting GEMINI_MODEL environment variable:
- gemini-pro (most stable, recommended)
- gemini-1.5-pro-latest
- gemini-flash-latest

To see available models, visit: https://ai.google.dev/api/rest?version=v1beta#rest/rest/v1beta/models/list

Error details: ${e}`),404);return(0,w.sendErrorResponse)(Error(`Gemini API error: ${C.status} ${C.statusText} - ${e}`),C.status)}let $=await C.json();if($.error)return(0,w.logError)("Gemini API error:",$.error),(0,w.sendErrorResponse)(Error(`Gemini API error: ${$.error.message||"Unknown error"}`),500);if(!$.candidates||!$.candidates[0]||!$.candidates[0].content)return(0,w.sendErrorResponse)(Error("Invalid response format from Gemini API"),500);let A=$.candidates[0].content.parts[0].text,I=A.trim(),S=(I=(I=(I=I.replace(/^```(?:json)?\s*\n?/i,"")).replace(/\n?```\s*$/i,"")).trim()).match(/\{[\s\S]*\}/);S&&(I=S[0]);try{n=JSON.parse(I)}catch(e){throw(0,w.logError)("Failed to parse Gemini response as JSON:",{originalContent:A.substring(0,500),cleanedContent:I.substring(0,500),parseError:e.message}),Error(`Failed to parse Gemini response as JSON: ${e.message}. Response may not be in expected format.`)}if(n.score<1||n.score>10)return(0,w.sendErrorResponse)(Error("Invalid sentiment score returned from API"),500);if(n.comprehensiveAnalysis||(n.comprehensiveAnalysis=n.summary||"Comprehensive analysis not available."),l||c)try{let e=(0,E.getSupabaseClient)();if(e){let t=l;if(!(l&&l.includes("-")&&36===l.length)){let n=l||c;if(n){let{data:a,error:s}=await e.from("accounts").select("id").eq("salesforce_id",n).single();s?((0,w.logError)("Error looking up account for sentiment save:",s),t=l&&36===l.length?l:null):a&&(t=a.id)}}if(t){let r={account_id:t,salesforce_account_id:c||null,user_id:i||null,score:n.score,summary:n.summary,comprehensive_analysis:n.comprehensiveAnalysis||null,has_transcription:!!a&&a.length>0,transcription_length:a?.length||0,cases_count:s.total_cases_count||0,avoma_calls_total:s.total_avoma_calls||0,avoma_calls_ready:s.ready_avoma_calls||0,customer_identifier:d||null,input_hash:h,analyzed_at:new Date().toISOString()};(0,w.log)("Saving sentiment to history:",{account_id:t,salesforce_account_id:c,customer_identifier:d,score:n.score,input_hash:h?h.substring(0,16)+"...":null,analyzed_at:r.analyzed_at});let{data:o,error:l}=await e.from("sentiment_history").insert(r).select().single();l?(0,w.logError)("Error saving sentiment to history:",l):o&&o.id&&(n.sentimentId=o.id)}else(0,w.logError)("Could not resolve account_id for sentiment save")}}catch(e){(0,w.logError)("Error saving sentiment to history:",e)}return(0,w.sendSuccessResponse)(n)}catch(e){if((0,w.logError)("Error in analyze-sentiment function:",e),e.message&&e.message.includes("Request timeout"))return(0,w.sendErrorResponse)(Error("Request timeout - The Gemini API request took too long. Please try again."),504);return(0,w.sendErrorResponse)(e,500)}}e.s(["OPTIONS",()=>$,"POST",()=>A],57706);var I=e.i(57706);let S=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/analyze-sentiment/route",pathname:"/api/analyze-sentiment",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/analyze-sentiment/route.js",nextConfigOutput:"",userland:I}),{workAsyncStorage:k,workUnitAsyncStorage:T,serverHooks:x}=S;function P(){return(0,a.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:T})}async function N(e,t,a){S.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/analyze-sentiment/route";f=f.replace(/\/index$/,"")||"/";let E=await S.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!E)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:w,params:C,nextConfig:R,parsedUrl:b,isDraftMode:$,prerenderManifest:A,routerServerContext:I,isOnDemandRevalidate:k,revalidateOnlyGenerated:T,resolvedPathname:x,clientReferenceManifest:P,serverActionsManifest:N}=E,O=(0,l.normalizeAppPath)(f),L=!!(A.dynamicRoutes[O]||A.routes[x]),M=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,b,!1):t.end("This page could not be found"),null);if(L&&!$){let e=!!A.routes[x],t=A.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await M();throw new y.NoFallbackError}}let D=null;!L||S.isDev||$||(D="/index"===(D=x)?"/":D);let j=!0===S.isDev||!L,G=L&&!j;N&&P&&(0,o.setReferenceManifestsSingleton)({page:f,clientReferenceManifest:P,serverActionsManifest:N,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:N})});let q=e.method||"GET",U=(0,r.getTracer)(),z=U.getActiveScopeSpan(),F={params:C,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,a)=>S.onRequestError(e,t,a,I)},sharedContext:{buildId:w}},H=new c.NodeNextRequest(e),K=new c.NodeNextResponse(t),Y=d.NextRequestAdapter.fromNodeNextRequest(H,(0,d.signalFromNodeResponse)(t));try{let o=async e=>S.handle(Y,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=U.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=n.get("next.route");if(a){let t=`${q} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${f}`)}),i=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var r,l;let c=async({previousCacheEntry:n})=>{try{if(!i&&k&&T&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await o(s);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=F.renderOpts.collectedTags;if(!L)return await (0,p.sendResponse)(H,K,r,F.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(r.headers);c&&(t[g.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,a=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:_.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:a}}}}catch(t){throw(null==n?void 0:n.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:G,isOnDemandRevalidate:k})},I),t}},d=await S.handleResponse({req:e,nextConfig:R,cacheKey:D,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:k,revalidateOnlyGenerated:T,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:i});if(!L)return null;if((null==d||null==(r=d.value)?void 0:r.kind)!==_.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",k?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),$&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return i&&L||u.delete(g.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,v.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(H,K,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};z?await l(z):await U.withPropagatedContext(e.headers,()=>U.trace(u.BaseServerSpan.handleRequest,{spanName:`${q} ${f}`,kind:r.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},l))}catch(t){if(t instanceof y.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:G,isOnDemandRevalidate:k})}),L)throw t;return await (0,p.sendResponse)(H,K,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>P,"routeModule",()=>S,"serverHooks",()=>x,"workAsyncStorage",()=>k,"workUnitAsyncStorage",()=>T],74492)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_0d80c462.js.map