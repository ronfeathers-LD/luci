module.exports=[46512,(e,t,n)=>{t.exports={normalizeLinkedInURL:function(e){return e&&"string"==typeof e?(e=e.trim()).startsWith("http://")||e.startsWith("https://")||e.startsWith("urn:li:")?e:(e.startsWith("/")&&(e=e.substring(1)),e.startsWith("in/"))?`https://www.linkedin.com/${e}`:e.includes("/")||e.includes("linkedin.com")?e.includes("linkedin.com")&&!e.startsWith("http")||e.startsWith("www.linkedin.com")?`https://${e}`:null:`https://www.linkedin.com/in/${e}`:null}}},21177,e=>{"use strict";var t=e.i(47909),n=e.i(74017),a=e.i(96250),r=e.i(59756),o=e.i(61916),l=e.i(14444),i=e.i(37092),s=e.i(69741),c=e.i(16795),u=e.i(87718),d=e.i(95169),p=e.i(47587),m=e.i(66012),_=e.i(70101),h=e.i(26937),f=e.i(10372),g=e.i(93695);e.i(52474);var R=e.i(220),w=e.i(89171),E=e.i(69122),y=e.i(3030);let{normalizeLinkedInURL:S}=e.r(46512),{authenticateSalesforce:A,escapeSOQL:N}=e.r(77182),{isCacheFresh:C}=e.r(30273),{MAX_REQUEST_SIZE:v,CACHE_TTL:O,API_LIMITS:I}=e.r(982);async function P(e,t){let n=t.replace(/'/g,"\\'"),a=`SELECT Id, FirstName, LastName, Name, Email, Title, Phone, MobilePhone, 
                Contact_Status__c, AccountId, Account.Name,
                Person_LinkedIn__c,
                Department, ReportsToId, ReportsTo.Name, OwnerId, Owner.Name,
                DoNotCall, HasOptedOutOfEmail,
                MailingStreet, MailingCity, MailingState, MailingPostalCode, MailingCountry,
                LastActivityDate, CreatedDate, LastModifiedDate,
                LeadSource,
                Birthdate, AssistantName, AssistantPhone, Description,
                Account.Industry, Account.AnnualRevenue, Account.NumberOfEmployees, 
                Account.Type, Account.OwnerId, Account.Owner.Name
                FROM Contact 
                WHERE AccountId = '${n}' 
                AND (Contact_Status__c != 'Unqualified' OR Contact_Status__c = null)
                ORDER BY LastName, FirstName 
                LIMIT ${I.CONTACTS_PER_ACCOUNT}`,r=await e.query(a),o=r.records?.length||0,l=(r.records||[]).filter(e=>"Unqualified"!==(e.Contact_Status__c||null));return l.length>0&&(0,y.log)(`Retrieved ${l.length} contacts from Salesforce`),0===l.length&&o>0&&(0,y.logWarn)(`All ${o} contacts for account ${t} were filtered out (likely all have Contact_Status__c = 'Unqualified')`),l}async function T(e,t){if(!e||!t)return null;let{data:n,error:a}=await e.from("contacts").select("*").eq("salesforce_account_id",t).order("last_name",{ascending:!0}).order("first_name",{ascending:!0}).limit(100);if(a||!n||0===n.length)return null;let r=n.reduce((e,t)=>new Date(t.last_synced_at?t.last_synced_at:0)>new Date(e||0)?t.last_synced_at:e,null);return{contacts:n,isFresh:C(r,O.CONTACTS),lastSyncedAt:r}}async function b(e,t,n,a){if(!e||!t||0===t.length)return[];let r=[];for(let o of t){let t=o.Contact_Status__c||null;if("Unqualified"===t)continue;let l=o.Person_LinkedIn__c||null,i=l?S(l):null,s={salesforce_id:o.Id,salesforce_account_id:n,account_id:a||null,first_name:o.FirstName||null,last_name:o.LastName||null,name:o.Name||null,email:o.Email||null,title:o.Title||null,phone:o.Phone||null,mobile_phone:o.MobilePhone||null,contact_status:t,account_name:o.Account?.Name||null,linkedin_url:i,department:o.Department||null,reports_to_id:o.ReportsToId||null,reports_to_name:o.ReportsTo?.Name||null,owner_id:o.OwnerId||null,owner_name:o.Owner?.Name||null,do_not_call:o.DoNotCall||!1,email_opt_out:o.HasOptedOutOfEmail||!1,mailing_street:o.MailingStreet||null,mailing_city:o.MailingCity||null,mailing_state:o.MailingState||null,mailing_postal_code:o.MailingPostalCode||null,mailing_country:o.MailingCountry||null,last_activity_date:o.LastActivityDate?new Date(o.LastActivityDate).toISOString():null,created_date:o.CreatedDate?new Date(o.CreatedDate).toISOString():null,last_modified_date:o.LastModifiedDate?new Date(o.LastModifiedDate).toISOString():null,lead_source:o.LeadSource||null,birthdate:o.Birthdate||null,assistant_name:o.AssistantName||null,assistant_phone:o.AssistantPhone||null,description:o.Description||null,account_industry:o.Account?.Industry||null,account_annual_revenue:o.Account?.AnnualRevenue||null,account_number_of_employees:o.Account?.NumberOfEmployees||null,account_type:o.Account?.Type||null,account_owner_id:o.Account?.OwnerId||null,account_owner_name:o.Account?.Owner?.Name||null,last_synced_at:new Date().toISOString()},{data:c,error:u}=await e.from("contacts").upsert(s,{onConflict:"salesforce_id",ignoreDuplicates:!1}).select().single();if(u&&"PGRST204"===u.code){(0,y.logWarn)(`Missing column detected for contact ${o.Id}, retrying with core fields only:`,u.message);let r={salesforce_id:o.Id,salesforce_account_id:n,account_id:a||null,first_name:o.FirstName||null,last_name:o.LastName||null,name:o.Name||null,email:o.Email||null,title:o.Title||null,phone:o.Phone||null,mobile_phone:o.MobilePhone||null,contact_status:t,account_name:o.Account?.Name||null,last_synced_at:new Date().toISOString()},l=await e.from("contacts").upsert(r,{onConflict:"salesforce_id",ignoreDuplicates:!1}).select().single();c=l.data,u=l.error}if(u){(0,y.logError)(`Error syncing contact ${o.Id}:`,u);continue}r.push(c)}return r}async function D(){return(0,y.handlePreflight)(new w.NextRequest("http://localhost",{method:"OPTIONS"}))}async function M(e){let t=await (0,y.handlePreflight)(e);if(t)return t;let n=(0,y.validateRequestSize)(e,v.DEFAULT);if(!n.valid)return(0,y.sendErrorResponse)(Error(n.error.message),n.error.status);let{searchParams:a}=new URL(e.url),r=a.get("salesforceAccountId"),o=a.get("accountId"),l=a.get("forceRefresh");if(!r)return(0,y.sendErrorResponse)(Error("Missing required parameter: salesforceAccountId"),400);try{let e=(0,E.getSupabaseClient)(),t=(0,y.validateSupabase)(e);if(!t.valid)return(0,y.sendErrorResponse)(Error(t.error.message),t.error.status);if("true"!==l&&"1"!==l){let t=await T(e,r);if(t&&t.isFresh)return(0,y.log)(`Returning ${t.contacts.length} cached contacts`),(0,y.sendSuccessResponse)({contacts:t.contacts.map(e=>({id:e.salesforce_id,firstName:e.first_name,lastName:e.last_name,name:e.name,email:e.email,title:e.title,phone:e.phone,mobilePhone:e.mobile_phone,contactStatus:e.contact_status,accountId:e.salesforce_account_id,accountName:e.account_name,linkedinURL:e.linkedin_url})),total:t.contacts.length,cached:!0,lastSyncedAt:t.lastSyncedAt})}try{let t=await A(e),n=await P(t.connection,r),a=null;if(o&&o.includes("-")&&36===o.length){let{data:t,error:n}=await e.from("accounts").select("id").eq("id",o).single();n?"PGRST116"!==n.code&&(0,y.logError)("Error looking up account by UUID:",n):t&&(a=t.id)}if(!a){let{data:t,error:n}=await e.from("accounts").select("id").eq("salesforce_id",r).single();n?"PGRST116"!==n.code&&(0,y.logError)("Error looking up account by salesforce_id:",n):t&&(a=t.id)}let l=(await b(e,n,r,a)).map(e=>({id:e.salesforce_id,firstName:e.first_name,lastName:e.last_name,name:e.name,email:e.email,title:e.title,phone:e.phone,mobilePhone:e.mobile_phone,contactStatus:e.contact_status,accountId:e.salesforce_account_id,accountName:e.account_name,linkedinURL:e.linkedin_url}));return(0,y.sendSuccessResponse)({contacts:l,total:l.length,cached:!1,lastSyncedAt:new Date().toISOString()})}catch(n){(0,y.logError)("Salesforce contacts query error:",n);let t=await T(e,r);if(t&&t.contacts.length>0)return(0,y.log)(`Salesforce query failed, using ${t.contacts.length} stale cached contacts`),(0,y.sendSuccessResponse)({contacts:t.contacts.map(e=>({id:e.salesforce_id,firstName:e.first_name,lastName:e.last_name,name:e.name,email:e.email,title:e.title,phone:e.phone,mobilePhone:e.mobile_phone,contactStatus:e.contact_status,accountId:e.salesforce_account_id,accountName:e.account_name,linkedinURL:e.linkedin_url})),total:t.contacts.length,cached:!0,stale:!0,lastSyncedAt:t.lastSyncedAt});return(0,y.logWarn)("No cached contacts available and Salesforce query failed, returning empty array"),(0,y.sendSuccessResponse)({contacts:[],total:0,cached:!1,error:(0,y.isProduction)()?void 0:n.message})}}catch(e){return(0,y.logError)("Error in salesforce-contacts function:",e),(0,y.logError)("Error details:",e.message),e.stack&&(0,y.logError)("Error stack:",e.stack),(0,y.sendErrorResponse)(e,500)}}e.s(["GET",()=>M,"OPTIONS",()=>D],62790);var k=e.i(62790);let x=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/salesforce-contacts/route",pathname:"/api/salesforce-contacts",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/salesforce-contacts/route.js",nextConfigOutput:"",userland:k}),{workAsyncStorage:U,workUnitAsyncStorage:q,serverHooks:L}=x;function $(){return(0,a.patchFetch)({workAsyncStorage:U,workUnitAsyncStorage:q})}async function H(e,t,a){x.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/salesforce-contacts/route";w=w.replace(/\/index$/,"")||"/";let E=await x.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!E)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:y,params:S,nextConfig:A,parsedUrl:N,isDraftMode:C,prerenderManifest:v,routerServerContext:O,isOnDemandRevalidate:I,revalidateOnlyGenerated:P,resolvedPathname:T,clientReferenceManifest:b,serverActionsManifest:D}=E,M=(0,s.normalizeAppPath)(w),k=!!(v.dynamicRoutes[M]||v.routes[T]),U=async()=>((null==O?void 0:O.render404)?await O.render404(e,t,N,!1):t.end("This page could not be found"),null);if(k&&!C){let e=!!v.routes[T],t=v.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await U();throw new g.NoFallbackError}}let q=null;!k||x.isDev||C||(q="/index"===(q=T)?"/":q);let L=!0===x.isDev||!k,$=k&&!L;D&&b&&(0,l.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:b,serverActionsManifest:D,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:D})});let H=e.method||"GET",F=(0,o.getTracer)(),W=F.getActiveScopeSpan(),j={params:S,prerenderManifest:v,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,a)=>x.onRequestError(e,t,a,O)},sharedContext:{buildId:y}},B=new c.NodeNextRequest(e),K=new c.NodeNextResponse(t),G=u.NextRequestAdapter.fromNodeNextRequest(B,(0,u.signalFromNodeResponse)(t));try{let l=async e=>x.handle(G,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=F.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=n.get("next.route");if(a){let t=`${H} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${w}`)}),i=!!(0,r.getRequestMeta)(e,"minimalMode"),s=async r=>{var o,s;let c=async({previousCacheEntry:n})=>{try{if(!i&&I&&P&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await l(r);e.fetchMetrics=j.renderOpts.fetchMetrics;let s=j.renderOpts.pendingWaitUntil;s&&a.waitUntil&&(a.waitUntil(s),s=void 0);let c=j.renderOpts.collectedTags;if(!k)return await (0,m.sendResponse)(B,K,o,j.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(o.headers);c&&(t[f.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,a=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:a}}}}catch(t){throw(null==n?void 0:n.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:I})},O),t}},u=await x.handleResponse({req:e,nextConfig:A,cacheKey:q,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:v,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:P,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:i});if(!k)return null;if((null==u||null==(o=u.value)?void 0:o.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(s=u.value)?void 0:s.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",I?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,_.fromNodeOutgoingHttpHeaders)(u.value.headers);return i&&k||d.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,h.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(B,K,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};W?await s(W):await F.withPropagatedContext(e.headers,()=>F.trace(d.BaseServerSpan.handleRequest,{spanName:`${H} ${w}`,kind:o.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},s))}catch(t){if(t instanceof g.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:I})}),k)throw t;return await (0,m.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>H,"patchFetch",()=>$,"routeModule",()=>x,"serverHooks",()=>L,"workAsyncStorage",()=>U,"workUnitAsyncStorage",()=>q],21177)}];

//# sourceMappingURL=_30ed2796._.js.map