{"version":3,"sources":["../../../lib/constants.js","../../../lib/api-helpers.js","../../../src/lib/next-api-helpers.js","../../../lib/cache-helpers.js"],"sourcesContent":["/**\n * Shared Constants\n * \n * Centralized constants used across the application\n */\n\n// Request limits\nconst MAX_REQUEST_SIZE = {\n  DEFAULT: 1024 * 1024, // 1MB\n  LARGE: 10 * 1024 * 1024, // 10MB (for sentiment analysis)\n};\n\n// Timeouts\nconst REQUEST_TIMEOUT = 30000; // 30 seconds\n\n// Rate limiting\nconst RATE_LIMIT = {\n  WINDOW: 60 * 1000, // 1 minute\n  MAX_REQUESTS: 10, // 10 requests per minute per IP\n};\n\n// Cache TTL (in hours, except CALENDAR_EVENTS which is in minutes)\nconst CACHE_TTL = {\n  ACCOUNTS: 1, // 1 hour\n  CASES: 1, // 1 hour\n  CONTACTS: 24, // 24 hours\n  TRANSCRIPTIONS: 24, // 24 hours\n  LINKEDIN_PROFILES: 24, // 24 hours\n  CALENDAR_EVENTS: 15, // 15 minutes (calendar events change frequently)\n};\n\n// API Limits\nconst API_LIMITS = {\n  CASES_PER_ACCOUNT: 25,\n  CONTACTS_PER_ACCOUNT: 100,\n  ACCOUNTS_PER_USER: 1000,\n};\n\nmodule.exports = {\n  MAX_REQUEST_SIZE,\n  REQUEST_TIMEOUT,\n  RATE_LIMIT,\n  CACHE_TTL,\n  API_LIMITS,\n};\n\n","/**\n * Shared API Helper Functions\n * \n * Common utilities for Vercel serverless functions\n */\n\nconst { MAX_REQUEST_SIZE, REQUEST_TIMEOUT } = require('./constants');\n\n/**\n * Set standard CORS headers\n */\nfunction setCORSHeaders(res, methods = ['GET', 'POST', 'OPTIONS']) {\n  res.setHeader('Access-Control-Allow-Origin', '*');\n  res.setHeader('Access-Control-Allow-Methods', methods.join(', '));\n  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');\n}\n\n/**\n * Handle preflight OPTIONS requests\n */\nfunction handlePreflight(req, res) {\n  if (req.method === 'OPTIONS') {\n    setCORSHeaders(res);\n    return res.status(200).end();\n  }\n  return false;\n}\n\n/**\n * Validate request size\n */\nfunction validateRequestSize(req, maxSize = MAX_REQUEST_SIZE.DEFAULT) {\n  const contentLength = req.headers['content-length'];\n  if (contentLength && parseInt(contentLength) > maxSize) {\n    return {\n      valid: false,\n      error: {\n        status: 413,\n        message: 'Request too large',\n      },\n    };\n  }\n  return { valid: true };\n}\n\n/**\n * Sanitize error message for production\n */\nfunction sanitizeError(error, isProduction = false) {\n  if (isProduction) {\n    // In production, don't expose internal error details\n    return {\n      error: 'An error occurred',\n      message: 'Please try again later or contact support if the problem persists.',\n    };\n  }\n  \n  // In development, return full error details\n  return {\n    error: error.message || 'An error occurred',\n    message: error.message,\n    stack: error.stack,\n  };\n}\n\n/**\n * Standard error response\n */\nfunction sendErrorResponse(res, error, statusCode = 500, isProduction = false) {\n  setCORSHeaders(res);\n  const sanitized = sanitizeError(error, isProduction);\n  return res.status(statusCode).json(sanitized);\n}\n\n/**\n * Standard success response\n */\nfunction sendSuccessResponse(res, data, statusCode = 200) {\n  setCORSHeaders(res);\n  return res.status(statusCode).json(data);\n}\n\n/**\n * Get client IP address from request\n */\nfunction getClientIP(req) {\n  return req.headers['x-forwarded-for']?.split(',')[0] || \n         req.headers['x-real-ip'] || \n         req.connection?.remoteAddress || \n         'unknown';\n}\n\n/**\n * Validate Supabase client and return error response if invalid\n * \n * @param {Object|null} supabase - Supabase client instance\n * @param {Object} res - Express response object\n * @returns {boolean} True if valid, false if invalid (response already sent)\n */\nfunction validateSupabase(supabase, res) {\n  if (!supabase) {\n    sendErrorResponse(res, new Error('Database not configured'), 503, isProduction());\n    return false;\n  }\n  return true;\n}\n\n/**\n * Check if environment is production\n */\nfunction isProduction() {\n  return process.env.NODE_ENV === 'production';\n}\n\n/**\n * Structured logging with levels\n */\nfunction formatLog(level, message) {\n  const timestamp = new Date().toISOString();\n  return `[${timestamp}] [${level.toUpperCase()}] ${message}`;\n}\n\n/**\n * Info log (only in non-production)\n */\nfunction log(message, data = null) {\n  if (!isProduction()) {\n    if (data) {\n      console.log(formatLog('info', message), data);\n    } else {\n      console.log(formatLog('info', message));\n    }\n  }\n}\n\n/**\n * Error log (always logs, even in production)\n */\nfunction logError(message, error = null) {\n  if (error) {\n    console.error(formatLog('error', message), error);\n  } else {\n    console.error(formatLog('error', message));\n  }\n}\n\n/**\n * Warning log (only in non-production)\n */\nfunction logWarn(message, data = null) {\n  if (!isProduction()) {\n    if (data) {\n      console.warn(formatLog('warn', message), data);\n    } else {\n      console.warn(formatLog('warn', message));\n    }\n  }\n}\n\n/**\n * Debug log (only in non-production, for verbose debugging)\n */\nfunction logDebug(message, data = null) {\n  if (!isProduction() && process.env.DEBUG === 'true') {\n    if (data) {\n      console.log(formatLog('debug', message), data);\n    } else {\n      console.log(formatLog('debug', message));\n    }\n  }\n}\n\n/**\n * Simple in-memory rate limiter\n * For production, use Redis or similar distributed store\n */\nconst rateLimitStore = new Map();\n\nfunction checkRateLimit(ip, windowMs, maxRequests) {\n  const now = Date.now();\n  const key = ip;\n  \n  if (!rateLimitStore.has(key)) {\n    rateLimitStore.set(key, { count: 1, resetTime: now + windowMs });\n    return true;\n  }\n  \n  const record = rateLimitStore.get(key);\n  \n  // Reset if window expired\n  if (now > record.resetTime) {\n    record.count = 1;\n    record.resetTime = now + windowMs;\n    return true;\n  }\n  \n  // Check if limit exceeded\n  if (record.count >= maxRequests) {\n    return false;\n  }\n  \n  record.count++;\n  return true;\n}\n\n// Clean up old entries periodically\nconst { RATE_LIMIT } = require('./constants');\nsetInterval(() => {\n  const now = Date.now();\n  for (const [key, record] of rateLimitStore.entries()) {\n    if (now > record.resetTime) {\n      rateLimitStore.delete(key);\n    }\n  }\n}, RATE_LIMIT.WINDOW);\n\nmodule.exports = {\n  setCORSHeaders,\n  handlePreflight,\n  validateRequestSize,\n  sanitizeError,\n  sendErrorResponse,\n  sendSuccessResponse,\n  getClientIP,\n  validateSupabase,\n  checkRateLimit,\n  isProduction,\n  log,\n  logError,\n  logWarn,\n  logDebug,\n};\n\n","/**\n * Next.js API Route Helper Functions\n * \n * Adapters for existing lib/api-helpers.js to work with Next.js\n * Can use require() for existing helpers\n */\n\nimport { NextResponse } from 'next/server';\n\n// Import existing helpers (they work in Next.js via require)\n// From src/lib/next-api-helpers.js -> up to src/ -> up to root/ -> lib/\nconst apiHelpers = require('../../lib/api-helpers');\nconst { MAX_REQUEST_SIZE, REQUEST_TIMEOUT, RATE_LIMIT } = require('../../lib/constants');\n\n/**\n * Set CORS headers for Next.js Response\n */\nexport function setCORSHeaders(response, methods = ['GET', 'POST', 'OPTIONS']) {\n  response.headers.set('Access-Control-Allow-Origin', '*');\n  response.headers.set('Access-Control-Allow-Methods', methods.join(', '));\n  response.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');\n  return response;\n}\n\n/**\n * Handle preflight OPTIONS requests for Next.js\n */\nexport async function handlePreflight(request) {\n  if (request.method === 'OPTIONS') {\n    const response = new NextResponse(null, { status: 200 });\n    return setCORSHeaders(response);\n  }\n  return null;\n}\n\n/**\n * Validate request size for Next.js\n */\nexport function validateRequestSize(request, maxSize = MAX_REQUEST_SIZE.DEFAULT) {\n  const contentLength = request.headers.get('content-length');\n  if (contentLength && parseInt(contentLength) > maxSize) {\n    return {\n      valid: false,\n      error: {\n        status: 413,\n        message: 'Request too large',\n      },\n    };\n  }\n  return { valid: true };\n}\n\n/**\n * Send error response for Next.js\n */\nexport function sendErrorResponse(error, statusCode = 500) {\n  const isProd = apiHelpers.isProduction();\n  const sanitized = {\n    error: isProd ? 'An error occurred' : (error?.message || 'An error occurred'),\n    message: isProd ? 'Please try again later or contact support if the problem persists.' : (error?.message || 'An error occurred'),\n  };\n  \n  if (!isProd && error?.stack) {\n    sanitized.stack = error.stack;\n  }\n  \n  const response = NextResponse.json(sanitized, { status: statusCode });\n  return setCORSHeaders(response);\n}\n\n/**\n * Send success response for Next.js\n */\nexport function sendSuccessResponse(data, statusCode = 200) {\n  const response = NextResponse.json(data, { status: statusCode });\n  return setCORSHeaders(response);\n}\n\n/**\n * Get client IP from Next.js Request\n */\nexport function getClientIP(request) {\n  const forwarded = request.headers.get('x-forwarded-for');\n  if (forwarded) {\n    return forwarded.split(',')[0].trim();\n  }\n  return request.headers.get('x-real-ip') || 'unknown';\n}\n\n/**\n * Validate Supabase client for Next.js\n */\nexport function validateSupabase(supabase) {\n  if (!supabase) {\n    return {\n      valid: false,\n      error: { status: 503, message: 'Database not configured' }\n    };\n  }\n  return { valid: true };\n}\n\n/**\n * Check rate limit\n */\nexport function checkRateLimit(ip, windowMs, maxRequests) {\n  return apiHelpers.checkRateLimit(ip, windowMs, maxRequests);\n}\n\n// Re-export other helpers\nexport const log = apiHelpers.log;\nexport const logError = apiHelpers.logError;\nexport const logWarn = apiHelpers.logWarn;\nexport const logDebug = apiHelpers.logDebug;\nexport const isProduction = apiHelpers.isProduction;\n\n","/**\n * Shared Cache Helper Functions\n * \n * Common utilities for cache management\n */\n\nconst { CACHE_TTL } = require('./constants');\n\n/**\n * Check if cached data is fresh based on TTL\n * \n * @param {string|Date} lastSyncedAt - Last sync timestamp\n * @param {number} ttlHours - Time to live in hours (or string key from CACHE_TTL)\n * @returns {boolean} True if cache is fresh\n */\nfunction isCacheFresh(lastSyncedAt, ttlHours) {\n  if (!lastSyncedAt) return false;\n  \n  // If ttlHours is a string, look it up in CACHE_TTL\n  const ttl = typeof ttlHours === 'string' ? (CACHE_TTL[ttlHours] || CACHE_TTL.ACCOUNTS) : ttlHours;\n  \n  const now = new Date();\n  const cacheExpiry = ttl * 60 * 60 * 1000;\n  const lastSynced = new Date(lastSyncedAt);\n  \n  if (isNaN(lastSynced.getTime())) return false;\n  \n  return (now - lastSynced) < cacheExpiry;\n}\n\n/**\n * Check if cache is fresh for a given resource type\n * \n * @param {string|Date} lastSyncedAt - Last sync timestamp\n * @param {string} resourceType - Type of resource (ACCOUNTS, CASES, CONTACTS, etc.)\n * @returns {boolean} True if cache is fresh\n */\nfunction isResourceCacheFresh(lastSyncedAt, resourceType) {\n  return isCacheFresh(lastSyncedAt, resourceType);\n}\n\n/**\n * Get cache TTL in milliseconds for a resource type\n * \n * @param {string} resourceType - Type of resource\n * @returns {number} TTL in milliseconds\n */\nfunction getCacheTTLMs(resourceType) {\n  const ttlHours = CACHE_TTL[resourceType] || CACHE_TTL.ACCOUNTS;\n  return ttlHours * 60 * 60 * 1000;\n}\n\n/**\n * Calculate cache age in milliseconds\n * \n * @param {string|Date} lastSyncedAt - Last sync timestamp\n * @returns {number} Age in milliseconds, or null if invalid\n */\nfunction getCacheAge(lastSyncedAt) {\n  if (!lastSyncedAt) return null;\n  \n  const now = new Date();\n  const lastSynced = new Date(lastSyncedAt);\n  \n  if (isNaN(lastSynced.getTime())) return null;\n  \n  return now - lastSynced;\n}\n\nmodule.exports = {\n  isCacheFresh,\n  isResourceCacheFresh,\n  getCacheTTLMs,\n  getCacheAge,\n  CACHE_TTL,\n};\n\n"],"names":[],"mappings":"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"}