module.exports=[56457,e=>{"use strict";var t=e.i(47909),r=e.i(74017),n=e.i(96250),i=e.i(59756),a=e.i(61916),s=e.i(14444),o=e.i(37092),u=e.i(69741),c=e.i(16795),l=e.i(87718),d=e.i(95169),p=e.i(47587),g=e.i(66012),m=e.i(70101),f=e.i(26937),_=e.i(10372),h=e.i(93695);e.i(52474);var R=e.i(220),y=e.i(89171),w=e.i(69122),E=e.i(3030);let{AvomaClient:v}=e.r(34021),{MAX_REQUEST_SIZE:C,CACHE_TTL:S}=e.r(982),{isCacheFresh:b}=e.r(30273);async function M(e){let{data:t,error:r}=await e.from("avoma_configs").select("*").eq("is_active",!0).single();if(r||!t)throw Error("Avoma configuration not found. Please configure Avoma API credentials.");return t}async function A(e,t,r){if(!e)return null;let n=e.from("transcriptions").select("*").order("meeting_date",{ascending:!1}).limit(1);if(r)n=n.eq("salesforce_account_id",r);else{if(!t)return null;n=n.ilike("customer_identifier",`%${t}%`)}let{data:i,error:a}=await n;if(a||!i||0===i.length)return null;let s=i[0];return{transcription:s,isFresh:b(s.last_synced_at,S.TRANSCRIPTIONS)}}async function I(e,t,r=null){let n=await e.searchMeetings(t,20,r),i=n.results||n.calls||[],a=i.filter(e=>e.transcript_ready&&e.transcription_uuid);return 0===a.length?{meeting:null,totalMeetings:i.length,readyMeetings:0}:{meeting:a.sort((e,t)=>{let r=new Date(e.start_at||e.meeting_date||0);return new Date(t.start_at||t.meeting_date||0)-r})[0],totalMeetings:i.length,readyMeetings:a.length}}async function x(e,t){let r,n=await e.getMeeting(t);if(!n.transcript_ready)throw Error("Transcript is not ready for this meeting");let i=n.transcription_uuid||t;try{r=await e.getMeetingTranscriptText(i)}catch(n){if(i!==t)(0,E.logWarn)(`Failed to get transcript with transcription_uuid ${i}, trying meeting UUID ${t}`),r=await e.getMeetingTranscriptText(t);else throw n}return{transcription:r.text,speakers:r.speakers,meeting:{uuid:t,transcription_uuid:n.transcription_uuid||t,subject:n.subject,start_at:n.start_at,meeting_date:n.start_at?new Date(n.start_at):null,duration:n.duration,url:n.url,attendees:n.attendees}}}async function T(e,t,r,n){if(!e||!t)return null;let i=t.meeting.duration?Math.round(Number(t.meeting.duration)):null,a={avoma_meeting_uuid:t.meeting.uuid,salesforce_account_id:n||null,customer_identifier:r||null,transcription_text:t.transcription,speakers:t.speakers||null,meeting_subject:t.meeting.subject||null,meeting_date:t.meeting.meeting_date||null,meeting_duration:i,meeting_url:t.meeting.url||null,attendees:t.meeting.attendees||null,last_synced_at:new Date().toISOString()},{data:s,error:o}=await e.from("transcriptions").upsert(a,{onConflict:"avoma_meeting_uuid",ignoreDuplicates:!1}).select().single();return o?((0,E.logError)("Error caching transcription:",o),null):s}async function k(){return(0,E.handlePreflight)(new y.NextRequest("http://localhost",{method:"OPTIONS"}))}async function N(e){let t=await (0,E.handlePreflight)(e);if(t)return t;let r=(0,E.validateRequestSize)(e,C.LARGE);if(!r.valid)return(0,E.sendErrorResponse)(Error(r.error.message),r.error.status);try{let t,r=(0,w.getSupabaseClient)(),n=(0,E.validateSupabase)(r);if(!n.valid)return(0,E.sendErrorResponse)(Error(n.error.message),n.error.status);let{searchParams:i}=new URL(e.url),a=i.get("customerIdentifier"),s=i.get("salesforceAccountId"),o=i.get("meetingUuid"),u=i.get("forceRefresh"),c=i.get("accountId"),l=i.get("source");if("cache"===l||(c||s)&&!a&&!o){let e=c||s;if(!e)return(0,E.sendErrorResponse)(Error("Missing required parameter: accountId or salesforceAccountId"),400);let t=r.from("transcriptions").select("*").order("meeting_date",{ascending:!1});s||c&&(!c.includes("-")||36!==c.length)?t=t.eq("salesforce_account_id",e):c&&c.includes("-")&&36===c.length&&(t=t.eq("account_id",c));let{data:n,error:i}=await t;if(i)return(0,E.logError)("Error fetching transcriptions:",i),(0,E.sendErrorResponse)(Error("Failed to fetch transcriptions"),500);let a=(n||[]).map(e=>({id:e.id,avoma_meeting_uuid:e.avoma_meeting_uuid,transcription:e.transcription_text,speakers:e.speakers,meeting:{subject:e.meeting_subject,meeting_date:e.meeting_date,duration:e.meeting_duration,url:e.meeting_url,attendees:e.attendees},last_synced_at:e.last_synced_at,cached:!0}));return(0,E.sendSuccessResponse)({transcriptions:a,total:a.length})}if(!a&&!s&&!o)return(0,E.sendErrorResponse)(Error("Missing required parameter: customerIdentifier, salesforceAccountId, or meetingUuid"),400);let d="true"===u||"1"===u;if(d&&s&&!o){let e=await M(r),t=new v(e.api_key,e.api_url),n=await t.searchMeetings(a||"",50,s),i=n.results||n.calls||[],o=i.filter(e=>e.transcript_ready&&(e.transcription_uuid||e.uuid||e.id));if(0===o.length)return(0,E.sendSuccessResponse)({transcription:"",meetingCounts:{total:i.length,ready:0},warning:"No meetings with ready transcripts found for this account",synced:0});let u=0,c=[];for(let e of o)try{let n=e.uuid||e.id||e.transcription_uuid;if(!n)continue;let i=await x(t,n);await T(r,i,a||"",s),u++}catch(t){(0,E.logError)(`Error syncing meeting ${e.uuid||e.id}:`,t),c.push(t.message)}return(0,E.sendSuccessResponse)({transcription:"",meetingCounts:{total:i.length,ready:o.length},synced:u,errors:c.length>0?c:void 0,message:`Successfully synced ${u} of ${o.length} ready meetings`})}if(!d&&!o){let e=await A(r,a,s);if(e&&e.isFresh)return(0,E.log)("Returning cached transcription (fresh)"),(0,E.sendSuccessResponse)({transcription:e.transcription.transcription_text,speakers:e.transcription.speakers,meeting:{subject:e.transcription.meeting_subject,meeting_date:e.transcription.meeting_date,duration:e.transcription.meeting_duration,url:e.transcription.meeting_url,attendees:e.transcription.attendees},cached:!0,last_synced_at:e.transcription.last_synced_at})}let p=await M(r),g=new v(p.api_key,p.api_url);if(o)t=await x(g,o);else{let e=await I(g,a,s);if(!e.meeting)return(0,E.sendSuccessResponse)({transcription:"",meetingCounts:{total:e.totalMeetings||0,ready:e.readyMeetings||0},warning:"No meetings with ready transcripts found for this customer",searchMethod:s?"crm_account_ids":"customer_name",customerIdentifier:a,salesforceAccountId:s||"not provided"});let r=e.meeting.uuid||e.meeting.id;if(!r)return(0,E.sendErrorResponse)(Error("Meeting found but missing UUID"),500);(t=await x(g,r)).meetingCounts={total:e.totalMeetings,ready:e.readyMeetings}}let m=await T(r,t,a,s);return(0,E.sendSuccessResponse)({transcription:t.transcription,speakers:t.speakers,meeting:{subject:t.meeting.subject,meeting_date:t.meeting.meeting_date,duration:t.meeting.duration,url:t.meeting.url,attendees:t.meeting.attendees},meetingCounts:t.meetingCounts||null,cached:!!m,last_synced_at:m?.last_synced_at||new Date().toISOString()})}catch(e){return(0,E.logError)("Error in avoma-transcription function:",e),(0,E.sendErrorResponse)(e,500)}}async function P(e){let t=await (0,E.handlePreflight)(e);if(t)return t;let r=(0,E.validateRequestSize)(e,C.LARGE);if(!r.valid)return(0,E.sendErrorResponse)(Error(r.error.message),r.error.status);try{let t,r=(0,w.getSupabaseClient)(),n=(0,E.validateSupabase)(r);if(!n.valid)return(0,E.sendErrorResponse)(Error(n.error.message),n.error.status);let{customerIdentifier:i,salesforceAccountId:a,meetingUuid:s,forceRefresh:o,accountId:u,source:c}=await e.json();if("cache"===c||(u||a)&&!i&&!s){let e=u||a;if(!e)return(0,E.sendErrorResponse)(Error("Missing required parameter: accountId or salesforceAccountId"),400);let t=r.from("transcriptions").select("*").order("meeting_date",{ascending:!1});a||u&&(!u.includes("-")||36!==u.length)?t=t.eq("salesforce_account_id",e):u&&u.includes("-")&&36===u.length&&(t=t.eq("account_id",u));let{data:n,error:i}=await t;if(i)return(0,E.logError)("Error fetching transcriptions:",i),(0,E.sendErrorResponse)(Error("Failed to fetch transcriptions"),500);let s=(n||[]).map(e=>({id:e.id,avoma_meeting_uuid:e.avoma_meeting_uuid,transcription:e.transcription_text,speakers:e.speakers,meeting:{subject:e.meeting_subject,meeting_date:e.meeting_date,duration:e.meeting_duration,url:e.meeting_url,attendees:e.attendees},last_synced_at:e.last_synced_at,cached:!0}));return(0,E.sendSuccessResponse)({transcriptions:s,total:s.length})}if(!i&&!a&&!s)return(0,E.sendErrorResponse)(Error("Missing required parameter: customerIdentifier, salesforceAccountId, or meetingUuid"),400);let l="true"===o||"1"===o;if(l&&a&&!s){let e=await M(r),t=new v(e.api_key,e.api_url),n=await t.searchMeetings(i||"",50,a),s=n.results||n.calls||[],o=s.filter(e=>e.transcript_ready&&(e.transcription_uuid||e.uuid||e.id));if(0===o.length)return(0,E.sendSuccessResponse)({transcription:"",meetingCounts:{total:s.length,ready:0},warning:"No meetings with ready transcripts found for this account",synced:0});let u=0,c=[];for(let e of o)try{let n=e.uuid||e.id||e.transcription_uuid;if(!n)continue;let s=await x(t,n);await T(r,s,i||"",a),u++}catch(t){(0,E.logError)(`Error syncing meeting ${e.uuid||e.id}:`,t),c.push(t.message)}return(0,E.sendSuccessResponse)({transcription:"",meetingCounts:{total:s.length,ready:o.length},synced:u,errors:c.length>0?c:void 0,message:`Successfully synced ${u} of ${o.length} ready meetings`})}if(!l&&!s){let e=await A(r,i,a);if(e&&e.isFresh)return(0,E.log)("Returning cached transcription (fresh)"),(0,E.sendSuccessResponse)({transcription:e.transcription.transcription_text,speakers:e.transcription.speakers,meeting:{subject:e.transcription.meeting_subject,meeting_date:e.transcription.meeting_date,duration:e.transcription.meeting_duration,url:e.transcription.meeting_url,attendees:e.transcription.attendees},cached:!0,last_synced_at:e.transcription.last_synced_at})}let d=await M(r),p=new v(d.api_key,d.api_url);if(s)t=await x(p,s);else{let e=await I(p,i,a);if(!e.meeting)return(0,E.sendSuccessResponse)({transcription:"",meetingCounts:{total:e.totalMeetings||0,ready:e.readyMeetings||0},warning:"No meetings with ready transcripts found for this customer",searchMethod:a?"crm_account_ids":"customer_name",customerIdentifier:i,salesforceAccountId:a||"not provided"});let r=e.meeting.uuid||e.meeting.id;if(!r)return(0,E.sendErrorResponse)(Error("Meeting found but missing UUID"),500);(t=await x(p,r)).meetingCounts={total:e.totalMeetings,ready:e.readyMeetings}}let g=await T(r,t,i,a);return(0,E.sendSuccessResponse)({transcription:t.transcription,speakers:t.speakers,meeting:{subject:t.meeting.subject,meeting_date:t.meeting.meeting_date,duration:t.meeting.duration,url:t.meeting.url,attendees:t.meeting.attendees},meetingCounts:t.meetingCounts||null,cached:!!g,last_synced_at:g?.last_synced_at||new Date().toISOString()})}catch(e){return(0,E.logError)("Error in avoma-transcription function:",e),(0,E.sendErrorResponse)(e,500)}}e.s(["GET",()=>N,"OPTIONS",()=>k,"POST",()=>P],88955);var O=e.i(88955);let q=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/avoma-transcription/route",pathname:"/api/avoma-transcription",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/avoma-transcription/route.js",nextConfigOutput:"",userland:O}),{workAsyncStorage:U,workUnitAsyncStorage:j,serverHooks:D}=q;function $(){return(0,n.patchFetch)({workAsyncStorage:U,workUnitAsyncStorage:j})}async function H(e,t,n){q.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/avoma-transcription/route";y=y.replace(/\/index$/,"")||"/";let w=await q.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:E,params:v,nextConfig:C,parsedUrl:S,isDraftMode:b,prerenderManifest:M,routerServerContext:A,isOnDemandRevalidate:I,revalidateOnlyGenerated:x,resolvedPathname:T,clientReferenceManifest:k,serverActionsManifest:N}=w,P=(0,u.normalizeAppPath)(y),O=!!(M.dynamicRoutes[P]||M.routes[T]),U=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,S,!1):t.end("This page could not be found"),null);if(O&&!b){let e=!!M.routes[T],t=M.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await U();throw new h.NoFallbackError}}let j=null;!O||q.isDev||b||(j="/index"===(j=T)?"/":j);let D=!0===q.isDev||!O,$=O&&!D;N&&k&&(0,s.setReferenceManifestsSingleton)({page:y,clientReferenceManifest:k,serverActionsManifest:N,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:N})});let H=e.method||"GET",F=(0,a.getTracer)(),K=F.getActiveScopeSpan(),L={params:v,prerenderManifest:M,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>q.onRequestError(e,t,n,A)},sharedContext:{buildId:E}},G=new c.NodeNextRequest(e),B=new c.NodeNextResponse(t),z=l.NextRequestAdapter.fromNodeNextRequest(G,(0,l.signalFromNodeResponse)(t));try{let s=async e=>q.handle(z,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${H} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${y}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),u=async i=>{var a,u;let c=async({previousCacheEntry:r})=>{try{if(!o&&I&&x&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await s(i);e.fetchMetrics=L.renderOpts.fetchMetrics;let u=L.renderOpts.pendingWaitUntil;u&&n.waitUntil&&(n.waitUntil(u),u=void 0);let c=L.renderOpts.collectedTags;if(!O)return await (0,g.sendResponse)(G,B,a,L.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(a.headers);c&&(t[_.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=_.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,n=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=_.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await q.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:I})},A),t}},l=await q.handleResponse({req:e,nextConfig:C,cacheKey:j,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:M,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:x,responseGenerator:c,waitUntil:n.waitUntil,isMinimalMode:o});if(!O)return null;if((null==l||null==(a=l.value)?void 0:a.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(u=l.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",I?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,m.fromNodeOutgoingHttpHeaders)(l.value.headers);return o&&O||d.delete(_.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,f.getCacheControlHeader)(l.cacheControl)),await (0,g.sendResponse)(G,B,new Response(l.value.body,{headers:d,status:l.value.status||200})),null};K?await u(K):await F.withPropagatedContext(e.headers,()=>F.trace(d.BaseServerSpan.handleRequest,{spanName:`${H} ${y}`,kind:a.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},u))}catch(t){if(t instanceof h.NoFallbackError||await q.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:I})}),O)throw t;return await (0,g.sendResponse)(G,B,new Response(null,{status:500})),null}}e.s(["handler",()=>H,"patchFetch",()=>$,"routeModule",()=>q,"serverHooks",()=>D,"workAsyncStorage",()=>U,"workUnitAsyncStorage",()=>j],56457)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_f797571b.js.map