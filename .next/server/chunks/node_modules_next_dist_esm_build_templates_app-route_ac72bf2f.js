module.exports=[95544,e=>{"use strict";var t=e.i(47909),a=e.i(74017),r=e.i(96250),n=e.i(59756),o=e.i(61916),s=e.i(14444),c=e.i(37092),i=e.i(69741),l=e.i(16795),d=e.i(87718),u=e.i(95169),p=e.i(47587),f=e.i(66012),g=e.i(70101),h=e.i(26937),m=e.i(10372),C=e.i(93695);e.i(52474);var E=e.i(220),R=e.i(89171),y=e.i(69122),_=e.i(3030);let{authenticateSalesforce:S,escapeSOQL:w}=e.r(77182),{isCacheFresh:v}=e.r(30273),{MAX_REQUEST_SIZE:I,CACHE_TTL:b,API_LIMITS:A}=e.r(982);async function N(e,t){if(!e||!t)return null;let{data:a,error:r}=await e.from("cases").select("*").eq("salesforce_account_id",t).order("created_date",{ascending:!1}).limit(A.CASES_PER_ACCOUNT);if(r)return(0,_.logError)("Error querying cached cases",r),null;if(!a||0===a.length)return null;let n=a.reduce((e,t)=>new Date(t.last_synced_at?t.last_synced_at:0)>new Date(e||0)?t.last_synced_at:e,null);return{cases:a,isFresh:v(n,b.CASES),lastSyncedAt:n}}async function D(e,t){let a=w(t),r=`SELECT Id, CaseNumber, Subject, Status, Priority, Type, Reason, Origin, CreatedDate, ClosedDate, Description, 
                     ContactEmail, ContactId, Contact.Name
                     FROM Case 
                     WHERE AccountId = '${a}' 
                     ORDER BY CreatedDate DESC 
                     LIMIT ${A.CASES_PER_ACCOUNT}`;try{let t=await e.query(r),n=t.records?.length||0;if(0===n){let t=`SELECT Id, CaseNumber, Subject, Status, Priority, Type, Reason, Origin, CreatedDate, ClosedDate, Description, 
                           ContactEmail, ContactId
                           FROM Case 
                           WHERE AccountId = '${a}' 
                           ORDER BY CreatedDate DESC 
                           LIMIT ${A.CASES_PER_ACCOUNT}`;try{let a=await e.query(t),r=a.records?.length||0;if(r>0){(0,_.log)(`⚠️ Simpler query returned ${r} cases - Contact.Name field may be causing issues`);let t=a.records.filter(e=>e.ContactId).map(e=>e.ContactId);if(t.length>0){let r=t.map(t=>e.sobject("Contact").retrieve(t,["Name"]).then(e=>({contactId:t,contact:e})).catch(e=>({contactId:t,error:e}))),n=await Promise.all(r),o=new Map;n.forEach(({contactId:e,contact:t,error:a})=>{a?((0,_.logError)(`Could not fetch Contact.Name for ContactId ${e}`,a),o.set(e,null)):o.set(e,{Name:t.Name})}),a.records.forEach(e=>{e.ContactId&&(e.Contact=o.get(e.ContactId)||null)})}return a.records||[]}}catch(e){(0,_.logError)("Simple query also failed:",e)}}return t.records||[]}catch(n){(0,_.logError)("Error querying Salesforce Cases:",n),(0,_.logError)("Query that failed:",r),(0,_.logError)("Account ID used:",t);try{(0,_.log)(`Attempting fallback query without Contact.Name for account ${t}`);let r=`SELECT Id, CaseNumber, Subject, Status, Priority, Type, Reason, Origin, CreatedDate, ClosedDate, Description, 
                              ContactEmail, ContactId
                              FROM Case 
                              WHERE AccountId = '${a}' 
                              ORDER BY CreatedDate DESC 
                              LIMIT ${A.CASES_PER_ACCOUNT}`,n=await e.query(r);if((0,_.log)(`Fallback query returned ${n.records?.length||0} cases`),n.records&&n.records.length>0){let t=n.records.filter(e=>e.ContactId).map(e=>e.ContactId);if(t.length>0){let a=t.map(t=>e.sobject("Contact").retrieve(t,["Name"]).then(e=>({contactId:t,contact:e})).catch(e=>({contactId:t,error:e}))),r=await Promise.all(a),o=new Map;r.forEach(({contactId:e,contact:t,error:a})=>{a?((0,_.logError)(`Could not fetch Contact.Name for ContactId ${e}`,a),o.set(e,null)):o.set(e,{Name:t.Name})}),n.records.forEach(e=>{e.ContactId&&(e.Contact=o.get(e.ContactId)||null)})}}return n.records||[]}catch(e){throw(0,_.logError)("Fallback query also failed:",e),n}}}async function T(e,t,a,r){if(!e||!t||0===t.length)return[];let n=[];for(let o of t){let t={salesforce_id:o.Id,salesforce_account_id:a,account_id:r||null,case_number:o.CaseNumber||null,subject:o.Subject||null,status:o.Status||null,priority:o.Priority||null,type:o.Type||null,reason:o.Reason||null,origin:o.Origin||null,created_date:o.CreatedDate||null,closed_date:o.ClosedDate||null,description:o.Description||null,last_synced_at:new Date().toISOString()};void 0!==o.ContactEmail&&(t.contact_email=o.ContactEmail||null),void 0!==o.ContactId&&(t.contact_id=o.ContactId||null),o.Contact?.Name!==void 0&&(t.contact_name=o.Contact?.Name||null);let{data:s,error:c}=await e.from("cases").upsert(t,{onConflict:"salesforce_id",ignoreDuplicates:!1}).select().single();if(c)if("PGRST204"===c.code&&(c.message?.includes("contact_email")||c.message?.includes("contact_id")||c.message?.includes("contact_name"))){(0,_.logError)(`Contact columns not found in cases table. Please run migration 013_add_case_contact_fields.sql. Retrying without contact fields for case ${o.Id}`),delete t.contact_email,delete t.contact_id,delete t.contact_name;let{data:a,error:r}=await e.from("cases").upsert(t,{onConflict:"salesforce_id",ignoreDuplicates:!1}).select().single();if(r){(0,_.logError)(`Error syncing case ${o.Id} (retry without contact fields):`,r);continue}n.push(a)}else{(0,_.logError)(`Error syncing case ${o.Id}:`,c);continue}else n.push(s)}return n}async function O(){return(0,_.handlePreflight)(new R.NextRequest("http://localhost",{method:"OPTIONS"}))}async function P(e){let t=await (0,_.handlePreflight)(e);if(t)return t;let a=(0,_.validateRequestSize)(e,I.DEFAULT);if(!a.valid)return(0,_.sendErrorResponse)(Error(a.error.message),a.error.status);let{searchParams:r}=new URL(e.url),n=r.get("salesforceAccountId"),o=r.get("accountId"),s=r.get("forceRefresh");if(!n)return(0,_.sendErrorResponse)(Error("Missing required parameter: salesforceAccountId"),400);let c="true"===s||"1"===s;try{let e=(0,y.getSupabaseClient)(),t=(0,_.validateSupabase)(e);if(!t.valid)return(0,_.sendErrorResponse)(Error(t.error.message),t.error.status);if(!c){let t=await N(e,n);if(t&&t.isFresh){let e=t.cases.map(e=>({id:e.salesforce_id,caseNumber:e.case_number,subject:e.subject,status:e.status,priority:e.priority,type:e.type,reason:e.reason,origin:e.origin,createdDate:e.created_date,closedDate:e.closed_date,description:e.description,contactEmail:e.contact_email,contactId:e.contact_id,contactName:e.contact_name}));return(0,_.sendSuccessResponse)({cases:e,total:t.cases.length,cached:!0,lastSyncedAt:t.lastSyncedAt})}t&&!t.isFresh&&(0,_.log)(`Cache stale for account ${n}, refreshing from Salesforce`)}c&&(0,_.log)(`Force refresh requested, querying Salesforce for account ${n}`);let a=await S(e),r=await D(a.connection,n);r.length>0&&(0,_.log)(`Retrieved ${r.length} cases from Salesforce`);let s=null;if(o&&o.includes("-")&&36===o.length){let[t,a]=await Promise.all([e.from("accounts").select("id").eq("id",o).single(),e.from("accounts").select("id").eq("salesforce_id",n).single()]);s=t.data?.id||a.data?.id||null}else{let{data:t}=await e.from("accounts").select("id").eq("salesforce_id",n).single();s=t?.id||null}let i=(await T(e,r,n,s)).map(e=>({id:e.salesforce_id,caseNumber:e.case_number,subject:e.subject,status:e.status,priority:e.priority,type:e.type,reason:e.reason,origin:e.origin,createdDate:e.created_date,closedDate:e.closed_date,description:e.description,contactEmail:e.contact_email,contactId:e.contact_id,contactName:e.contact_name}));return(0,_.sendSuccessResponse)({cases:i,total:i.length,cached:!1,lastSyncedAt:new Date().toISOString(),_debug:(0,_.isProduction)()?void 0:{cacheLookup:!1,casesCount:i.length,salesforceAccountId:n}})}catch(t){(0,_.logError)("Error in salesforce-cases function:",t);let e=(0,y.getSupabaseClient)();if(!c&&e&&(0,_.validateSupabase)(e).valid){let t=await N(e,n);if(t&&t.cases.length>0)return(0,_.log)(`Salesforce query failed, using ${t.cases.length} stale cached cases`),(0,_.sendSuccessResponse)({cases:t.cases.map(e=>({id:e.salesforce_id,caseNumber:e.case_number,subject:e.subject,status:e.status,priority:e.priority,type:e.type,reason:e.reason,origin:e.origin,createdDate:e.created_date,closedDate:e.closed_date,description:e.description,contactEmail:e.contact_email,contactId:e.contact_id,contactName:e.contact_name})),total:t.cases.length,cached:!0,stale:!0,lastSyncedAt:t.lastSyncedAt})}return(0,_.sendErrorResponse)(t,500)}}e.s(["GET",()=>P,"OPTIONS",()=>O],71617);var q=e.i(71617);let x=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/salesforce-cases/route",pathname:"/api/salesforce-cases",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/salesforce-cases/route.js",nextConfigOutput:"",userland:q}),{workAsyncStorage:$,workUnitAsyncStorage:M,serverHooks:U}=x;function j(){return(0,r.patchFetch)({workAsyncStorage:$,workUnitAsyncStorage:M})}async function H(e,t,r){x.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/salesforce-cases/route";R=R.replace(/\/index$/,"")||"/";let y=await x.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:_,params:S,nextConfig:w,parsedUrl:v,isDraftMode:I,prerenderManifest:b,routerServerContext:A,isOnDemandRevalidate:N,revalidateOnlyGenerated:D,resolvedPathname:T,clientReferenceManifest:O,serverActionsManifest:P}=y,q=(0,i.normalizeAppPath)(R),$=!!(b.dynamicRoutes[q]||b.routes[T]),M=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,v,!1):t.end("This page could not be found"),null);if($&&!I){let e=!!b.routes[T],t=b.dynamicRoutes[q];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await M();throw new C.NoFallbackError}}let U=null;!$||x.isDev||I||(U="/index"===(U=T)?"/":U);let j=!0===x.isDev||!$,H=$&&!j;P&&O&&(0,s.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:O,serverActionsManifest:P,serverModuleMap:(0,c.createServerModuleMap)({serverActionsManifest:P})});let k=e.method||"GET",F=(0,o.getTracer)(),L=F.getActiveScopeSpan(),B={params:S,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>x.onRequestError(e,t,r,A)},sharedContext:{buildId:_}},K=new l.NodeNextRequest(e),G=new l.NodeNextResponse(t),W=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let s=async e=>x.handle(W,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=F.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${k} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${R}`)}),c=!!(0,n.getRequestMeta)(e,"minimalMode"),i=async n=>{var o,i;let l=async({previousCacheEntry:a})=>{try{if(!c&&N&&D&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await s(n);e.fetchMetrics=B.renderOpts.fetchMetrics;let i=B.renderOpts.pendingWaitUntil;i&&r.waitUntil&&(r.waitUntil(i),i=void 0);let l=B.renderOpts.collectedTags;if(!$)return await (0,f.sendResponse)(K,G,o,B.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(o.headers);l&&(t[m.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,r=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:N})},A),t}},d=await x.handleResponse({req:e,nextConfig:w,cacheKey:U,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:D,responseGenerator:l,waitUntil:r.waitUntil,isMinimalMode:c});if(!$)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(i=d.value)?void 0:i.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});c||t.setHeader("x-nextjs-cache",N?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),I&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return c&&$||u.delete(m.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,h.getCacheControlHeader)(d.cacheControl)),await (0,f.sendResponse)(K,G,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};L?await i(L):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${k} ${R}`,kind:o.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},i))}catch(t){if(t instanceof C.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:q,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:N})}),$)throw t;return await (0,f.sendResponse)(K,G,new Response(null,{status:500})),null}}e.s(["handler",()=>H,"patchFetch",()=>j,"routeModule",()=>x,"serverHooks",()=>U,"workAsyncStorage",()=>$,"workUnitAsyncStorage",()=>M],95544)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_ac72bf2f.js.map