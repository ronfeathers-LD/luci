{"version":3,"sources":["../../../node_modules/next/dist/esm/build/templates/app-route.js","../../../src/app/api/analyze-sentiment/route.js"],"sourcesContent":["import { AppRouteRouteModule } from \"next/dist/esm/server/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/esm/server/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/esm/server/lib/patch-fetch\";\nimport { addRequestMeta, getRequestMeta } from \"next/dist/esm/server/request-meta\";\nimport { getTracer, SpanKind } from \"next/dist/esm/server/lib/trace/tracer\";\nimport { setReferenceManifestsSingleton } from \"next/dist/esm/server/app-render/encryption-utils\";\nimport { createServerModuleMap } from \"next/dist/esm/server/app-render/action-utils\";\nimport { normalizeAppPath } from \"next/dist/esm/shared/lib/router/utils/app-paths\";\nimport { NodeNextRequest, NodeNextResponse } from \"next/dist/esm/server/base-http/node\";\nimport { NextRequestAdapter, signalFromNodeResponse } from \"next/dist/esm/server/web/spec-extension/adapters/next-request\";\nimport { BaseServerSpan } from \"next/dist/esm/server/lib/trace/constants\";\nimport { getRevalidateReason } from \"next/dist/esm/server/instrumentation/utils\";\nimport { sendResponse } from \"next/dist/esm/server/send-response\";\nimport { fromNodeOutgoingHttpHeaders, toNodeOutgoingHttpHeaders } from \"next/dist/esm/server/web/utils\";\nimport { getCacheControlHeader } from \"next/dist/esm/server/lib/cache-control\";\nimport { INFINITE_CACHE, NEXT_CACHE_TAGS_HEADER } from \"next/dist/esm/lib/constants\";\nimport { NoFallbackError } from \"next/dist/esm/shared/lib/no-fallback-error.external\";\nimport { CachedRouteKind } from \"next/dist/esm/server/response-cache\";\nimport * as userland from \"INNER_APP_ROUTE\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/analyze-sentiment/route\",\n        pathname: \"/api/analyze-sentiment\",\n        filename: \"route\",\n        bundlePath: \"\"\n    },\n    distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n    relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n    resolvedPagePath: \"[project]/src/app/api/analyze-sentiment/route.js\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule;\nfunction patchFetch() {\n    return _patchFetch({\n        workAsyncStorage,\n        workUnitAsyncStorage\n    });\n}\nexport { routeModule, workAsyncStorage, workUnitAsyncStorage, serverHooks, patchFetch,  };\nexport async function handler(req, res, ctx) {\n    if (routeModule.isDev) {\n        addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint());\n    }\n    let srcPage = \"/api/analyze-sentiment/route\";\n    // turbopack doesn't normalize `/index` in the page name\n    // so we need to to process dynamic routes properly\n    // TODO: fix turbopack providing differing value from webpack\n    if (process.env.TURBOPACK) {\n        srcPage = srcPage.replace(/\\/index$/, '') || '/';\n    } else if (srcPage === '/index') {\n        // we always normalize /index specifically\n        srcPage = '/';\n    }\n    const multiZoneDraftMode = process.env.__NEXT_MULTI_ZONE_DRAFT_MODE;\n    const prepareResult = await routeModule.prepare(req, res, {\n        srcPage,\n        multiZoneDraftMode\n    });\n    if (!prepareResult) {\n        res.statusCode = 400;\n        res.end('Bad Request');\n        ctx.waitUntil == null ? void 0 : ctx.waitUntil.call(ctx, Promise.resolve());\n        return null;\n    }\n    const { buildId, params, nextConfig, parsedUrl, isDraftMode, prerenderManifest, routerServerContext, isOnDemandRevalidate, revalidateOnlyGenerated, resolvedPathname, clientReferenceManifest, serverActionsManifest } = prepareResult;\n    const normalizedSrcPage = normalizeAppPath(srcPage);\n    let isIsr = Boolean(prerenderManifest.dynamicRoutes[normalizedSrcPage] || prerenderManifest.routes[resolvedPathname]);\n    const render404 = async ()=>{\n        // TODO: should route-module itself handle rendering the 404\n        if (routerServerContext == null ? void 0 : routerServerContext.render404) {\n            await routerServerContext.render404(req, res, parsedUrl, false);\n        } else {\n            res.end('This page could not be found');\n        }\n        return null;\n    };\n    if (isIsr && !isDraftMode) {\n        const isPrerendered = Boolean(prerenderManifest.routes[resolvedPathname]);\n        const prerenderInfo = prerenderManifest.dynamicRoutes[normalizedSrcPage];\n        if (prerenderInfo) {\n            if (prerenderInfo.fallback === false && !isPrerendered) {\n                if (nextConfig.experimental.adapterPath) {\n                    return await render404();\n                }\n                throw new NoFallbackError();\n            }\n        }\n    }\n    let cacheKey = null;\n    if (isIsr && !routeModule.isDev && !isDraftMode) {\n        cacheKey = resolvedPathname;\n        // ensure /index and / is normalized to one key\n        cacheKey = cacheKey === '/index' ? '/' : cacheKey;\n    }\n    const supportsDynamicResponse = // If we're in development, we always support dynamic HTML\n    routeModule.isDev === true || // If this is not SSG or does not have static paths, then it supports\n    // dynamic HTML.\n    !isIsr;\n    // This is a revalidation request if the request is for a static\n    // page and it is not being resumed from a postponed render and\n    // it is not a dynamic RSC request then it is a revalidation\n    // request.\n    const isStaticGeneration = isIsr && !supportsDynamicResponse;\n    // Before rendering (which initializes component tree modules), we have to\n    // set the reference manifests to our global store so Server Action's\n    // encryption util can access to them at the top level of the page module.\n    if (serverActionsManifest && clientReferenceManifest) {\n        setReferenceManifestsSingleton({\n            page: srcPage,\n            clientReferenceManifest,\n            serverActionsManifest,\n            serverModuleMap: createServerModuleMap({\n                serverActionsManifest\n            })\n        });\n    }\n    const method = req.method || 'GET';\n    const tracer = getTracer();\n    const activeSpan = tracer.getActiveScopeSpan();\n    const context = {\n        params,\n        prerenderManifest,\n        renderOpts: {\n            experimental: {\n                authInterrupts: Boolean(nextConfig.experimental.authInterrupts)\n            },\n            cacheComponents: Boolean(nextConfig.cacheComponents),\n            supportsDynamicResponse,\n            incrementalCache: getRequestMeta(req, 'incrementalCache'),\n            cacheLifeProfiles: nextConfig.cacheLife,\n            waitUntil: ctx.waitUntil,\n            onClose: (cb)=>{\n                res.on('close', cb);\n            },\n            onAfterTaskError: undefined,\n            onInstrumentationRequestError: (error, _request, errorContext)=>routeModule.onRequestError(req, error, errorContext, routerServerContext)\n        },\n        sharedContext: {\n            buildId\n        }\n    };\n    const nodeNextReq = new NodeNextRequest(req);\n    const nodeNextRes = new NodeNextResponse(res);\n    const nextReq = NextRequestAdapter.fromNodeNextRequest(nodeNextReq, signalFromNodeResponse(res));\n    try {\n        const invokeRouteModule = async (span)=>{\n            return routeModule.handle(nextReq, context).finally(()=>{\n                if (!span) return;\n                span.setAttributes({\n                    'http.status_code': res.statusCode,\n                    'next.rsc': false\n                });\n                const rootSpanAttributes = tracer.getRootSpanAttributes();\n                // We were unable to get attributes, probably OTEL is not enabled\n                if (!rootSpanAttributes) {\n                    return;\n                }\n                if (rootSpanAttributes.get('next.span_type') !== BaseServerSpan.handleRequest) {\n                    console.warn(`Unexpected root span type '${rootSpanAttributes.get('next.span_type')}'. Please report this Next.js issue https://github.com/vercel/next.js`);\n                    return;\n                }\n                const route = rootSpanAttributes.get('next.route');\n                if (route) {\n                    const name = `${method} ${route}`;\n                    span.setAttributes({\n                        'next.route': route,\n                        'http.route': route,\n                        'next.span_name': name\n                    });\n                    span.updateName(name);\n                } else {\n                    span.updateName(`${method} ${srcPage}`);\n                }\n            });\n        };\n        const isMinimalMode = Boolean(process.env.MINIMAL_MODE || getRequestMeta(req, 'minimalMode'));\n        const handleResponse = async (currentSpan)=>{\n            var _cacheEntry_value;\n            const responseGenerator = async ({ previousCacheEntry })=>{\n                try {\n                    if (!isMinimalMode && isOnDemandRevalidate && revalidateOnlyGenerated && !previousCacheEntry) {\n                        res.statusCode = 404;\n                        // on-demand revalidate always sets this header\n                        res.setHeader('x-nextjs-cache', 'REVALIDATED');\n                        res.end('This page could not be found');\n                        return null;\n                    }\n                    const response = await invokeRouteModule(currentSpan);\n                    req.fetchMetrics = context.renderOpts.fetchMetrics;\n                    let pendingWaitUntil = context.renderOpts.pendingWaitUntil;\n                    // Attempt using provided waitUntil if available\n                    // if it's not we fallback to sendResponse's handling\n                    if (pendingWaitUntil) {\n                        if (ctx.waitUntil) {\n                            ctx.waitUntil(pendingWaitUntil);\n                            pendingWaitUntil = undefined;\n                        }\n                    }\n                    const cacheTags = context.renderOpts.collectedTags;\n                    // If the request is for a static response, we can cache it so long\n                    // as it's not edge.\n                    if (isIsr) {\n                        const blob = await response.blob();\n                        // Copy the headers from the response.\n                        const headers = toNodeOutgoingHttpHeaders(response.headers);\n                        if (cacheTags) {\n                            headers[NEXT_CACHE_TAGS_HEADER] = cacheTags;\n                        }\n                        if (!headers['content-type'] && blob.type) {\n                            headers['content-type'] = blob.type;\n                        }\n                        const revalidate = typeof context.renderOpts.collectedRevalidate === 'undefined' || context.renderOpts.collectedRevalidate >= INFINITE_CACHE ? false : context.renderOpts.collectedRevalidate;\n                        const expire = typeof context.renderOpts.collectedExpire === 'undefined' || context.renderOpts.collectedExpire >= INFINITE_CACHE ? undefined : context.renderOpts.collectedExpire;\n                        // Create the cache entry for the response.\n                        const cacheEntry = {\n                            value: {\n                                kind: CachedRouteKind.APP_ROUTE,\n                                status: response.status,\n                                body: Buffer.from(await blob.arrayBuffer()),\n                                headers\n                            },\n                            cacheControl: {\n                                revalidate,\n                                expire\n                            }\n                        };\n                        return cacheEntry;\n                    } else {\n                        // send response without caching if not ISR\n                        await sendResponse(nodeNextReq, nodeNextRes, response, context.renderOpts.pendingWaitUntil);\n                        return null;\n                    }\n                } catch (err) {\n                    // if this is a background revalidate we need to report\n                    // the request error here as it won't be bubbled\n                    if (previousCacheEntry == null ? void 0 : previousCacheEntry.isStale) {\n                        await routeModule.onRequestError(req, err, {\n                            routerKind: 'App Router',\n                            routePath: srcPage,\n                            routeType: 'route',\n                            revalidateReason: getRevalidateReason({\n                                isStaticGeneration,\n                                isOnDemandRevalidate\n                            })\n                        }, routerServerContext);\n                    }\n                    throw err;\n                }\n            };\n            const cacheEntry = await routeModule.handleResponse({\n                req,\n                nextConfig,\n                cacheKey,\n                routeKind: RouteKind.APP_ROUTE,\n                isFallback: false,\n                prerenderManifest,\n                isRoutePPREnabled: false,\n                isOnDemandRevalidate,\n                revalidateOnlyGenerated,\n                responseGenerator,\n                waitUntil: ctx.waitUntil,\n                isMinimalMode\n            });\n            // we don't create a cacheEntry for ISR\n            if (!isIsr) {\n                return null;\n            }\n            if ((cacheEntry == null ? void 0 : (_cacheEntry_value = cacheEntry.value) == null ? void 0 : _cacheEntry_value.kind) !== CachedRouteKind.APP_ROUTE) {\n                var _cacheEntry_value1;\n                throw Object.defineProperty(new Error(`Invariant: app-route received invalid cache entry ${cacheEntry == null ? void 0 : (_cacheEntry_value1 = cacheEntry.value) == null ? void 0 : _cacheEntry_value1.kind}`), \"__NEXT_ERROR_CODE\", {\n                    value: \"E701\",\n                    enumerable: false,\n                    configurable: true\n                });\n            }\n            if (!isMinimalMode) {\n                res.setHeader('x-nextjs-cache', isOnDemandRevalidate ? 'REVALIDATED' : cacheEntry.isMiss ? 'MISS' : cacheEntry.isStale ? 'STALE' : 'HIT');\n            }\n            // Draft mode should never be cached\n            if (isDraftMode) {\n                res.setHeader('Cache-Control', 'private, no-cache, no-store, max-age=0, must-revalidate');\n            }\n            const headers = fromNodeOutgoingHttpHeaders(cacheEntry.value.headers);\n            if (!(isMinimalMode && isIsr)) {\n                headers.delete(NEXT_CACHE_TAGS_HEADER);\n            }\n            // If cache control is already set on the response we don't\n            // override it to allow users to customize it via next.config\n            if (cacheEntry.cacheControl && !res.getHeader('Cache-Control') && !headers.get('Cache-Control')) {\n                headers.set('Cache-Control', getCacheControlHeader(cacheEntry.cacheControl));\n            }\n            await sendResponse(nodeNextReq, nodeNextRes, // @ts-expect-error - Argument of type 'Buffer<ArrayBufferLike>' is not assignable to parameter of type 'BodyInit | null | undefined'.\n            new Response(cacheEntry.value.body, {\n                headers,\n                status: cacheEntry.value.status || 200\n            }));\n            return null;\n        };\n        // TODO: activeSpan code path is for when wrapped by\n        // next-server can be removed when this is no longer used\n        if (activeSpan) {\n            await handleResponse(activeSpan);\n        } else {\n            await tracer.withPropagatedContext(req.headers, ()=>tracer.trace(BaseServerSpan.handleRequest, {\n                    spanName: `${method} ${srcPage}`,\n                    kind: SpanKind.SERVER,\n                    attributes: {\n                        'http.method': method,\n                        'http.target': req.url\n                    }\n                }, handleResponse));\n        }\n    } catch (err) {\n        if (!(err instanceof NoFallbackError)) {\n            await routeModule.onRequestError(req, err, {\n                routerKind: 'App Router',\n                routePath: normalizedSrcPage,\n                routeType: 'route',\n                revalidateReason: getRevalidateReason({\n                    isStaticGeneration,\n                    isOnDemandRevalidate\n                })\n            });\n        }\n        // rethrow so that we can handle serving error page\n        // If this is during static generation, throw the error again.\n        if (isIsr) throw err;\n        // Otherwise, send a 500 response.\n        await sendResponse(nodeNextReq, nodeNextRes, new Response(null, {\n            status: 500\n        }));\n        return null;\n    }\n}\n\n//# sourceMappingURL=app-route.js.map\n","/**\n * Next.js App Router API Route for Sentiment Analysis\n * \n * This function securely handles the Gemini API call server-side,\n * protecting the API key from client-side exposure.\n * Also saves sentiment results to database for historical tracking.\n */\n\nimport { NextRequest } from 'next/server';\nimport { getSupabaseClient } from '../../../lib/supabase-server';\nimport { handlePreflight, validateRequestSize, sendErrorResponse, sendSuccessResponse, validateSupabase, getClientIP, checkRateLimit, log, logError, isProduction } from '../../../lib/next-api-helpers';\n\n// Can use require for lib files in Next.js API routes\nconst { MAX_REQUEST_SIZE, REQUEST_TIMEOUT, RATE_LIMIT } = require('../../../../lib/constants');\n\n// Handle OPTIONS preflight\nexport async function OPTIONS() {\n  return handlePreflight(new NextRequest('http://localhost', { method: 'OPTIONS' }));\n}\n\n// POST /api/analyze-sentiment\nexport async function POST(request) {\n  const preflight = await handlePreflight(request);\n  if (preflight) return preflight;\n\n  // Rate limiting\n  const clientIp = getClientIP(request);\n  \n  if (!checkRateLimit(clientIp, RATE_LIMIT.WINDOW, RATE_LIMIT.MAX_REQUESTS)) {\n    return sendErrorResponse(new Error('Too many requests. Please try again in a minute.'), 429);\n  }\n\n  // Validate request size\n  const sizeValidation = validateRequestSize(request, MAX_REQUEST_SIZE.LARGE);\n  if (!sizeValidation.valid) {\n    return sendErrorResponse(new Error(sizeValidation.error.message), sizeValidation.error.status);\n  }\n\n  // Get API key from environment variable\n  const apiKey = process.env.GEMINI_API_KEY;\n  \n  if (!apiKey) {\n    logError('GEMINI_API_KEY environment variable is not set');\n    return sendErrorResponse(new Error('Server configuration error'), 500);\n  }\n\n  try {\n    const body = await request.json();\n    const { transcription, salesforceContext, userId, accountId, salesforceAccountId, customerIdentifier, forceRefresh } = body;\n\n    // Validate input\n    // transcription can be empty string (analysis can proceed with Salesforce data only)\n    // but salesforceContext is required\n    if (transcription === undefined || transcription === null || !salesforceContext) {\n      return sendErrorResponse(new Error('Missing required parameters: transcription and salesforceContext'), 400);\n    }\n    \n    // Validate input types and sizes\n    // Allow empty string for transcription (no Avoma data available)\n    if (typeof transcription !== 'string' || transcription.length > 50000) {\n      return sendErrorResponse(new Error('Invalid transcription: must be a string under 50,000 characters'), 400);\n    }\n    \n    if (typeof salesforceContext !== 'object' || salesforceContext === null) {\n      return sendErrorResponse(new Error('Invalid salesforceContext: must be an object'), 400);\n    }\n    \n    // Create a hash/fingerprint of the input data to check for duplicates\n    // We'll use a hash of key data points that would affect sentiment\n    const crypto = require('crypto');\n    \n    // Create a simplified hash of the transcription (first 1000 chars + length + last 100 chars)\n    // This captures content changes without hashing the entire transcription\n    const transcriptionFingerprint = transcription \n      ? `${transcription.substring(0, 1000)}|${transcription.length}|${transcription.substring(Math.max(0, transcription.length - 100))}`\n      : '';\n    \n    // Create hash of key metrics that affect sentiment\n    const inputHash = crypto.createHash('sha256')\n      .update(JSON.stringify({\n        transcriptionFingerprint: transcriptionFingerprint,\n        transcriptionLength: transcription?.length || 0,\n        casesCount: salesforceContext.total_cases_count || 0,\n        avomaCallsTotal: salesforceContext.total_avoma_calls || 0,\n        avomaCallsReady: salesforceContext.ready_avoma_calls || 0,\n        // Include key contact/case data that affects sentiment\n        contactLevels: salesforceContext.contact_levels ? {\n          cLevelInCases: salesforceContext.contact_levels.c_level_in_cases || 0,\n          srLevelInCases: salesforceContext.contact_levels.sr_level_in_cases || 0,\n        } : null,\n        // Hash of case statuses/priorities to detect case changes\n        // Note: salesforceContext uses 'recent_tickets' not 'cases'\n        // Sort by createdDay first, then status, then priority for deterministic ordering\n        caseSignatures: salesforceContext.recent_tickets ? \n          (salesforceContext.recent_tickets || []).slice(0, 50).map(c => ({\n            status: c.status || null,\n            priority: c.priority || null,\n            // Include created date truncated to day (to catch new cases)\n            createdDay: c.created_date ? new Date(c.created_date).toISOString().split('T')[0] : null,\n          }))\n          .sort((a, b) => {\n            // Sort deterministically: by createdDay (newest first), then status, then priority\n            const dayA = a.createdDay || '';\n            const dayB = b.createdDay || '';\n            if (dayA !== dayB) return dayB.localeCompare(dayA); // Newest first\n            const statusA = a.status || '';\n            const statusB = b.status || '';\n            if (statusA !== statusB) return statusA.localeCompare(statusB);\n            const priorityA = a.priority || '';\n            const priorityB = b.priority || '';\n            return priorityA.localeCompare(priorityB);\n          })\n          : null,\n      }))\n      .digest('hex');\n    \n    // Check if we have a recent analysis with the same input data (skip if forceRefresh is true)\n    if (!forceRefresh) {\n      try {\n        const supabase = getSupabaseClient();\n        if (supabase && (accountId || salesforceAccountId)) {\n        // Resolve account_id - check if accountId is a UUID or a Salesforce ID\n        let resolvedAccountId = null;\n        \n        // Check if accountId is a UUID (has dashes and is 36 chars)\n        const isUUID = accountId && accountId.includes('-') && accountId.length === 36;\n        \n        if (isUUID) {\n          // accountId is already a UUID, use it directly\n          resolvedAccountId = accountId;\n          log(`accountId ${accountId} is a UUID, using directly for cache check`);\n        } else {\n          // accountId is either missing or is a Salesforce ID, so resolve it\n          const lookupId = accountId || salesforceAccountId;\n          if (lookupId) {\n            log(`Resolving account UUID from salesforce_id: ${lookupId}`);\n            const { data: account, error: accountError } = await supabase\n              .from('accounts')\n              .select('id')\n              .eq('salesforce_id', lookupId)\n              .maybeSingle();\n            \n            if (accountError) {\n              logError('Error looking up account for cache check:', accountError);\n              resolvedAccountId = null;\n            } else if (account) {\n              resolvedAccountId = account.id;\n            }\n          }\n        }\n\n        if (resolvedAccountId) {\n          // Check for analysis with exact same input hash (perfect match)\n          // Use maybeSingle() instead of single() to avoid errors when no match found\n          const { data: exactMatch, error: exactMatchError } = await supabase\n            .from('sentiment_history')\n            .select('*')\n            .eq('account_id', resolvedAccountId)\n            .eq('input_hash', inputHash)\n            .order('analyzed_at', { ascending: false })\n            .limit(1)\n            .maybeSingle();\n\n          if (exactMatchError) {\n            log(`Error checking exact match cache: ${exactMatchError.message}`);\n          } else if (exactMatch) {\n            log(`✅ Found cached sentiment analysis with identical input data (analyzed at ${exactMatch.analyzed_at}) - returning cached result (no changes detected)`);\n            return sendSuccessResponse({\n              score: exactMatch.score,\n              summary: exactMatch.summary,\n              comprehensiveAnalysis: exactMatch.comprehensive_analysis || exactMatch.summary,\n              cached: true,\n              analyzedAt: exactMatch.analyzed_at,\n              sentimentId: exactMatch.id, // Include sentiment ID for navigation\n            });\n          }\n\n          // Fallback: Check for recent analysis (within last 7 days) with same signature\n          // This catches cases where the hash column doesn't exist yet or is null\n          // Extended to 7 days since if data hasn't changed, we can use older cached results\n          const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();\n          \n          const { data: recentAnalysis, error: recentAnalysisError } = await supabase\n            .from('sentiment_history')\n            .select('*')\n            .eq('account_id', resolvedAccountId)\n            .gte('analyzed_at', sevenDaysAgo)\n            .eq('transcription_length', transcription?.length || 0)\n            .eq('cases_count', salesforceContext.total_cases_count || 0)\n            .eq('avoma_calls_total', salesforceContext.total_avoma_calls || 0)\n            .eq('avoma_calls_ready', salesforceContext.ready_avoma_calls || 0)\n            .order('analyzed_at', { ascending: false })\n            .limit(1)\n            .maybeSingle();\n\n          if (recentAnalysisError) {\n            logError('Error checking recent analysis cache:', recentAnalysisError);\n          } else if (recentAnalysis) {\n            log(`✅ Using cached sentiment analysis from ${new Date(recentAnalysis.analyzed_at).toLocaleString()}`);\n            return sendSuccessResponse({\n              score: recentAnalysis.score,\n              summary: recentAnalysis.summary,\n              comprehensiveAnalysis: recentAnalysis.comprehensive_analysis || recentAnalysis.summary,\n              cached: true,\n              analyzedAt: recentAnalysis.analyzed_at,\n              sentimentId: recentAnalysis.id, // Include sentiment ID for navigation\n            });\n          }\n        }\n        }\n      } catch (cacheCheckError) {\n        // Don't fail the request if cache check fails - just log and continue\n        logError('Cache check failed, proceeding with new analysis:', cacheCheckError);\n      }\n    } else {\n      log('Force refresh requested - skipping cache check');\n    }\n    \n    // Default model name (used if discovery fails)\n    const modelName = process.env.GEMINI_MODEL || 'gemini-1.5-pro';\n    \n    // Timeout for Gemini API calls\n    // Reduced since we skip model discovery for faster performance\n    const GEMINI_API_TIMEOUT = 45000; // 45 seconds (should be plenty for API call)\n    \n    const requestBody = {\n      contents: [{\n        parts: [{\n          text: `Analyze the customer sentiment from the following conversation transcription and Salesforce account context.\n\n=== CONVERSATION TRANSCRIPTION ===\n${transcription || '(No transcription available)'}\n\n=== SALESFORCE ACCOUNT CONTEXT ===\n${JSON.stringify(salesforceContext, null, 2)}\n\n=== ANALYSIS INSTRUCTIONS ===\nProvide a comprehensive sentiment analysis considering:\n\n1. **Conversation Sentiment**:\n   - Initial customer tone and emotional state\n   - Language patterns (positive/negative indicators, urgency, frustration)\n   - Resolution quality and how concerns were addressed\n   - Final outcome and customer satisfaction level\n\n2. **Support Case Context**:\n   - Number of recent support cases (${salesforceContext.total_cases_count || 0} total)\n   - Case priorities and statuses (high priority or unresolved cases indicate issues)\n   - Case descriptions (customer feedback and issue details)\n   - Case types and reasons (patterns in support needs)\n   - Resolution timelines (closed dates vs created dates)\n   - **CRITICAL: Contact Level Involvement in Cases**:\n     ${salesforceContext.contact_levels ? `\n     * C-Level contacts involved in cases: ${salesforceContext.contact_levels.c_level_in_cases || 0} (${salesforceContext.contact_levels.c_level_count || 0} total C-Level contacts)\n       - ⚠️ This is a MAJOR RED FLAG - C-Level executives submitting support cases indicates serious issues\n       - C-Level involvement suggests problems have escalated to the highest levels\n     * Sr. Level contacts involved in cases: ${salesforceContext.contact_levels.sr_level_in_cases || 0} (${salesforceContext.contact_levels.sr_level_count || 0} total Sr. Level contacts)\n       - ⚠️ This is a SIGNIFICANT CONCERN - Senior leadership involvement indicates problems are not being resolved\n       - Sr. Level (VP, Director, etc.) involvement suggests frustration and escalation\n     * Other contacts involved in cases: ${salesforceContext.contact_levels.other_in_cases || 0} (${salesforceContext.contact_levels.other_count || 0} total other contacts)\n     ` : 'Contact level data not available'}\n     - **Weight case involvement by contact level heavily** - C-Level or Sr. Level on cases is a strong negative signal\n\n3. **Account Profile**:\n   - Account tier: ${salesforceContext.account_tier || 'Unknown'}\n   - Contract value: ${salesforceContext.contract_value || 'Unknown'}\n   - Industry: ${salesforceContext.industry || 'Unknown'}\n   - Account manager: ${salesforceContext.account_manager || 'Unknown'}\n\n4. **Engagement Metrics**:\n   - Total Avoma calls: ${salesforceContext.total_avoma_calls || 0}\n   - Ready transcripts: ${salesforceContext.ready_avoma_calls || 0}\n\n5. **Contact Intelligence & Professional Context**${salesforceContext.linkedin_data ? `:\n   - Total contacts: ${salesforceContext.linkedin_data.total_contacts || 0}\n   - Contact breakdown by level:\n     * C-Level: ${salesforceContext.linkedin_data.contact_level_counts?.['C-Level'] || 0} contacts\n     * Sr. Level: ${salesforceContext.linkedin_data.contact_level_counts?.['Sr. Level'] || 0} contacts\n     * Other: ${salesforceContext.linkedin_data.contact_level_counts?.['Other'] || 0} contacts\n   - Contacts involved in support cases by level:\n     * C-Level: ${salesforceContext.linkedin_data.case_involved_by_level?.['C-Level'] || 0} (${salesforceContext.linkedin_data.case_involved_by_level?.['C-Level'] > 0 ? '⚠️ MAJOR CONCERN' : 'Good'})\n     * Sr. Level: ${salesforceContext.linkedin_data.case_involved_by_level?.['Sr. Level'] || 0} (${salesforceContext.linkedin_data.case_involved_by_level?.['Sr. Level'] > 0 ? '⚠️ SIGNIFICANT CONCERN' : 'Good'})\n     * Other: ${salesforceContext.linkedin_data.case_involved_by_level?.['Other'] || 0}\n   - Enriched profile data available: ${salesforceContext.linkedin_data.contacts_with_enriched_data || 0}\n   - Key contact insights:\n${salesforceContext.linkedin_data.contacts.map(c => {\n  const insights = [];\n  insights.push(`     * ${c.name}: ${c.current_title || 'Title unknown'} at ${c.current_company || 'Company unknown'}`);\n  if (c.department) insights.push(`       - Department: ${c.department}`);\n  if (c.reports_to_name) insights.push(`       - Reports to: ${c.reports_to_name} (hierarchy context)`);\n  if (c.owner_name) insights.push(`       - Relationship owner: ${c.owner_name}`);\n  if (c.last_activity_date) {\n    const daysSinceActivity = Math.floor((new Date() - new Date(c.last_activity_date)) / (24 * 60 * 60 * 1000));\n    insights.push(`       - Last activity: ${daysSinceActivity} days ago ${daysSinceActivity > 90 ? '(STALE - potential risk)' : ''}`);\n  }\n  if (c.job_changed_recently) insights.push(`       - ⚠️ RECENT JOB CHANGE (${c.days_in_current_role || 'unknown'} days in role - potential account risk)`);\n  if (c.job_change_likelihood && c.job_change_likelihood > 50) insights.push(`       - ⚠️ High job change likelihood: ${c.job_change_likelihood}%`);\n  if (c.company_industry) insights.push(`       - Company industry: ${c.company_industry}`);\n  if (c.company_size) insights.push(`       - Company size: ${c.company_size} employees`);\n  if (c.company_technologies && c.company_technologies.length > 0) insights.push(`       - Technologies: ${c.company_technologies.slice(0, 5).join(', ')}`);\n  if (c.previous_companies && c.previous_companies.length > 0) insights.push(`       - Previous companies: ${c.previous_companies.slice(0, 3).join(', ')}`);\n  if (c.email_status === 'verified') insights.push(`       - ✅ Verified email`);\n  if (c.email_status === 'invalid') insights.push(`       - ❌ Invalid email`);\n  return insights.join('\\n');\n}).join('\\n')}\n   - Engagement signals: ${salesforceContext.linkedin_data.contacts.reduce((sum, c) => sum + (c.engagement_with_company?.posts_about_company || 0) + (c.engagement_with_company?.comments_on_company_posts || 0) + (c.engagement_with_company?.shares_of_company_content || 0), 0)} total interactions with company content\n   - Risk indicators: ${salesforceContext.linkedin_data.contacts.filter(c => c.job_changed_recently || (c.job_change_likelihood && c.job_change_likelihood > 50)).length} contacts with job change signals\n   - Stale relationships: ${salesforceContext.linkedin_data.contacts.filter(c => {\n     if (!c.last_activity_date) return false;\n     const daysSinceActivity = Math.floor((new Date() - new Date(c.last_activity_date)) / (24 * 60 * 60 * 1000));\n     return daysSinceActivity > 90;\n   }).length} contacts with no activity in 90+ days` : ' (No contact enrichment data available)'}\n\n6. **Overall Assessment**:\n   - Customer relationship health (at-risk, stable, or thriving)\n   - Key risk factors or positive indicators\n   - Recommended actions or areas of concern\n\nProvide TWO analyses:\n\n1. **Executive Summary** (150 words max): A concise, high-level overview suitable for C-level executives. Focus on:\n   - Overall sentiment score and key takeaway\n   - Top 2-3 critical factors\n   - Immediate action required (if any)\n   - Relationship health status\n\n2. **Comprehensive Analysis** (500-800 words): A detailed, in-depth analysis for CSMs and Account Managers. Include:\n   - Detailed breakdown of all factors influencing the score\n   - Specific concerns or positive signals with examples\n   - Relationship trajectory analysis (improving, declining, stable) with evidence\n   - Contact level involvement analysis (C-Level/Sr. Level in cases is a major red flag)\n   - Support case patterns and implications\n   - Engagement metrics and their meaning\n   - Risk factors and opportunities\n   - Detailed actionable recommendations\n   - Account-specific context and nuances\n   - Comparison to account tier expectations`\n        }]\n      }],\n      systemInstruction: {\n        parts: [{\n          text: `You are an expert Customer Sentiment Analyst specializing in B2B customer relationship analysis. Your role is to provide comprehensive sentiment analysis by evaluating:\n\n1. **Conversation Analysis**: Tone, language patterns, emotional indicators, frustration levels, satisfaction signals\n2. **Support Context**: Recent support cases, their status, priority, and descriptions - these reveal underlying issues\n3. **Account Health**: Account tier, contract value, industry context - higher value accounts may have different expectations\n4. **Resolution Quality**: How effectively concerns were addressed, response time indicators, solution completeness\n5. **Relationship Trajectory**: Whether sentiment is improving, declining, or stable over time\n\nConsider the full customer journey from initial contact through resolution. Weight recent interactions more heavily but consider historical context. Account for account value and industry norms when assessing expectations.\n\nProvide scores from 1 (very negative - at risk of churn) to 10 (very positive - strong advocate) with detailed, actionable summaries that explain the reasoning and highlight key factors influencing the sentiment.`\n        }]\n      },\n      generationConfig: {\n        responseMimeType: \"application/json\",\n        responseSchema: {\n          type: \"object\",\n          properties: {\n            score: {\n              type: \"integer\",\n              description: \"Sentiment score from 1 to 10, where 1 is very negative and 10 is very positive.\"\n            },\n            summary: {\n              type: \"string\",\n              description: \"Executive summary (150 words max) - concise, high-level overview for C-level executives. Focus on overall sentiment, top 2-3 critical factors, immediate actions, and relationship health status.\"\n            },\n            comprehensiveAnalysis: {\n              type: \"string\",\n              description: \"Comprehensive analysis (500-800 words) - detailed, in-depth analysis for CSMs and Account Managers. Include detailed factor breakdown, specific concerns/positive signals with examples, relationship trajectory with evidence, contact level involvement analysis, support case patterns, engagement metrics, risk factors, opportunities, detailed recommendations, account-specific context, and comparison to account tier expectations.\"\n            }\n          },\n          required: [\"score\", \"summary\", \"comprehensiveAnalysis\"]\n        },\n        temperature: 0.7,\n        topP: 0.8,\n        topK: 40\n      }\n    };\n\n    // Retry logic with exponential backoff\n    const retryFetch = async (fetchFn, maxRetries = 3, baseDelay = 1000) => {\n      for (let attempt = 0; attempt < maxRetries; attempt++) {\n        try {\n          const response = await fetchFn();\n          \n          if (response.status === 429) {\n            const delay = baseDelay * Math.pow(2, attempt);\n            if (attempt < maxRetries - 1) {\n              await new Promise(resolve => setTimeout(resolve, delay));\n              continue;\n            }\n          }\n          \n          if (!response.ok) {\n            // Get error details from response body for better diagnostics\n            let errorDetails = '';\n            try {\n              const errorData = await response.clone().json();\n              errorDetails = errorData.error ? JSON.stringify(errorData.error) : '';\n            } catch (e) {\n              // If we can't parse JSON, get text\n              try {\n                errorDetails = await response.clone().text();\n              } catch (e2) {\n                // Ignore if we can't get error details\n              }\n            }\n            \n            const errorMessage = errorDetails \n              ? `API error: ${response.status} ${response.statusText} - ${errorDetails}`\n              : `API error: ${response.status} ${response.statusText}`;\n            \n            // Log specific errors for 403 (Forbidden) and 404 (Not Found)\n            if (response.status === 403) {\n              logError('Gemini API 403 Forbidden - Possible causes:', {\n                status: response.status,\n                statusText: response.statusText,\n                errorDetails: errorDetails,\n                model: modelName,\n                apiKeyPresent: !!apiKey,\n                apiKeyLength: apiKey ? apiKey.length : 0,\n                apiKeyPrefix: apiKey ? apiKey.substring(0, 10) + '...' : 'missing',\n              });\n            } else if (response.status === 404) {\n              logError('Gemini API 404 Not Found - Model not available:', {\n                status: response.status,\n                statusText: response.statusText,\n                errorDetails: errorDetails,\n                model: modelName,\n                suggestion: 'Try using gemini-pro, gemini-1.5-pro-latest, or gemini-flash-latest',\n              });\n            }\n            \n            throw new Error(errorMessage);\n          }\n          \n          return response;\n        } catch (error) {\n          if (attempt === maxRetries - 1) {\n            throw error;\n          }\n          const delay = baseDelay * Math.pow(2, attempt);\n          await new Promise(resolve => setTimeout(resolve, delay));\n        }\n      }\n    };\n\n    // Dynamically discover available models by querying ListModels API\n    // This is more reliable than hardcoding model names\n    async function discoverAvailableModels(apiVersion) {\n      try {\n        const listUrl = `https://generativelanguage.googleapis.com/${apiVersion}/models?key=${apiKey}`;\n        log(`Querying ListModels API for ${apiVersion} to discover available models...`);\n        \n        const response = await fetch(listUrl, {\n          method: 'GET',\n          headers: { 'Content-Type': 'application/json' }\n        });\n        \n        if (!response.ok) {\n          log(`ListModels API returned ${response.status} ${response.statusText} for ${apiVersion}`);\n          return [];\n        }\n        \n        const data = await response.json();\n        const models = data.models || [];\n        log(`ListModels API returned ${models.length} total models for ${apiVersion}`);\n        \n        // Filter for models that support generateContent method\n        const supportedModels = models\n          .filter(model => {\n            const methods = model.supportedGenerationMethods || [];\n            return methods.includes('generateContent');\n          })\n          .map(model => ({\n            name: model.name.replace('models/', ''),\n            displayName: model.displayName,\n            version: apiVersion\n          }));\n        \n        log(`Found ${supportedModels.length} models supporting generateContent in ${apiVersion}: ${supportedModels.map(m => m.name).join(', ')}`);\n        return supportedModels;\n      } catch (error) {\n        logError(`Error discovering models for ${apiVersion}:`, error);\n        return [];\n      }\n    }\n    \n    // Skip model discovery for better performance - use known fast model first\n    // gemini-flash-latest is optimized for speed and usually available\n    // Only discover if explicitly enabled via environment variable\n    // NOTE: If models fail, set SKIP_MODEL_DISCOVERY=false to discover available models\n    const SKIP_MODEL_DISCOVERY = process.env.SKIP_MODEL_DISCOVERY !== 'false'; // Default to skipping\n    let modelsToTry = [];\n    \n    if (SKIP_MODEL_DISCOVERY) {\n      // Use fast model first (flash is optimized for speed), then fallback to pro\n      // Use -latest versions as suggested by the API error messages\n      modelsToTry = [\n        { model: 'gemini-flash-latest', version: 'v1beta' }, // Fastest model - try first\n        { model: 'gemini-1.5-pro-latest', version: 'v1beta' }, // Higher quality fallback\n        { model: 'gemini-1.5-pro', version: 'v1beta' }, // Try without -latest in case it exists\n        { model: modelName, version: 'v1beta' }, // User-configured model\n        { model: 'gemini-pro', version: 'v1' }, // Legacy fallback\n      ];\n    } else {\n      // Discover available models - try v1 first (more stable), then v1beta\n      // Note: v1beta may have restricted access even if v1 works\n      let discoveredModels = [];\n      for (const version of ['v1', 'v1beta']) {\n        const models = await discoverAvailableModels(version);\n        if (models.length > 0) {\n          log(`Discovered ${models.length} available models in ${version} API`);\n          discoveredModels = models;\n          break;\n        }\n      }\n      \n      if (discoveredModels.length > 0) {\n        // Sort models: prefer flash (faster) over pro, prefer shorter names (more stable)\n        const sortedModels = discoveredModels.sort((a, b) => {\n          const aIsFlash = a.name.includes('flash');\n          const bIsFlash = b.name.includes('flash');\n          if (aIsFlash !== bIsFlash) return bIsFlash ? 1 : -1; // Prefer flash (faster)\n          const aIsPro = a.name.includes('pro');\n          const bIsPro = b.name.includes('pro');\n          if (aIsPro !== bIsPro) return bIsPro ? 1 : -1;\n          return a.name.length - b.name.length;\n        }).slice(0, 5); // Use top 5 models\n        \n        modelsToTry = sortedModels.map(m => ({ model: m.name, version: m.version }));\n        log(`Will try models in order: ${modelsToTry.map(m => `${m.model} (${m.version})`).join(', ')}`);\n      } else {\n        log('Could not discover models via API, using fallback list');\n        modelsToTry = [\n          { model: 'gemini-flash-latest', version: 'v1beta' },\n          { model: 'gemini-1.5-pro-latest', version: 'v1beta' },\n          { model: modelName, version: 'v1beta' },\n          { model: 'gemini-1.5-pro', version: 'v1beta' },\n          { model: 'gemini-pro', version: 'v1' },\n        ];\n      }\n    }\n    \n    let response = null;\n    let lastError = null;\n    let lastAttemptedModel = null;\n    \n    // Track timing for performance monitoring\n    const analysisStartTime = Date.now();\n    \n    for (const { model: tryModel, version: apiVersion } of modelsToTry) {\n      lastAttemptedModel = `${tryModel} (${apiVersion})`;\n      const modelAttemptStart = Date.now();\n      try {\n        const tryUrl = `https://generativelanguage.googleapis.com/${apiVersion}/models/${tryModel}:generateContent?key=${apiKey}`;\n        log(`Attempting Gemini model: ${tryModel} with API version: ${apiVersion} (attempt started at ${new Date().toISOString()})`);\n        \n        // Create API-version-specific request body\n        // v1 API doesn't support systemInstruction or responseMimeType/responseSchema\n        let apiRequestBody = requestBody;\n        if (apiVersion === 'v1') {\n          // For v1 API, include system instruction in the prompt and remove v1beta-only fields\n          const systemInstructionText = requestBody.systemInstruction.parts[0].text;\n          apiRequestBody = {\n            contents: [{\n              parts: [{\n                text: `${systemInstructionText}\\n\\n${requestBody.contents[0].parts[0].text}\\n\\nIMPORTANT: You must respond with RAW JSON only (no markdown, no code blocks, no backticks). Start your response with { and end with }. Format your response EXACTLY as: {\"score\": <number 1-10>, \"summary\": \"<text>\", \"comprehensiveAnalysis\": \"<text>\"}`\n              }]\n            }],\n            generationConfig: {\n              temperature: 0.7,\n              topP: 0.8,\n              topK: 40\n            }\n          };\n        }\n        \n        // Create a timeout-aware fetch function that times out per attempt\n        const fetchWithTimeout = async () => {\n          const timeoutPromise = new Promise((_, reject) => {\n            setTimeout(() => reject(new Error(`Request timeout for model ${tryModel}`)), GEMINI_API_TIMEOUT);\n          });\n          \n          const fetchPromise = fetch(tryUrl, {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n            },\n            body: JSON.stringify(apiRequestBody)\n          });\n          \n          return Promise.race([fetchPromise, timeoutPromise]);\n        };\n        \n        // Use retryFetch with timeout-aware fetch function\n        response = await retryFetch(fetchWithTimeout);\n        \n        // If we got a response and it's not 404, break out of the loop\n        if (response && response.status !== 404) {\n          const modelAttemptDuration = Date.now() - modelAttemptStart;\n          log(`Using Gemini model: ${tryModel} (${apiVersion}) - ${modelAttemptDuration}ms`);\n          lastAttemptedModel = `${tryModel} (${apiVersion})`;\n          break;\n        }\n        \n        // If 404 or 400 (invalid request), try next model\n        if (response && (response.status === 404 || response.status === 400)) {\n          continue;\n        }\n      } catch (error) {\n        lastError = error;\n        // If it's a 404 or 400, try next model\n        if (error.message && (error.message.includes('404') || error.message.includes('400'))) {\n          continue;\n        }\n        // For other errors, break and throw\n        throw error;\n      }\n    }\n    \n    // If we still don't have a response, throw the last error with helpful message\n    if (!response) {\n      const errorMessage = lastError?.message || 'All Gemini models failed.';\n      throw new Error(`${errorMessage}\n\nUnable to find a working Gemini model. Please check:\n1. Your GEMINI_API_KEY is valid and has access to Gemini models\n2. The API key has the necessary permissions\n3. Your Google Cloud project has the Generative Language API enabled\n4. Try setting GEMINI_MODEL environment variable to a specific model name\n\nTo see available models, call: https://generativelanguage.googleapis.com/v1beta/models?key=YOUR_API_KEY\n\nLast attempted models: ${modelsToTry.map(m => `${m.model} (${m.version})`).join(', ')}`);\n    }\n\n    // Check if response is ok before trying to parse JSON\n    if (!response.ok) {\n      let errorDetails = '';\n      try {\n        const errorData = await response.json();\n        errorDetails = errorData.error ? JSON.stringify(errorData.error) : JSON.stringify(errorData);\n      } catch (e) {\n        try {\n          errorDetails = await response.text();\n        } catch (e2) {\n          errorDetails = `Status: ${response.status} ${response.statusText}`;\n        }\n      }\n      \n      logError('Gemini API request failed:', {\n        status: response.status,\n        statusText: response.statusText,\n        errorDetails: errorDetails,\n        model: lastAttemptedModel || modelName,\n      });\n      \n      if (response.status === 403) {\n        return sendErrorResponse(new Error(`Gemini API access forbidden (403). Please check:\n1. Your GEMINI_API_KEY is valid and has access to Gemini models\n2. The API key has the necessary permissions\n3. Your Google Cloud project has the Generative Language API enabled\n4. The API key is not restricted to specific APIs\n\nError details: ${errorDetails}`), 403);\n      } else if (response.status === 404) {\n        return sendErrorResponse(new Error(`Gemini API model not found (404). The model '${modelName}' is not available.\n        \nPlease try one of these models by setting GEMINI_MODEL environment variable:\n- gemini-pro (most stable, recommended)\n- gemini-1.5-pro-latest\n- gemini-flash-latest\n\nTo see available models, visit: https://ai.google.dev/api/rest?version=v1beta#rest/rest/v1beta/models/list\n\nError details: ${errorDetails}`), 404);\n      }\n      \n      return sendErrorResponse(new Error(`Gemini API error: ${response.status} ${response.statusText} - ${errorDetails}`), response.status);\n    }\n\n    const data = await response.json();\n    \n    if (data.error) {\n      logError('Gemini API error:', data.error);\n      return sendErrorResponse(new Error(`Gemini API error: ${data.error.message || 'Unknown error'}`), 500);\n    }\n\n    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {\n      return sendErrorResponse(new Error('Invalid response format from Gemini API'), 500);\n    }\n\n    const content = data.candidates[0].content.parts[0].text;\n    \n    // Clean up the content: strip markdown code blocks if present\n    let cleanedContent = content.trim();\n    \n    // Remove markdown code blocks (```json ... ``` or ``` ... ```)\n    cleanedContent = cleanedContent.replace(/^```(?:json)?\\s*\\n?/i, ''); // Remove opening ```json or ```\n    cleanedContent = cleanedContent.replace(/\\n?```\\s*$/i, ''); // Remove closing ```\n    cleanedContent = cleanedContent.trim();\n    \n    // Try to extract JSON if there's extra text around it\n    // Look for JSON object boundaries { ... }\n    const jsonMatch = cleanedContent.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      cleanedContent = jsonMatch[0];\n    }\n    \n    let result;\n    try {\n      result = JSON.parse(cleanedContent);\n    } catch (parseError) {\n      logError('Failed to parse Gemini response as JSON:', {\n        originalContent: content.substring(0, 500), // Log first 500 chars for debugging\n        cleanedContent: cleanedContent.substring(0, 500),\n        parseError: parseError.message\n      });\n      throw new Error(`Failed to parse Gemini response as JSON: ${parseError.message}. Response may not be in expected format.`);\n    }\n    \n    // Validate score is within range\n    if (result.score < 1 || result.score > 10) {\n      return sendErrorResponse(new Error('Invalid sentiment score returned from API'), 500);\n    }\n    \n    // Ensure comprehensiveAnalysis exists (for backward compatibility)\n    if (!result.comprehensiveAnalysis) {\n      // If not provided, use summary as fallback\n      result.comprehensiveAnalysis = result.summary || 'Comprehensive analysis not available.';\n    }\n\n    // Save sentiment result to database for historical tracking (non-blocking)\n    if (accountId || salesforceAccountId) {\n      try {\n        const supabase = getSupabaseClient();\n        if (supabase) {\n          // Resolve account_id - check if accountId is a UUID or a Salesforce ID\n          let resolvedAccountId = accountId;\n          \n          // Check if accountId is a UUID (has dashes and is 36 chars)\n          const isUUID = accountId && accountId.includes('-') && accountId.length === 36;\n          \n          if (!isUUID) {\n            // accountId is either missing or is a Salesforce ID, so resolve it\n            const lookupId = accountId || salesforceAccountId;\n            if (lookupId) {\n              const { data: account, error: accountError } = await supabase\n                .from('accounts')\n                .select('id')\n                .eq('salesforce_id', lookupId)\n                .single();\n              \n              if (accountError) {\n                logError('Error looking up account for sentiment save:', accountError);\n                // Try alternative: check if accountId is already a UUID but without dashes check\n                if (accountId && accountId.length === 36) {\n                  resolvedAccountId = accountId; // Assume it's a UUID even without dashes\n                } else {\n                  resolvedAccountId = null;\n                }\n              } else if (account) {\n                resolvedAccountId = account.id;\n              }\n            }\n          }\n\n          if (resolvedAccountId) {\n            const insertData = {\n              account_id: resolvedAccountId,\n              salesforce_account_id: salesforceAccountId || null,\n              user_id: userId || null,\n              score: result.score,\n              summary: result.summary,\n              comprehensive_analysis: result.comprehensiveAnalysis || null,\n              has_transcription: !!transcription && transcription.length > 0,\n              transcription_length: transcription?.length || 0,\n              cases_count: salesforceContext.total_cases_count || 0,\n              avoma_calls_total: salesforceContext.total_avoma_calls || 0,\n              avoma_calls_ready: salesforceContext.ready_avoma_calls || 0,\n              customer_identifier: customerIdentifier || null,\n              input_hash: inputHash, // Store hash for future duplicate detection\n              analyzed_at: new Date().toISOString(),\n            };\n            \n            log('Saving sentiment to history:', { \n              account_id: resolvedAccountId, \n              salesforce_account_id: salesforceAccountId,\n              customer_identifier: customerIdentifier,\n              score: result.score,\n              input_hash: inputHash ? inputHash.substring(0, 16) + '...' : null,\n              analyzed_at: insertData.analyzed_at,\n            });\n            \n            const { data: inserted, error: insertError } = await supabase\n              .from('sentiment_history')\n              .insert(insertData)\n              .select()\n              .single();\n\n            if (insertError) {\n              logError('Error saving sentiment to history:', insertError);\n            } else if (inserted && inserted.id) {\n              // Include sentiment ID in response for navigation\n              result.sentimentId = inserted.id;\n            }\n          } else {\n            logError('Could not resolve account_id for sentiment save');\n          }\n        }\n      } catch (dbError) {\n        // Don't fail the request if database save fails - just log it\n        logError('Error saving sentiment to history:', dbError);\n      }\n    }\n\n    return sendSuccessResponse(result);\n  } catch (error) {\n    logError('Error in analyze-sentiment function:', error);\n    \n    // Handle timeout specifically (check for timeout in error message)\n    if (error.message && error.message.includes('Request timeout')) {\n      return sendErrorResponse(new Error('Request timeout - The Gemini API request took too long. Please try again.'), 504);\n    }\n    \n    return sendErrorResponse(error, 500);\n  }\n}\n\n"],"names":[],"mappings":"uCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,KCTA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,MAGA,GAAM,kBAAE,CAAgB,iBAAE,CAAe,YAAE,CAAU,CAAE,CAAA,EAAA,CAAA,CAAA,KAGhD,eAAe,IACpB,MAAO,CAAA,EAAA,EAAA,eAAA,AAAe,EAAC,IAAI,EAAA,WAAW,CAAC,mBAAoB,CAAE,OAAQ,SAAU,GACjF,CAGO,eAAe,EAAK,CAAO,EAChC,IAAM,EAAY,MAAM,CAAA,EAAA,EAAA,eAAe,AAAf,EAAgB,GACxC,GAAI,EAAW,OAAO,EAGtB,IAAM,EAAW,CAAA,EAAA,EAAA,WAAA,AAAW,EAAC,GAE7B,GAAI,CAAC,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,EAAU,EAAW,MAAM,CAAE,EAAW,YAAY,EACtE,CADyE,KAClE,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,AAAI,MAAM,oDAAqD,KAI1F,IAAM,EAAiB,CAAA,EAAA,EAAA,mBAAA,AAAmB,EAAC,EAAS,EAAiB,KAAK,EAC1E,GAAI,CAAC,EAAe,KAAK,CACvB,CADyB,KAClB,CAAA,EAAA,EAAA,iBAAiB,AAAjB,EAAkB,AAAI,MAAM,EAAe,KAAK,CAAC,OAAO,EAAG,EAAe,KAAK,CAAC,MAAM,EAI/F,IAAM,EAAS,QAAQ,GAAG,CAAC,cAAc,CAEzC,GAAI,CAAC,EAEH,MADA,AADW,AACX,CAAA,EAAA,EAAA,QAAQ,AAAR,EAAS,kDACF,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,AAAI,MAAM,8BAA+B,KAGpE,GAAI,CAEF,IAupBI,EAvpBE,eAAE,CAAa,mBAAE,CAAiB,QAAE,CAAM,WAAE,CAAS,qBAAE,CAAmB,oBAAE,CAAkB,cAAE,CAAY,CAAE,CADvG,EAC0G,IADpG,EAAQ,IAAI,GAM/B,SAAI,GAAyD,CAAC,EAC5D,MAAO,CAAA,EAAA,EAAA,CADa,KAA2D,QAA9C,GAC1B,AAAiB,EAAC,AAAI,MAAM,OADgB,6DACqD,KAK1G,GAA6B,UAAzB,OAAO,GAA8B,EAAc,MAAM,CAAG,IAC9D,GADqE,GAC9D,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,AAAI,MAAM,mEAAoE,KAGzG,GAAI,AAA6B,iBAAtB,GAAwD,MAAM,CAA5B,EAC3C,MAAO,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,AAAI,MAAM,gDAAiD,KAKtF,IAAM,EAAA,EAAA,CAAA,CAAA,OAIA,EAA2B,EAC7B,CAAA,EAAG,EAAc,SAAS,CAAC,EAAG,KAAM,CAAC,EAAE,EAAc,MAAM,CAAC,CAAC,EAAE,EAAc,SAAS,CAAC,KAAK,GAAG,CAAC,EAAG,EAAc,MAAM,CAAG,MAAA,CAAO,CACjI,GAGE,EAAY,EAAO,UAAU,CAAC,UACjC,MAAM,CAAC,KAAK,SAAS,CAAC,CACrB,yBAA0B,EAC1B,oBAAqB,GAAe,QAAU,EAC9C,WAAY,EAAkB,iBAAiB,EAAI,EACnD,gBAAiB,EAAkB,iBAAiB,EAAI,EACxD,gBAAiB,EAAkB,iBAAiB,EAAI,EAExD,cAAe,EAAkB,cAAc,CAAG,CAChD,cAAe,EAAkB,cAAc,CAAC,gBAAgB,EAAI,EACpE,eAAgB,EAAkB,cAAc,CAAC,iBAAiB,EAAI,CACxE,EAAI,KAIJ,eAAgB,EAAkB,cAAc,CAC9C,CAAC,EAAkB,cAAc,EAAI,EAAA,AAAE,EAAE,KAAK,CAAC,EAAG,IAAI,GAAG,CAAC,IAAM,AAAD,CAC7D,OAAQ,EAAE,MAAM,EAAI,KACpB,SAAU,EAAE,QAAQ,EAAI,KAExB,WAAY,EAAE,YAAY,CAAG,IAAI,KAAK,EAAE,YAAY,EAAE,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,CAAG,KACtF,CAAC,EACA,IAAI,CAAC,CAAC,EAAG,KAER,IAAM,EAAO,EAAE,UAAU,EAAI,GACvB,EAAO,EAAE,UAAU,EAAI,GAC7B,GAAI,IAAS,EAAM,OAAO,EAAK,aAAa,CAAC,GAC7C,IADoD,AAC9C,EAAU,EAAE,MAAM,EAAI,GADuC,AAE7D,EAAU,EAAE,MAAM,EAAI,GAC5B,GAAI,IAAY,EAAS,OAAO,EAAQ,aAAa,CAAC,GACtD,IAAM,EAAY,EAAE,QAAQ,EAAI,GAC1B,EAAY,EAAE,QAAQ,EAAI,GAChC,OAAO,EAAU,aAAa,CAAC,EACjC,GACE,IACN,IACC,MAAM,CAAC,OAGV,GAAK,CAAD,CAkGF,CAAA,EAAA,EAAA,GAAA,AAAG,EAAC,EAlGa,qDACjB,GAAI,CACF,IAAM,EAAW,CAAA,EAAA,EAAA,iBAAiB,AAAjB,IACjB,GAAI,IAAa,GAAa,CAAA,CAAmB,CAAG,CAEpD,CAFgB,GAEZ,EAAoB,KAKxB,GAFe,CAEX,EAFwB,EAAU,IAE1B,IAFkC,CAAC,MAAQ,AAAqB,OAAX,MAAM,CAIrE,EAAoB,EACpB,CAAA,EAAA,EAAA,GAAA,AAAG,EAAC,CAAC,UAAU,EAAE,EAAU,0CAA0C,CAAC,MACjE,CAEL,IAAM,EAAW,GAAa,EAC9B,GAAI,EAAU,CACZ,CAAA,EAAA,EAAA,GAAA,AAAG,EAAC,CAAC,2CAA2C,EAAE,EAAA,CAAU,EAC5D,GAAM,CAAE,KAAM,CAAO,CAAE,MAAO,CAAY,CAAE,CAAG,MAAM,EAClD,IAAI,CAAC,YACL,MAAM,CAAC,MACP,EAAE,CAAC,gBAAiB,GACpB,WAAW,GAEV,GACF,CAAA,EAAA,EAAA,MADgB,EAChB,AAAQ,EAAC,4CAA6C,GACtD,EAAoB,MACX,IACT,EAAoB,EAAQ,CADV,CACU,AAAE,CAElC,CACF,CAEA,GAAI,EAAmB,CAGrB,GAAM,CAAE,KAAM,CAAU,CAAE,MAAO,CAAe,CAAE,CAAG,MAAM,EACxD,IAAI,CAAC,qBACL,MAAM,CAAC,KACP,EAAE,CAAC,aAAc,GACjB,EAAE,CAAC,aAAc,GACjB,KAAK,CAAC,cAAe,CAAE,UAAW,EAAM,GACxC,KAAK,CAAC,GACN,WAAW,GAEd,GAAI,EACF,CAAA,EAAA,EAAA,GAAA,AAAG,EAAC,CAAC,IADc,8BACoB,EAAE,EAAgB,OAAO,CAAA,CAAE,OAC7D,GAAI,EAET,MADA,CAAA,EAAA,CADqB,CACrB,GAAA,AAAG,EAAC,CAAC,yEAAyE,EAAE,EAAW,WAAW,CAAC,iDAAiD,CAAC,EAClJ,CAAA,EAAA,EAAA,mBAAA,AAAmB,EAAC,CACzB,MAAO,EAAW,KAAK,CACvB,QAAS,EAAW,OAAO,CAC3B,sBAAuB,EAAW,sBAAsB,EAAI,EAAW,OAAO,CAC9E,QAAQ,EACR,WAAY,EAAW,WAAW,CAClC,YAAa,EAAW,EAAE,AAC5B,GAMF,IAAM,EAAe,IAAI,KAAK,KAAK,GAAG,GAAK,IAAI,IAAqB,CAAhB,KAAK,KAAK,AAAiB,GAEzE,CAAE,KAAM,CAAc,CAAE,MAAO,CAAmB,CAAE,CAAG,MAAM,EAChE,IAAI,CAAC,qBACL,MAAM,CAAC,KACP,EAAE,CAAC,aAAc,GACjB,GAAG,CAAC,cAAe,GACnB,EAAE,CAAC,uBAAwB,GAAe,QAAU,GACpD,EAAE,CAAC,cAAe,EAAkB,iBAAiB,EAAI,GACzD,EAAE,CAAC,oBAAqB,EAAkB,iBAAiB,EAAI,GAC/D,EAAE,CAAC,oBAAqB,EAAkB,iBAAiB,EAAI,GAC/D,KAAK,CAAC,cAAe,CAAE,WAAW,CAAM,GACxC,KAAK,CAAC,GACN,WAAW,GAEd,GAAI,EACF,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,IADc,oCAC2B,QAC7C,GAAI,EAET,MADA,CAAA,EAAA,EAAA,GAAG,AAAH,AADyB,EACrB,CAAC,uCAAuC,EAAE,IAAI,KAAK,EAAe,WAAW,EAAE,cAAc,GAAA,CAAI,EAC9F,CAAA,EAAA,EAAA,mBAAA,AAAmB,EAAC,CACzB,MAAO,EAAe,KAAK,CAC3B,QAAS,EAAe,OAAO,CAC/B,sBAAuB,EAAe,sBAAsB,EAAI,EAAe,OAAO,CACtF,QAAQ,EACR,WAAY,EAAe,WAAW,CACtC,YAAa,EAAe,EAAE,AAChC,EAEJ,CACA,CACF,CAAE,MAAO,EAAiB,CAExB,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,oDAAqD,EAChE,CAMF,IAAM,EAAY,QAAQ,GAAG,CAAC,YAAY,EAAI,iBAMxC,EAAc,CAClB,SAAU,CAAC,CACT,MAAO,CAAC,CACN,KAAM,CAAC;;;AAGjB,EAAE,GAAiB,+BAA+B;;;AAGlD,EAAE,KAAK,SAAS,CAAC,EAAmB,KAAM,GAAG;;;;;;;;;;;;qCAYR,EAAE,EAAkB,iBAAiB,EAAI,EAAE;;;;;;KAM3E,EAAE,EAAkB,cAAc,CAAG,CAAC;2CACA,EAAE,EAAkB,cAAc,CAAC,gBAAgB,EAAI,EAAE,EAAE,EAAE,EAAkB,cAAc,CAAC,aAAa,EAAI,EAAE;;;6CAG/G,EAAE,EAAkB,cAAc,CAAC,iBAAiB,EAAI,EAAE,EAAE,EAAE,EAAkB,cAAc,CAAC,cAAc,EAAI,EAAE;;;yCAGvH,EAAE,EAAkB,cAAc,CAAC,cAAc,EAAI,EAAE,EAAE,EAAE,EAAkB,cAAc,CAAC,WAAW,EAAI,EAAE;KACjJ,CAAC,CAAG,mCAAmC;;;;mBAIzB,EAAE,EAAkB,YAAY,EAAI,UAAU;qBAC5C,EAAE,EAAkB,cAAc,EAAI,UAAU;eACtD,EAAE,EAAkB,QAAQ,EAAI,UAAU;sBACnC,EAAE,EAAkB,eAAe,EAAI,UAAU;;;wBAG/C,EAAE,EAAkB,iBAAiB,EAAI,EAAE;wBAC3C,EAAE,EAAkB,iBAAiB,EAAI,EAAE;;kDAEjB,EAAE,EAAkB,aAAa,CAAG,CAAC;qBAClE,EAAE,EAAkB,aAAa,CAAC,cAAc,EAAI,EAAE;;gBAE3D,EAAE,EAAkB,aAAa,CAAC,oBAAoB,EAAE,CAAC,UAAU,EAAI,EAAE;kBACvE,EAAE,EAAkB,aAAa,CAAC,oBAAoB,EAAE,CAAC,YAAY,EAAI,EAAE;cAC/E,EAAE,EAAkB,aAAa,CAAC,oBAAoB,EAAE,AAAC,OAAY,CAAJ,CAAM;;gBAErE,EAAE,EAAkB,aAAa,CAAC,sBAAsB,EAAE,CAAC,UAAU,EAAI,EAAE,EAAE,EAAE,EAAkB,aAAa,CAAC,sBAAsB,EAAE,CAAC,UAAU,CAAG,EAAI,mBAAqB,OAAO;kBACnL,EAAE,EAAkB,aAAa,CAAC,sBAAsB,EAAE,CAAC,YAAY,EAAI,EAAE,EAAE,EAAE,EAAkB,aAAa,CAAC,sBAAsB,EAAE,CAAC,YAAY,CAAG,EAAI,yBAA2B,OAAO;cACnM,EAAE,EAAkB,aAAa,CAAC,sBAAsB,EAAE,AAAC,OAAY,CAAJ,CAAM;sCACjD,EAAE,EAAkB,aAAa,CAAC,2BAA2B,EAAI,EAAE;;AAEzG,EAAE,EAAkB,aAAa,CAAC,QAAQ,CAAC,GAAG,CAAC,IAC7C,IAAM,EAAW,EAAE,CAKnB,GAJA,EAAS,IAAI,CAAC,CAAC,OAAO,EAAE,EAAE,IAAI,CAAC,EAAE,EAAE,EAAE,aAAa,EAAI,gBAAgB,IAAI,EAAE,EAAE,eAAe,EAAI,kBAAA,CAAmB,EAChH,EAAE,UAAU,EAAE,EAAS,IAAI,CAAC,CAAC,qBAAqB,EAAE,EAAE,UAAU,CAAA,CAAE,EAClE,EAAE,eAAe,EAAE,EAAS,IAAI,CAAC,CAAC,qBAAqB,EAAE,EAAE,eAAe,CAAC,oBAAoB,CAAC,EAChG,EAAE,UAAU,EAAE,EAAS,IAAI,CAAC,CAAC,6BAA6B,EAAE,EAAE,UAAU,CAAA,CAAE,EAC1E,EAAE,kBAAkB,CAAE,CACxB,IAAM,EAAoB,KAAK,KAAK,CAAC,CAAC,IAAI,KAAS,IAAI,KAAK,EAAE,mBAAkB,CAAC,CAAK,GAAD,EAAM,EAC3F,EAAS,CADuF,GACnF,CAAC,CADuF,AACtF,IAD0F,oBAClE,EAAE,EAAkB,UAAU,EAAE,EAAoB,GAAK,2BAA6B,GAAA,CAAI,CACnI,CASA,OARI,EAAE,oBAAoB,EAAE,EAAS,IAAI,CAAC,CAAC,+BAA+B,EAAE,EAAE,oBAAoB,EAAI,UAAU,uCAAuC,CAAC,EACpJ,EAAE,qBAAqB,EAAI,EAAE,qBAAqB,CAAG,IAAI,EAAS,IAAI,CAAC,CAAC,wCAAwC,EAAE,EAAE,qBAAqB,CAAC,CAAC,CAAC,EAC5I,EAAE,gBAAgB,EAAE,EAAS,IAAI,CAAC,CAAC,2BAA2B,EAAE,EAAE,gBAAgB,CAAA,CAAE,EACpF,EAAE,YAAY,EAAE,EAAS,IAAI,CAAC,CAAC,uBAAuB,EAAE,EAAE,YAAY,CAAC,UAAU,CAAC,EAClF,EAAE,oBAAoB,EAAI,EAAE,oBAAoB,CAAC,MAAM,CAAG,GAAG,EAAS,IAAI,CAAC,CAAC,uBAAuB,EAAE,EAAE,oBAAoB,CAAC,KAAK,CAAC,EAAG,GAAG,IAAI,CAAC,MAAA,CAAO,EACpJ,EAAE,kBAAkB,EAAI,EAAE,kBAAkB,CAAC,MAAM,CAAG,GAAG,EAAS,IAAI,CAAC,CAAC,6BAA6B,EAAE,EAAE,kBAAkB,CAAC,KAAK,CAAC,EAAG,GAAG,IAAI,CAAC,MAAA,CAAO,EACjI,aAAnB,EAAE,YAAY,EAAiB,EAAS,IAAI,CAAC,CAAC,yBAAyB,CAAC,EACrD,YAAnB,EAAE,YAAY,EAAgB,EAAS,IAAI,CAAC,CAAC,wBAAwB,CAAC,EACnE,EAAS,IAAI,CAAC,KACvB,GAAG,IAAI,CAAC,MAAM;yBACW,EAAE,EAAkB,aAAa,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,sBAA0B,EAAE,qBAAuB,CAAC,GAAK,CAAD,CAAG,uBAAuB,EAAE,4BAA6B,CAAC,EAAK,EAAE,AAAH,uBAA0B,EAAE,4BAA6B,CAAC,CAAG,GAAG;sBAC7P,EAAE,EAAkB,aAAa,CAAC,QAAQ,CAAC,MAAM,CAAC,GAAK,EAAE,oBAAoB,EAAK,EAAE,qBAAqB,EAAI,EAAE,qBAAqB,CAAG,IAAK,MAAM,CAAC;0BAC/I,EAAE,EAAkB,aAAa,CAAC,QAAQ,CAAC,MAAM,CAAC,GACvE,CAAI,CAAC,EAAE,kBAAkB,EAAE,AACD,AACnB,KADwB,EADG,GACE,CAAC,CAAC,IAAI,KAAS,IAAI,KAAK,EAAE,mBAAkB,CAAC,CAAK,GAAD,EAAM,EAChE,GADqE,CAE/F,IAFoG,EAE9F,CAAC,CAFiG,qCAE3D,CAAC,CAAG,0CAA0C;;;;;;;;;;;;;;;;;;;;;;;;;4CAyBrD,CACpC,AADqC,EAEvC,AADI,EACF,CACF,kBAAmB,CACjB,MAAO,CAAC,CACN,KAAM,CAAC;;;;;;;;;;oNAUmM,CAAC,AAC7M,EAAE,AACJ,EACA,iBAAkB,CAChB,iBAAkB,mBAClB,eAAgB,CACd,KAAM,SACN,WAAY,CACV,MAAO,CACL,KAAM,UACN,YAAa,iFACf,EACA,QAAS,CACP,KAAM,SACN,YAAa,mMACf,EACA,sBAAuB,CACrB,KAAM,SACN,YAAa,8aACf,CACF,EACA,SAAU,CAAC,QAAS,UAAW,wBAAwB,AACzD,EACA,YAAa,GACb,KAAM,GACN,KAAM,EACR,CACF,EAGM,EAAa,MAAO,EAAS,EAAa,CAAC,CAAE,EAAY,GAAI,IACjE,IAAK,IAAI,EAAU,EAAG,EAAU,EAAY,IAC1C,GAAI,CACF,EAFmD,EAE7C,EAAW,MAAM,IAEvB,GAAwB,MAApB,EAAS,MAAM,CAAU,CAC3B,IAAM,EAAQ,EAAY,KAAK,GAAG,CAAC,EAAG,GACtC,GAAI,EAAU,EAAa,EAAG,CAC5B,MAAM,IAAI,QAAQ,GAAW,WAAW,EAAS,IACjD,QACF,CACF,CAEA,GAAI,CAAC,EAAS,EAAE,CAAE,CAEhB,IAAI,EAAe,GACnB,GAAI,CACF,IAAM,EAAY,MAAM,EAAS,KAAK,GAAG,IAAI,GAC7C,EAAe,EAAU,KAAK,CAAG,KAAK,SAAS,CAAC,EAAU,KAAK,EAAI,EACrE,CAAE,MAAO,EAAG,CAEV,GAAI,CACF,EAAe,MAAM,EAAS,KAAK,GAAG,IAAI,EAC5C,CAAE,MAAO,EAAI,CAEb,CACF,CAEA,IAAM,EAAe,EACjB,CAAC,WAAW,EAAE,EAAS,MAAM,CAAC,CAAC,EAAE,EAAS,UAAU,CAAC,GAAG,EAAE,EAAA,CAAc,CACxE,CAAC,WAAW,EAAE,EAAS,MAAM,CAAC,CAAC,EAAE,EAAS,UAAU,CAAA,CAAE,AAuB1D,OApBwB,KAAK,CAAzB,EAAS,MAAM,CACjB,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,8CAA+C,CACtD,OAAQ,EAAS,MAAM,CACvB,WAAY,EAAS,UAAU,CAC/B,aAAc,EACd,MAAO,EACP,cAAe,CAAC,CAAC,EACjB,aAAc,EAAS,EAAO,MAAM,CAAG,EACvC,aAAc,EAAS,EAAO,SAAS,CAAC,EAAG,IAAM,MAAQ,SAC3D,GAC6B,KAAK,CAAzB,EAAS,MAAM,EACxB,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,kDAAmD,CAC1D,OAAQ,EAAS,MAAM,CACvB,WAAY,EAAS,UAAU,CAC/B,aAAc,EACd,MAAO,EACP,WAAY,qEACd,GAGI,AAAI,MAAM,EAClB,CAEA,OAAO,CACT,CAAE,MAAO,EAAO,CACd,GAAI,IAAY,EAAa,EAC3B,CAD8B,KACxB,EAER,IAAM,EAAQ,EAAY,KAAK,GAAG,CAAC,EAAG,EACtC,OAAM,IAAI,QAAQ,GAAW,WAAW,EAAS,GACnD,CAEJ,EAIA,eAAe,EAAwB,CAAU,EAC/C,GAAI,CACF,IAAM,EAAU,CAAC,0CAA0C,EAAE,EAAW,YAAY,EAAE,EAAA,CAAQ,CAC9F,CAAA,EAAA,EAAA,GAAG,AAAH,EAAI,CAAC,4BAA4B,EAAE,EAAW,gCAAgC,CAAC,EAE/E,IAAM,EAAW,MAAM,MAAM,EAAS,CACpC,OAAQ,MACR,QAAS,CAAE,eAAgB,kBAAmB,CAChD,GAEA,GAAI,CAAC,EAAS,EAAE,CAEd,CAFgB,KAChB,CAAA,EAAA,EAAA,GAAA,AAAG,EAAC,CAAC,wBAAwB,EAAE,EAAS,MAAM,CAAC,CAAC,EAAE,EAAS,UAAU,CAAC,KAAK,EAAE,EAAA,CAAY,EAClF,EAAE,CAIX,IAAM,EAAS,CADF,MAAM,EAAS,IAAI,EAAA,EACZ,MAAM,EAAI,EAAE,CAChC,CAAA,EAAA,EAAA,GAAA,AAAG,EAAC,CAAC,wBAAwB,EAAE,EAAO,MAAM,CAAC,kBAAkB,EAAE,EAAA,CAAY,EAG7E,IAAM,EAAkB,EACrB,MAAM,CAAC,GAEC,CADS,EAAM,0BAA0B,EAAI,EAAA,AAAE,EACvC,QAAQ,CAAC,oBAEzB,GAAG,CAAC,IAAU,CACb,GADY,EACN,EAAM,IAAI,CAAC,OAAO,CAAC,UAAW,IACpC,YAAa,EAAM,WAAW,CAC9B,QAAS,EACX,CAAC,EAGH,MADA,CAAA,EAAA,EAAA,GAAA,AAAG,EAAC,CAAC,MAAM,EAAE,EAAgB,MAAM,CAAC,sCAAsC,EAAE,EAAW,EAAE,EAAE,EAAgB,GAAG,CAAC,GAAK,EAAE,IAAI,EAAE,IAAI,CAAC,MAAA,CAAO,EACjI,CACT,CAAE,MAAO,EAAO,CAEd,MADA,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,CAAC,6BAA6B,EAAE,EAAW,CAAC,CAAC,CAAE,GACjD,EAAE,AACX,CACF,CAMA,IAAM,EAAuB,AAAqC,SAAS,SAAtC,GAAG,CAAC,SAAwD,WAApC,CACzD,EAAc,EAAE,CAEpB,GAAI,EAGF,EAAc,CACZ,CAAE,MAAO,UAJa,YAIU,QAAS,QAAS,EAClD,CAAE,MAAO,wBAAyB,QAAS,QAAS,EACpD,CAAE,MAAO,iBAAkB,QAAS,QAAS,EAC7C,CAAE,MAAO,EAAW,QAAS,QAAS,EACtC,CAAE,MAAO,aAAc,QAAS,IAAK,EACtC,KACI,CAGL,IAAI,EAAmB,EAAE,CACzB,IAAK,IAAM,IAAW,CAAC,KAAM,SAAS,CAAE,CACtC,IAAM,EAAS,MAAM,EAAwB,GAC7C,GAAI,EAAO,MAAM,CAAG,EAAG,CACrB,CAAA,EAAA,EAAA,GAAA,AAAG,EAAC,CAAC,WAAW,EAAE,EAAO,MAAM,CAAC,qBAAqB,EAAE,EAAQ,IAAI,CAAC,EACpE,EAAmB,EACnB,KACF,CACF,CAEI,EAAiB,MAAM,CAAG,GAAG,AAY/B,EAVqB,AAUP,EAVwB,IAAI,CAAC,CAAC,EAAG,KAC7C,IAAM,EAAW,EAAE,IAAI,CAAC,QAAQ,CAAC,SAC3B,EAAW,EAAE,IAAI,CAAC,QAAQ,CAAC,SACjC,GAAI,IAAa,EAAU,OAAO,EAAW,EAAI,CAAC,EAClD,CADqD,GAC/C,EAAS,EAAE,IAAI,CAAC,QAAQ,CAAC,GAD8C,IAEvE,EAAS,EAAE,IAAI,CAAC,QAAQ,CAAC,cAC/B,AAAI,IAAW,EAAe,EAAS,EAAI,CAAC,CAArB,CAChB,EAAE,IAAI,CAAC,MAAM,CAAG,EAAE,IAAI,CAAC,MAAM,AACtC,GAAG,KAAK,CAAC,EAAG,GAEe,CAFX,EAEc,CAAC,IAAK,AAAC,CAAE,MAAO,EAAE,GAFb,CAEiB,CAAE,QAAS,EAAE,OAAO,CAAC,CAAC,EAC1E,CAAA,EAAA,EAAA,GAAA,AAAG,EAAC,CAAC,0BAA0B,EAAE,EAAY,GAAG,CAAC,GAAK,CAAA,EAAG,EAAE,KAAK,CAAC,EAAE,EAAE,EAAE,OAAO,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,MAAA,CAAO,IAE/F,CAAA,EAAA,EAAA,GAAA,AAAG,EAAC,0DACJ,EAAc,CACZ,CAAE,MAAO,sBAAuB,QAAS,QAAS,EAClD,CAAE,MAAO,wBAAyB,QAAS,QAAS,EACpD,CAAE,MAAO,EAAW,QAAS,QAAS,EACtC,CAAE,MAAO,iBAAkB,QAAS,QAAS,EAC7C,CAAE,MAAO,aAAc,QAAS,IAAK,EACtC,CAEL,CAEA,IAAI,EAAW,KACX,EAAY,KACZ,EAAqB,KAKzB,IAAK,GAAM,CAAE,MAAO,CAAQ,CAAE,QAAS,CAAU,CAAE,GAFzB,KAAK,GAAG,GAEqB,GAAa,CAClE,EAAqB,CAAA,EAAG,EAAS,EAAE,EAAE,EAAW,CAAC,CAAC,CAClD,IAAM,EAAoB,KAAK,GAAG,GAClC,GAAI,CACF,IAAM,EAAS,CAAC,0CAA0C,EAAE,EAAW,QAAQ,EAAE,EAAS,qBAAqB,EAAE,EAAA,CAAQ,CACzH,CAAA,EAAA,EAAA,GAAA,AAAG,EAAC,CAAC,yBAAyB,EAAE,EAAS,mBAAmB,EAAE,EAAW,qBAAqB,EAAE,IAAI,OAAO,WAAW,GAAG,CAAC,CAAC,EAI3H,IAAI,EAAiB,EACrB,GAAmB,OAAf,EAAqB,CAEvB,IAAM,EAAwB,EAAY,iBAAiB,CAAC,KAAK,CAAC,EAAE,CAAC,IAAI,CACzE,EAAiB,CACf,SAAU,CAAC,CACT,MAAO,CAAC,CACN,KAAM,CAAA,EAAG,sBAAsB;AAAA;AAAI,EAAE,EAAY,QAAQ,CAAC,EAAE,CAAC,KAAK,CAAC,EAAE,CAAC,IAAI,CAAC;AAAA;AAAA,wPAA4P,CAAC,AAC1U,EAAE,AACJ,EAAE,CACF,iBAAkB,CAChB,YAAa,GACb,KAAM,GACN,KAAM,EACR,CACF,CACF,CAGA,IAAM,EAAmB,UACvB,IAAM,EAAiB,IAAI,QAAQ,CAAC,EAAG,KACrC,WAAW,IAAM,EAAW,AAAJ,MAAU,CAAC,0BAA0B,EAAE,EAAA,CAAU,GAvWtD,CAuW0D,IAC/E,EAxW4B,CA0WtB,EAAe,MAAM,EAAQ,CACjC,OAAQ,OACR,QAAS,CACP,UA7WqE,KA6WrD,kBAClB,EACA,KAAM,KAAK,SAAS,CAAC,EACvB,GAEA,OAAO,QAAQ,IAAI,CAAC,CAAC,EAAc,EAAe,CACpD,EAMA,GAAI,CAHJ,EAAW,MAAM,EAAW,EAAA,GAGQ,MAApB,EAAS,MAAM,CAAU,CACvC,IAAM,EAAuB,KAAK,GAAG,GAAK,EAC1C,CAAA,EAAA,EAAA,GAAA,AAAG,EAAC,CAAC,oBAAoB,EAAE,EAAS,EAAE,EAAE,EAAW,IAAI,EAAE,EAAqB,EAAE,CAAC,EACjF,EAAqB,CAAA,EAAG,EAAS,EAAE,EAAE,EAAW,CAAC,CAAC,CAClD,KACF,CAGA,GAAI,IAAiC,MAApB,EAAD,AAAU,MAAM,EAAY,AAAoB,QAAX,MAAM,AAAK,CAAG,CACjE,EADoE,MAGxE,CAAE,MAAO,EAAO,CAGd,GAFA,EAAY,EAER,EAAM,OAAO,GAAK,CAAD,CAAO,OAAO,CAAC,QAAQ,CAAC,QAAU,EAAM,OAAO,CAAC,QAAQ,CAAC,MAAA,CAAM,CAClF,EADqF,MAIvF,OAAM,CACR,CACF,CAGA,GAAI,CAAC,EAAU,CACb,IAAM,EAAe,GAAW,SAAW,2BAC3C,OAAM,AAAI,MAAM,CAAA,EAAG,aAAa;;;;;;;;;;uBAUf,EAAE,EAAY,GAAG,CAAC,GAAK,CAAA,EAAG,EAAE,KAAK,CAAC,EAAE,EAAE,EAAE,OAAO,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,MAAA,CAAO,CACnF,CAGA,GAAI,CAAC,EAAS,EAAE,CAAE,CAChB,IAAI,EAAe,GACnB,GAAI,CACF,IAAM,EAAY,MAAM,EAAS,IAAI,GACrC,EAAe,EAAU,KAAK,CAAG,KAAK,SAAS,CAAC,EAAU,KAAK,EAAI,KAAK,SAAS,CAAC,EACpF,CAAE,MAAO,EAAG,CACV,GAAI,CACF,EAAe,MAAM,EAAS,IAAI,EACpC,CAAE,MAAO,EAAI,CACX,EAAe,CAAC,QAAQ,EAAE,EAAS,MAAM,CAAC,CAAC,EAAE,EAAS,UAAU,CAAA,CAAE,AACpE,CACF,CASA,GAPA,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,6BAA8B,CACrC,OAAQ,EAAS,MAAM,CACvB,WAAY,EAAS,UAAU,CAC/B,aAAc,EACd,MAAO,GAAsB,CAC/B,GAEwB,KAAK,CAAzB,EAAS,MAAM,CACjB,MAAO,CAAA,EAAA,EAAA,iBAAiB,AAAjB,EAAsB,AAAJ,MAAU,CAAC;;;;;;eAM7B,EAAE,EAAA,CAAc,EAAG,KACrB,GAAwB,KAAK,CAAzB,EAAS,MAAM,CACxB,MAAO,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAK,AAAJ,MAAU,CAAC,6CAA6C,EAAE,EAAU;;;;;;;;;eAStF,EAAE,EAAA,CAAc,EAAG,KAG5B,MAAO,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,AAAI,MAAM,CAAC,kBAAkB,EAAE,EAAS,MAAM,CAAC,CAAC,EAAE,EAAS,UAAU,CAAC,GAAG,EAAE,EAAA,CAAc,EAAG,EAAS,MAAM,CACtI,CAEA,IAAM,EAAO,MAAM,EAAS,IAAI,GAEhC,GAAI,EAAK,KAAK,CAEZ,CAFc,KACd,CAAA,EAAA,EAAA,QAAQ,AAAR,EAAS,oBAAqB,EAAK,KAAK,EACjC,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,AAAI,MAAM,CAAC,kBAAkB,EAAE,EAAK,KAAK,CAAC,OAAO,EAAI,gBAAA,CAAiB,EAAG,KAGpG,GAAI,CAAC,EAAK,UAAU,EAAI,CAAC,EAAK,UAAU,CAAC,EAAE,EAAI,CAAC,EAAK,UAAU,CAAC,EAAE,CAAC,OAAO,CACxE,CAD0E,KACnE,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,AAAI,MAAM,2CAA4C,KAGjF,IAAM,EAAU,EAAK,UAAU,CAAC,EAAE,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE,CAAC,IAAI,CAGpD,EAAiB,EAAQ,IAAI,GAS3B,EAJN,AAIkB,GALlB,AACiB,GADA,CADjB,EAAiB,EAAe,OAAO,CAAC,uBAAwB,GAAA,EAChC,CADqC,MAC9B,CAAC,cAAe,GAAA,EACvB,CAD4B,GACxB,EAAA,AAFiE,EAMpE,KAAK,CAAC,QAL0C,OAM7E,IACF,EAAiB,CAAS,CAAC,EAAA,AAAE,CADhB,CAKf,GAAI,CACF,EAAS,KAAK,KAAK,CAAC,EACtB,CAAE,MAAO,EAAY,CAMnB,KALA,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,2CAA4C,CACnD,gBAAiB,EAAQ,SAAS,CAAC,EAAG,KACtC,eAAgB,EAAe,SAAS,CAAC,EAAG,KAC5C,WAAY,EAAW,OAAO,AAChC,GACM,AAAI,MAAM,CAAC,yCAAyC,EAAE,EAAW,OAAO,CAAC,yCAAyC,CAAC,CAC3H,CAGA,GAAI,EAAO,KAAK,CAAG,GAAK,EAAO,KAAK,CAAG,GACrC,CADyC,KAClC,CAAA,EAAA,EAAA,iBAAiB,AAAjB,EAAkB,AAAI,MAAM,6CAA8C,KAUnF,GANI,AAAC,EAAO,qBAAqB,EAAE,CAEjC,EAAO,qBAAqB,CAAG,EAAO,OAAO,EAAI,uCAAA,EAI/C,GAAa,EACf,GAAI,CACF,IAAM,EAAW,CAAA,EAAA,EAAA,IAFiB,aAEjB,AAAiB,IAClC,GAAI,EAAU,CAEZ,IAAI,EAAoB,EAKxB,GAAI,CAAC,CAFU,GAAa,EAAU,QAAQ,CAAC,MAA6B,KAArB,EAAU,MAAW,AAAL,EAE1D,CAEX,IAAM,EAAW,GAAa,EAC9B,GAAI,EAAU,CACZ,GAAM,CAAE,KAAM,CAAO,CAAE,MAAO,CAAY,CAAE,CAAG,MAAM,EAClD,IAAI,CAAC,YACL,MAAM,CAAC,MACP,EAAE,CAAC,gBAAiB,GACpB,MAAM,GAEL,GACF,CAAA,EAAA,EAAA,MADgB,EAChB,AAAQ,EAAC,+CAAgD,GAGvD,EADE,GAAkC,IAAI,CAAzB,EAAU,MAAM,CACX,EAEA,MAEb,GAJwB,AAKjC,GAAoB,EAAQ,CADV,CACU,AAAE,CAElC,CACF,CAEA,GAAI,EAAmB,CACrB,IAAM,EAAa,CACjB,WAAY,EACZ,KAb4E,iBAarD,GAAuB,KAC9C,QAAS,GAAU,KACnB,MAAO,EAAO,KAAK,CACnB,QAAS,EAAO,OAAO,CACvB,uBAAwB,EAAO,qBAAqB,EAAI,KACxD,kBAAmB,CAAC,CAAC,GAAiB,EAAc,MAAM,CAAG,EAC7D,qBAAsB,GAAe,QAAU,EAC/C,YAAa,EAAkB,iBAAiB,EAAI,EACpD,kBAAmB,EAAkB,iBAAiB,EAAI,EAC1D,kBAAmB,EAAkB,iBAAiB,EAAI,EAC1D,oBAAqB,GAAsB,KAC3C,WAAY,EACZ,YAAa,IAAI,OAAO,WAAW,EACrC,EAEA,CAAA,EAAA,EAAA,GAAA,AAAG,EAAC,+BAAgC,CAClC,WAAY,EACZ,sBAAuB,EACvB,oBAAqB,EACrB,MAAO,EAAO,KAAK,CACnB,WAAY,EAAY,EAAU,SAAS,CAAC,EAAG,IAAM,MAAQ,KAC7D,YAAa,EAAW,WAAW,AACrC,GAEA,GAAM,CAAE,KAAM,CAAQ,CAAE,MAAO,CAAW,CAAE,CAAG,MAAM,EAClD,IAAI,CAAC,qBACL,MAAM,CAAC,GACP,MAAM,GACN,MAAM,GAEL,EACF,CAAA,EAAA,EAAA,MADe,EACf,AAAQ,EAAC,qCAAsC,GACtC,GAAY,EAAS,EAAE,EAAE,CAElC,EAAO,WAAW,CAAG,EAAS,EAAA,AAAE,CAEpC,KACE,CAAA,CADK,CACL,EAAA,QAAA,AAAQ,EAAC,kDAEb,CACF,CAAE,MAAO,EAAS,CAEhB,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,qCAAsC,EACjD,CAGF,MAAO,CAAA,EAAA,EAAA,mBAAmB,AAAnB,EAAoB,EAC7B,CAAE,MAAO,EAAO,CAId,GAHA,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,uCAAwC,GAG7C,EAAM,OAAO,EAAI,EAAM,OAAO,CAAC,QAAQ,CAAC,mBAC1C,CAD8D,KACvD,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,AAAI,MAAM,6EAA8E,KAGnH,MAAO,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,EAAO,IAClC,CACF,2CD3yBA,IAAA,EAAA,EAAA,CAAA,CAAA,OAIA,IAAM,EAAc,IAAI,EAAA,mBAAmB,CAAC,CACxC,WAAY,CACR,KAAM,EAAA,SAAS,CAAC,SAAS,CACzB,KAAM,+BACN,SAAU,yBACV,SAAU,QACV,WAAY,EAChB,EACA,QAAS,CAAA,OACT,IADiD,eACc,CAA3C,EACpB,iBAAkB,mDAClB,iBAZqB,GAarB,SAAA,CACJ,GAIM,kBAAE,CAAgB,sBAAE,CAAoB,aAAE,CAAW,CAAE,CAAG,EAChE,SAAS,IACL,MAAO,CAAA,EAAA,EAAA,UAAA,AAAW,EAAC,CACf,wCACA,CACJ,EACJ,CAEO,eAAe,EAAQ,CAAG,CAAE,CAAG,CAAE,CAAG,EACnC,EAAY,KAAK,EAAE,AACnB,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,EAAK,+BAAgC,QAAQ,MAAM,CAAC,MAAM,IAE7E,IAAI,EAAU,+BAKV,EAAU,EAAQ,OAAO,CAAC,WAAY,KAAO,IAMjD,IAAM,EAAgB,MAAM,EAAY,OAAO,CAAC,EAAK,EAAK,CACtD,UACA,mBAHE,CAAA,CAIN,GACA,GAAI,CAAC,EAID,OAHA,EAAI,IADY,MACF,CAAG,IACjB,EAAI,GAAG,CAAC,eACS,MAAjB,CAAwB,CAApB,IAAyB,KAAhB,EAAoB,EAAI,SAAS,CAAC,IAAI,CAAC,EAAK,QAAQ,OAAO,IACjE,KAEX,GAAM,SAAE,CAAO,QAAE,CAAM,YAAE,CAAU,CAAE,WAAS,aAAE,CAAW,mBAAE,CAAiB,qBAAE,CAAmB,sBAAE,CAAoB,yBAAE,CAAuB,kBAAE,CAAgB,yBAAE,CAAuB,uBAAE,CAAqB,CAAE,CAAG,EACnN,EAAoB,CAAA,EAAA,EAAA,gBAAA,AAAgB,EAAC,GACvC,GAAQ,EAAQ,EAAkB,aAAa,CAAC,EAAkB,EAAI,EAAkB,MAAM,CAAC,EAAA,AAAiB,EAC9G,EAAY,WAEa,MAAvB,EAA8B,KAAK,EAAI,EAAoB,SAAS,AAAT,EAC3D,AADsE,MAChE,EAAoB,SAAS,CAAC,EAAK,EAAK,GAAW,GAEzD,EAAI,GAAG,CAAC,gCAEL,MAEX,GAAI,GAAS,CAAC,EAAa,CACvB,IAAM,GAAgB,CAAQ,EAAkB,MAAM,CAAC,EAAiB,CAClE,EAAgB,EAAkB,aAAa,CAAC,EAAkB,CACxE,GAAI,GAC+B,KAA3B,EAAc,KADH,GACW,EAAc,CAAC,EAAe,CACpD,GAAI,EAAW,YAAY,CAAC,WAAW,CACnC,CADqC,MAC9B,MAAM,GAEjB,OAAM,IAAI,EAAA,eAAe,AAC7B,CAER,CACA,IAAI,EAAW,MACX,GAAU,EAAY,IAAb,CAAkB,EAAK,EAAD,CAG/B,GAAW,AAAa,OAHqB,KAC7C,EAAW,CAAA,EAEwB,IAAM,CAAA,EAE7C,IAAM,GACgB,IAAtB,EAAY,EAAkB,GAAb,EAEjB,CAAC,EAKK,EAAqB,GAAS,CAAC,EAIjC,GAAyB,GACzB,CAAA,EAAA,EAAA,iBADkD,aAClD,AAA8B,EAAC,CAC3B,KAAM,IAbqF,sBAc3F,wBACA,EACA,gBAAiB,CAAA,EAAA,EAAA,qBAAA,AAAqB,EAAC,uBACnC,CACJ,EACJ,GAEJ,IAAM,EAAS,EAAI,MAAM,EAAI,MACvB,EAAS,CAAA,EAAA,EAAA,SAAA,AAAS,IAClB,EAAa,EAAO,kBAAkB,GACtC,EAAU,QACZ,EACA,oBACA,WAAY,CACR,aAAc,CACV,gBAAgB,CAAQ,EAAW,YAAY,CAAC,cAAc,AAClE,EACA,iBAAiB,CAAQ,EAAW,eAAe,yBACnD,EACA,iBAAkB,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,EAAK,oBACtC,kBAAmB,EAAW,SAAS,CACvC,UAAW,EAAI,SAAS,CACxB,QAAS,AAAC,IACN,EAAI,EAAE,CAAC,QAAS,EACpB,EACA,sBAAkB,EAClB,8BAA+B,CAAC,EAAO,EAAU,IAAe,EAAY,cAAc,CAAC,EAAK,EAAO,EAAc,EACzH,EACA,cAAe,SACX,CACJ,CACJ,EACM,EAAc,IAAI,EAAA,eAAe,CAAC,GAClC,EAAc,IAAI,EAAA,gBAAgB,CAAC,GACnC,EAAU,EAAA,kBAAkB,CAAC,mBAAmB,CAAC,EAAa,CAAA,EAAA,EAAA,sBAAsB,AAAtB,EAAuB,IAC3F,GAAI,CACA,IAAM,EAAoB,MAAO,GACtB,EAAY,MAAM,CAAC,EAAS,GAAS,OAAO,CAAC,KAChD,GAAI,CAAC,EAAM,OACX,EAAK,aAAa,CAAC,CACf,mBAAoB,EAAI,UAAU,CAClC,YAAY,CAChB,GACA,IAAM,EAAqB,EAAO,qBAAqB,GAEvD,GAAI,CAAC,EACD,OAEJ,GAAI,EAAmB,GAAG,CAAC,EAHF,kBAGwB,EAAA,cAAc,CAAC,aAAa,CAAE,YAC3E,QAAQ,IAAI,CAAC,CAAC,2BAA2B,EAAE,EAAmB,GAAG,CAAC,kBAAkB,qEAAqE,CAAC,EAG9J,IAAM,EAAQ,EAAmB,GAAG,CAAC,cACrC,GAAI,EAAO,CACP,IAAM,EAAO,CAAA,EAAG,EAAO,CAAC,EAAE,EAAA,CAAO,CACjC,EAAK,aAAa,CAAC,CACf,aAAc,EACd,aAAc,EACd,iBAAkB,CACtB,GACA,EAAK,UAAU,CAAC,EACpB,MACI,CADG,CACE,UAAU,CAAC,CAAA,EAAG,EAAO,CAAC,EAAE,EAAA,CAAS,CAE9C,GAEE,GAAgB,CAAoC,CAAA,EAAA,EAAA,EAA5B,YAA4B,AAAc,EAAC,EAAK,eACxE,EAAiB,MAAO,QACtB,EA2FI,EA1FR,IAAM,EAAoB,MAAO,oBAAE,CAAkB,CAAE,IACnD,GAAI,CACA,GAAI,CAAC,GAAiB,GAAwB,GAA2B,CAAC,EAKtE,OAJA,EAAI,SADsF,CAC5E,CAAG,IAEjB,EAAI,SAAS,CAAC,iBAAkB,eAChC,EAAI,GAAG,CAAC,gCACD,KAEX,IAAM,EAAW,MAAM,EAAkB,GACzC,EAAI,YAAY,CAAG,EAAQ,UAAU,CAAC,YAAY,CAClD,IAAI,EAAmB,EAAQ,UAAU,CAAC,gBAAgB,CAGtD,GACI,EAAI,SAAS,EAAE,CACf,CAFc,CAEV,SAAS,CAAC,GACd,OAAmB,GAG3B,IAAM,EAAY,EAAQ,UAAU,CAAC,aAAa,CAGlD,IAAI,EA6BA,OADA,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,EAAC,EAAa,EAAa,EAAU,EAAQ,UAAU,CAAC,gBAAgB,EACnF,IA7BA,EACP,IAAM,EAAO,MAAM,EAAS,IAAI,GAE1B,EAAU,CAAA,EAAA,EAAA,yBAAA,AAAyB,EAAC,EAAS,OAAO,CACtD,IACA,EAAO,CAAC,EAAA,EADG,oBACmB,CAAC,CAAG,CAAA,EAElC,CAAC,CAAO,CAAC,eAAe,EAAI,EAAK,IAAI,EAAE,CACvC,CAAO,CAAC,eAAe,CAAG,EAAK,IAAA,AAAI,EAEvC,IAAM,EAAa,KAAkD,IAA3C,EAAQ,UAAU,CAAC,mBAAmB,IAAoB,EAAQ,UAAU,CAAC,mBAAmB,EAAI,EAAA,cAAc,AAAd,GAAyB,AAAR,EAAgB,UAAU,CAAC,mBAAmB,CACvL,EAAS,KAA8C,IAAvC,EAAQ,UAAU,CAAC,eAAe,EAAoB,EAAQ,UAAU,CAAC,eAAe,EAAI,EAAA,cAAc,MAAG,EAAY,EAAQ,UAAU,CAAC,eAAe,CAcjL,MAZmB,CAYZ,AAXH,MAAO,CACH,KAAM,EAAA,eAAe,CAAC,SAAS,CAC/B,OAAQ,EAAS,MAAM,CACvB,KAAM,OAAO,IAAI,CAAC,MAAM,EAAK,WAAW,YACxC,CACJ,EACA,aAAc,YACV,SACA,CACJ,CACJ,CAEJ,CAKJ,CAAE,KALS,CAKF,EAAK,CAcV,MAX0B,MAAtB,EAA6B,KAAK,EAAI,EAAmB,OAAA,AAAO,EAAE,CAClE,MAAM,EAAY,cAAc,CAAC,EAAK,EAAK,CACvC,WAAY,aACZ,UAAW,EACX,UAAW,QACX,iBAAkB,CAAA,EAAA,EAAA,mBAAmB,AAAnB,EAAoB,oBAClC,uBACA,CACJ,EACJ,EAAG,GAED,CACV,CACJ,EACM,EAAa,MAAM,EAAY,cAAc,CAAC,KAChD,aACA,WACA,EACA,UAAW,EAAA,SAAS,CAAC,SAAS,CAC9B,YAAY,oBACZ,EACA,kBAAmB,GACnB,+CACA,oBACA,EACA,UAAW,EAAI,SAAS,eACxB,CACJ,GAEA,GAAI,CAAC,EACD,KADQ,EACD,KAEX,GAAI,CAAe,MAAd,CAAqB,EAAmD,AAA1C,GAAJ,IAAK,EAAoB,EAAW,KAAA,AAAK,EAAY,KAAK,EAAI,EAAkB,IAAI,IAAM,EAAA,eAAe,CAAC,SAAS,CAE9I,CAFgJ,KAE1I,OAAO,cAAc,CAAK,AAAJ,MAAU,CAAC,kDAAkD,EAAgB,MAAd,CAAqB,EAAS,AAA2C,GAA/C,GAAK,GAAqB,EAAW,KAAA,AAAK,EAAY,KAAK,EAAI,EAAmB,IAAI,CAAA,CAAE,EAAG,oBAAqB,CACjO,MAAO,OACP,YAAY,EACZ,cAAc,CAClB,EAEA,CAAC,GACD,EAAI,SAAS,CADG,AACF,iBAAkB,EAAuB,cAAgB,EAAW,MAAM,CAAG,OAAS,EAAW,OAAO,CAAG,QAAU,OAGnI,GACA,EAAI,QADS,CACA,CAAC,gBAAiB,2DAEnC,IAAM,EAAU,CAAA,EAAA,EAAA,2BAAA,AAA2B,EAAC,EAAW,KAAK,CAAC,OAAO,EAcpE,OAbI,AAAE,CAAD,EAAkB,GACnB,EAAQ,AADgB,GAAG,GACb,CAAC,EAAA,sBAAsB,EAIrC,GAAW,YAAY,EAAK,EAAD,AAAK,SAAS,CAAC,kBAAqB,EAAD,AAAS,GAAG,CAAC,kBAAkB,AAC7F,EAAQ,GAAG,CAAC,gBAAiB,CAAA,EAAA,EAAA,qBAAqB,AAArB,EAAsB,EAAW,YAAY,GAE9E,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,EAAC,EAAa,EAChC,IAAI,SAAS,EAAW,KAAK,CAAC,IAAI,CAAE,SAChC,EACA,OAAQ,EAAW,KAAK,CAAC,MAAM,EAAI,GACvC,IACO,IACX,EAGI,EACA,MAAM,EAAe,EADT,CAGZ,MAAM,EAAO,qBAAqB,CAAC,EAAI,OAAO,CAAE,IAAI,EAAO,KAAK,CAAC,EAAA,cAAc,CAAC,aAAa,CAAE,CACvF,SAAU,CAAA,EAAG,EAAO,CAAC,EAAE,EAAA,CAAS,CAChC,KAAM,EAAA,QAAQ,CAAC,MAAM,CACrB,WAAY,CACR,cAAe,EACf,cAAe,EAAI,GAAG,AAC1B,CACJ,EAAG,GAEf,CAAE,MAAO,EAAK,CAcV,GAbM,AAAF,CAAC,YAAgB,EAAA,eAAe,EAChC,CADmC,KAC7B,EAAY,cAAc,CAAC,EAAK,EAAK,CACvC,WAAY,aACZ,UAAW,EACX,UAAW,QACX,iBAAkB,CAAA,EAAA,EAAA,mBAAA,AAAmB,EAAC,oBAClC,uBACA,CACJ,EACJ,GAIA,EAAO,MAAM,EAKjB,OAHA,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,EAAC,EAAa,EAAa,IAAI,SAAS,KAAM,CAC5D,OAAQ,GACZ,IACO,IACX,CACJ,EAEA,qCAAqC","ignoreList":[0]}