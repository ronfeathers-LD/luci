{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/ron.feathers/GitHub/LUCI/src/lib/supabase-server.js"],"sourcesContent":["/**\n * Server-side Supabase Client for Next.js\n * Uses the same logic as lib/supabase-client.js but as ES module\n */\n\nexport function getSupabaseClient() {\n  try {\n    const { createClient } = require('@supabase/supabase-js');\n    const supabaseUrl = process.env.SUPABASE_URL;\n    const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n    \n    if (!supabaseUrl || !supabaseServiceKey) {\n      const missing = [];\n      if (!supabaseUrl) missing.push('SUPABASE_URL');\n      if (!supabaseServiceKey) missing.push('SUPABASE_SERVICE_ROLE_KEY');\n      console.error(`[Supabase] Missing environment variables: ${missing.join(', ')}`);\n      return null;\n    }\n    \n    return createClient(supabaseUrl, supabaseServiceKey, {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false\n      }\n    });\n  } catch (error) {\n    console.error('[Supabase] Error creating client:', error.message);\n    if (error.stack) {\n      console.error('[Supabase] Stack:', error.stack);\n    }\n    return null;\n  }\n}\n\nexport function validateSupabase(supabase) {\n  if (!supabase) {\n    return {\n      valid: false,\n      error: { status: 503, message: 'Database not configured' }\n    };\n  }\n  return { valid: true };\n}\n\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;AAEM,SAAS;IACd,IAAI;QACF,MAAM,EAAE,YAAY,EAAE;QACtB,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY;QAC5C,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;QAEhE,IAAI,CAAC,eAAe,CAAC,oBAAoB;YACvC,MAAM,UAAU,EAAE;YAClB,IAAI,CAAC,aAAa,QAAQ,IAAI,CAAC;YAC/B,IAAI,CAAC,oBAAoB,QAAQ,IAAI,CAAC;YACtC,QAAQ,KAAK,CAAC,CAAC,0CAA0C,EAAE,QAAQ,IAAI,CAAC,OAAO;YAC/E,OAAO;QACT;QAEA,OAAO,aAAa,aAAa,oBAAoB;YACnD,MAAM;gBACJ,kBAAkB;gBAClB,gBAAgB;YAClB;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC,MAAM,OAAO;QAChE,IAAI,MAAM,KAAK,EAAE;YACf,QAAQ,KAAK,CAAC,qBAAqB,MAAM,KAAK;QAChD;QACA,OAAO;IACT;AACF;AAEO,SAAS,iBAAiB,QAAQ;IACvC,IAAI,CAAC,UAAU;QACb,OAAO;YACL,OAAO;YACP,OAAO;gBAAE,QAAQ;gBAAK,SAAS;YAA0B;QAC3D;IACF;IACA,OAAO;QAAE,OAAO;IAAK;AACvB"}},
    {"offset": {"line": 98, "column": 0}, "map": {"version":3,"sources":["file:///Users/ron.feathers/GitHub/LUCI/lib/constants.js"],"sourcesContent":["/**\n * Shared Constants\n * \n * Centralized constants used across the application\n */\n\n// Request limits\nconst MAX_REQUEST_SIZE = {\n  DEFAULT: 1024 * 1024, // 1MB\n  LARGE: 10 * 1024 * 1024, // 10MB (for sentiment analysis)\n};\n\n// Timeouts\nconst REQUEST_TIMEOUT = 30000; // 30 seconds\n\n// Rate limiting\nconst RATE_LIMIT = {\n  WINDOW: 60 * 1000, // 1 minute\n  MAX_REQUESTS: 10, // 10 requests per minute per IP\n};\n\n// Cache TTL (in hours, except CALENDAR_EVENTS which is in minutes)\nconst CACHE_TTL = {\n  ACCOUNTS: 1, // 1 hour\n  CASES: 1, // 1 hour\n  CONTACTS: 24, // 24 hours\n  TRANSCRIPTIONS: 24, // 24 hours\n  LINKEDIN_PROFILES: 24, // 24 hours\n  CALENDAR_EVENTS: 15, // 15 minutes (calendar events change frequently)\n};\n\n// API Limits\nconst API_LIMITS = {\n  CASES_PER_ACCOUNT: 25,\n  CONTACTS_PER_ACCOUNT: 100,\n  ACCOUNTS_PER_USER: 1000,\n};\n\nmodule.exports = {\n  MAX_REQUEST_SIZE,\n  REQUEST_TIMEOUT,\n  RATE_LIMIT,\n  CACHE_TTL,\n  API_LIMITS,\n};\n\n"],"names":[],"mappings":"AAAA;;;;CAIC,GAED,iBAAiB;AACjB,MAAM,mBAAmB;IACvB,SAAS,OAAO;IAChB,OAAO,KAAK,OAAO;AACrB;AAEA,WAAW;AACX,MAAM,kBAAkB,OAAO,aAAa;AAE5C,gBAAgB;AAChB,MAAM,aAAa;IACjB,QAAQ,KAAK;IACb,cAAc;AAChB;AAEA,mEAAmE;AACnE,MAAM,YAAY;IAChB,UAAU;IACV,OAAO;IACP,UAAU;IACV,gBAAgB;IAChB,mBAAmB;IACnB,iBAAiB;AACnB;AAEA,aAAa;AACb,MAAM,aAAa;IACjB,mBAAmB;IACnB,sBAAsB;IACtB,mBAAmB;AACrB;AAEA,OAAO,OAAO,GAAG;IACf;IACA;IACA;IACA;IACA;AACF"}},
    {"offset": {"line": 139, "column": 0}, "map": {"version":3,"sources":["file:///Users/ron.feathers/GitHub/LUCI/lib/api-helpers.js"],"sourcesContent":["/**\n * Shared API Helper Functions\n * \n * Common utilities for Vercel serverless functions\n */\n\nconst { MAX_REQUEST_SIZE, REQUEST_TIMEOUT } = require('./constants');\n\n/**\n * Set standard CORS headers\n */\nfunction setCORSHeaders(res, methods = ['GET', 'POST', 'OPTIONS']) {\n  res.setHeader('Access-Control-Allow-Origin', '*');\n  res.setHeader('Access-Control-Allow-Methods', methods.join(', '));\n  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');\n}\n\n/**\n * Handle preflight OPTIONS requests\n */\nfunction handlePreflight(req, res) {\n  if (req.method === 'OPTIONS') {\n    setCORSHeaders(res);\n    return res.status(200).end();\n  }\n  return false;\n}\n\n/**\n * Validate request size\n */\nfunction validateRequestSize(req, maxSize = MAX_REQUEST_SIZE.DEFAULT) {\n  const contentLength = req.headers['content-length'];\n  if (contentLength && parseInt(contentLength) > maxSize) {\n    return {\n      valid: false,\n      error: {\n        status: 413,\n        message: 'Request too large',\n      },\n    };\n  }\n  return { valid: true };\n}\n\n/**\n * Sanitize error message for production\n */\nfunction sanitizeError(error, isProduction = false) {\n  if (isProduction) {\n    // In production, don't expose internal error details\n    return {\n      error: 'An error occurred',\n      message: 'Please try again later or contact support if the problem persists.',\n    };\n  }\n  \n  // In development, return full error details\n  return {\n    error: error.message || 'An error occurred',\n    message: error.message,\n    stack: error.stack,\n  };\n}\n\n/**\n * Standard error response\n */\nfunction sendErrorResponse(res, error, statusCode = 500, isProduction = false) {\n  setCORSHeaders(res);\n  const sanitized = sanitizeError(error, isProduction);\n  return res.status(statusCode).json(sanitized);\n}\n\n/**\n * Standard success response\n */\nfunction sendSuccessResponse(res, data, statusCode = 200) {\n  setCORSHeaders(res);\n  return res.status(statusCode).json(data);\n}\n\n/**\n * Get client IP address from request\n */\nfunction getClientIP(req) {\n  return req.headers['x-forwarded-for']?.split(',')[0] || \n         req.headers['x-real-ip'] || \n         req.connection?.remoteAddress || \n         'unknown';\n}\n\n/**\n * Validate Supabase client and return error response if invalid\n * \n * @param {Object|null} supabase - Supabase client instance\n * @param {Object} res - Express response object\n * @returns {boolean} True if valid, false if invalid (response already sent)\n */\nfunction validateSupabase(supabase, res) {\n  if (!supabase) {\n    sendErrorResponse(res, new Error('Database not configured'), 503, isProduction());\n    return false;\n  }\n  return true;\n}\n\n/**\n * Check if environment is production\n */\nfunction isProduction() {\n  return process.env.NODE_ENV === 'production';\n}\n\n/**\n * Structured logging with levels\n */\nfunction formatLog(level, message) {\n  const timestamp = new Date().toISOString();\n  return `[${timestamp}] [${level.toUpperCase()}] ${message}`;\n}\n\n/**\n * Info log (only in non-production)\n */\nfunction log(message, data = null) {\n  if (!isProduction()) {\n    if (data) {\n      console.log(formatLog('info', message), data);\n    } else {\n      console.log(formatLog('info', message));\n    }\n  }\n}\n\n/**\n * Error log (always logs, even in production)\n */\nfunction logError(message, error = null) {\n  if (error) {\n    console.error(formatLog('error', message), error);\n  } else {\n    console.error(formatLog('error', message));\n  }\n}\n\n/**\n * Warning log (only in non-production)\n */\nfunction logWarn(message, data = null) {\n  if (!isProduction()) {\n    if (data) {\n      console.warn(formatLog('warn', message), data);\n    } else {\n      console.warn(formatLog('warn', message));\n    }\n  }\n}\n\n/**\n * Debug log (only in non-production, for verbose debugging)\n */\nfunction logDebug(message, data = null) {\n  if (!isProduction() && process.env.DEBUG === 'true') {\n    if (data) {\n      console.log(formatLog('debug', message), data);\n    } else {\n      console.log(formatLog('debug', message));\n    }\n  }\n}\n\n/**\n * Simple in-memory rate limiter\n * For production, use Redis or similar distributed store\n */\nconst rateLimitStore = new Map();\n\nfunction checkRateLimit(ip, windowMs, maxRequests) {\n  const now = Date.now();\n  const key = ip;\n  \n  if (!rateLimitStore.has(key)) {\n    rateLimitStore.set(key, { count: 1, resetTime: now + windowMs });\n    return true;\n  }\n  \n  const record = rateLimitStore.get(key);\n  \n  // Reset if window expired\n  if (now > record.resetTime) {\n    record.count = 1;\n    record.resetTime = now + windowMs;\n    return true;\n  }\n  \n  // Check if limit exceeded\n  if (record.count >= maxRequests) {\n    return false;\n  }\n  \n  record.count++;\n  return true;\n}\n\n// Clean up old entries periodically\nconst { RATE_LIMIT } = require('./constants');\nsetInterval(() => {\n  const now = Date.now();\n  for (const [key, record] of rateLimitStore.entries()) {\n    if (now > record.resetTime) {\n      rateLimitStore.delete(key);\n    }\n  }\n}, RATE_LIMIT.WINDOW);\n\nmodule.exports = {\n  setCORSHeaders,\n  handlePreflight,\n  validateRequestSize,\n  sanitizeError,\n  sendErrorResponse,\n  sendSuccessResponse,\n  getClientIP,\n  validateSupabase,\n  checkRateLimit,\n  isProduction,\n  log,\n  logError,\n  logWarn,\n  logDebug,\n};\n\n"],"names":[],"mappings":"AAAA;;;;CAIC,GAED,MAAM,EAAE,gBAAgB,EAAE,eAAe,EAAE;AAE3C;;CAEC,GACD,SAAS,eAAe,GAAG,EAAE,UAAU;IAAC;IAAO;IAAQ;CAAU;IAC/D,IAAI,SAAS,CAAC,+BAA+B;IAC7C,IAAI,SAAS,CAAC,gCAAgC,QAAQ,IAAI,CAAC;IAC3D,IAAI,SAAS,CAAC,gCAAgC;AAChD;AAEA;;CAEC,GACD,SAAS,gBAAgB,GAAG,EAAE,GAAG;IAC/B,IAAI,IAAI,MAAM,KAAK,WAAW;QAC5B,eAAe;QACf,OAAO,IAAI,MAAM,CAAC,KAAK,GAAG;IAC5B;IACA,OAAO;AACT;AAEA;;CAEC,GACD,SAAS,oBAAoB,GAAG,EAAE,UAAU,iBAAiB,OAAO;IAClE,MAAM,gBAAgB,IAAI,OAAO,CAAC,iBAAiB;IACnD,IAAI,iBAAiB,SAAS,iBAAiB,SAAS;QACtD,OAAO;YACL,OAAO;YACP,OAAO;gBACL,QAAQ;gBACR,SAAS;YACX;QACF;IACF;IACA,OAAO;QAAE,OAAO;IAAK;AACvB;AAEA;;CAEC,GACD,SAAS,cAAc,KAAK,EAAE,eAAe,KAAK;IAChD,IAAI,cAAc;QAChB,qDAAqD;QACrD,OAAO;YACL,OAAO;YACP,SAAS;QACX;IACF;IAEA,4CAA4C;IAC5C,OAAO;QACL,OAAO,MAAM,OAAO,IAAI;QACxB,SAAS,MAAM,OAAO;QACtB,OAAO,MAAM,KAAK;IACpB;AACF;AAEA;;CAEC,GACD,SAAS,kBAAkB,GAAG,EAAE,KAAK,EAAE,aAAa,GAAG,EAAE,eAAe,KAAK;IAC3E,eAAe;IACf,MAAM,YAAY,cAAc,OAAO;IACvC,OAAO,IAAI,MAAM,CAAC,YAAY,IAAI,CAAC;AACrC;AAEA;;CAEC,GACD,SAAS,oBAAoB,GAAG,EAAE,IAAI,EAAE,aAAa,GAAG;IACtD,eAAe;IACf,OAAO,IAAI,MAAM,CAAC,YAAY,IAAI,CAAC;AACrC;AAEA;;CAEC,GACD,SAAS,YAAY,GAAG;IACtB,OAAO,IAAI,OAAO,CAAC,kBAAkB,EAAE,MAAM,IAAI,CAAC,EAAE,IAC7C,IAAI,OAAO,CAAC,YAAY,IACxB,IAAI,UAAU,EAAE,iBAChB;AACT;AAEA;;;;;;CAMC,GACD,SAAS,iBAAiB,QAAQ,EAAE,GAAG;IACrC,IAAI,CAAC,UAAU;QACb,kBAAkB,KAAK,IAAI,MAAM,4BAA4B,KAAK;QAClE,OAAO;IACT;IACA,OAAO;AACT;AAEA;;CAEC,GACD,SAAS;IACP,OAAO,oDAAyB;AAClC;AAEA;;CAEC,GACD,SAAS,UAAU,KAAK,EAAE,OAAO;IAC/B,MAAM,YAAY,IAAI,OAAO,WAAW;IACxC,OAAO,CAAC,CAAC,EAAE,UAAU,GAAG,EAAE,MAAM,WAAW,GAAG,EAAE,EAAE,SAAS;AAC7D;AAEA;;CAEC,GACD,SAAS,IAAI,OAAO,EAAE,OAAO,IAAI;IAC/B,IAAI,CAAC,gBAAgB;QACnB,IAAI,MAAM;YACR,QAAQ,GAAG,CAAC,UAAU,QAAQ,UAAU;QAC1C,OAAO;YACL,QAAQ,GAAG,CAAC,UAAU,QAAQ;QAChC;IACF;AACF;AAEA;;CAEC,GACD,SAAS,SAAS,OAAO,EAAE,QAAQ,IAAI;IACrC,IAAI,OAAO;QACT,QAAQ,KAAK,CAAC,UAAU,SAAS,UAAU;IAC7C,OAAO;QACL,QAAQ,KAAK,CAAC,UAAU,SAAS;IACnC;AACF;AAEA;;CAEC,GACD,SAAS,QAAQ,OAAO,EAAE,OAAO,IAAI;IACnC,IAAI,CAAC,gBAAgB;QACnB,IAAI,MAAM;YACR,QAAQ,IAAI,CAAC,UAAU,QAAQ,UAAU;QAC3C,OAAO;YACL,QAAQ,IAAI,CAAC,UAAU,QAAQ;QACjC;IACF;AACF;AAEA;;CAEC,GACD,SAAS,SAAS,OAAO,EAAE,OAAO,IAAI;IACpC,IAAI,CAAC,kBAAkB,QAAQ,GAAG,CAAC,KAAK,KAAK,QAAQ;QACnD,IAAI,MAAM;YACR,QAAQ,GAAG,CAAC,UAAU,SAAS,UAAU;QAC3C,OAAO;YACL,QAAQ,GAAG,CAAC,UAAU,SAAS;QACjC;IACF;AACF;AAEA;;;CAGC,GACD,MAAM,iBAAiB,IAAI;AAE3B,SAAS,eAAe,EAAE,EAAE,QAAQ,EAAE,WAAW;IAC/C,MAAM,MAAM,KAAK,GAAG;IACpB,MAAM,MAAM;IAEZ,IAAI,CAAC,eAAe,GAAG,CAAC,MAAM;QAC5B,eAAe,GAAG,CAAC,KAAK;YAAE,OAAO;YAAG,WAAW,MAAM;QAAS;QAC9D,OAAO;IACT;IAEA,MAAM,SAAS,eAAe,GAAG,CAAC;IAElC,0BAA0B;IAC1B,IAAI,MAAM,OAAO,SAAS,EAAE;QAC1B,OAAO,KAAK,GAAG;QACf,OAAO,SAAS,GAAG,MAAM;QACzB,OAAO;IACT;IAEA,0BAA0B;IAC1B,IAAI,OAAO,KAAK,IAAI,aAAa;QAC/B,OAAO;IACT;IAEA,OAAO,KAAK;IACZ,OAAO;AACT;AAEA,oCAAoC;AACpC,MAAM,EAAE,UAAU,EAAE;AACpB,YAAY;IACV,MAAM,MAAM,KAAK,GAAG;IACpB,KAAK,MAAM,CAAC,KAAK,OAAO,IAAI,eAAe,OAAO,GAAI;QACpD,IAAI,MAAM,OAAO,SAAS,EAAE;YAC1B,eAAe,MAAM,CAAC;QACxB;IACF;AACF,GAAG,WAAW,MAAM;AAEpB,OAAO,OAAO,GAAG;IACf;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;AACF"}},
    {"offset": {"line": 340, "column": 0}, "map": {"version":3,"sources":["file:///Users/ron.feathers/GitHub/LUCI/src/lib/next-api-helpers.js"],"sourcesContent":["/**\n * Next.js API Route Helper Functions\n * \n * Adapters for existing lib/api-helpers.js to work with Next.js\n * Can use require() for existing helpers\n */\n\nimport { NextResponse } from 'next/server';\n\n// Import existing helpers (they work in Next.js via require)\n// From src/lib/next-api-helpers.js -> up to src/ -> up to root/ -> lib/\nconst apiHelpers = require('../../lib/api-helpers');\nconst { MAX_REQUEST_SIZE, REQUEST_TIMEOUT, RATE_LIMIT } = require('../../lib/constants');\n\n/**\n * Set CORS headers for Next.js Response\n */\nexport function setCORSHeaders(response, methods = ['GET', 'POST', 'OPTIONS']) {\n  response.headers.set('Access-Control-Allow-Origin', '*');\n  response.headers.set('Access-Control-Allow-Methods', methods.join(', '));\n  response.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');\n  return response;\n}\n\n/**\n * Handle preflight OPTIONS requests for Next.js\n */\nexport async function handlePreflight(request) {\n  if (request.method === 'OPTIONS') {\n    const response = new NextResponse(null, { status: 200 });\n    return setCORSHeaders(response);\n  }\n  return null;\n}\n\n/**\n * Validate request size for Next.js\n */\nexport function validateRequestSize(request, maxSize = MAX_REQUEST_SIZE.DEFAULT) {\n  const contentLength = request.headers.get('content-length');\n  if (contentLength && parseInt(contentLength) > maxSize) {\n    return {\n      valid: false,\n      error: {\n        status: 413,\n        message: 'Request too large',\n      },\n    };\n  }\n  return { valid: true };\n}\n\n/**\n * Send error response for Next.js\n */\nexport function sendErrorResponse(error, statusCode = 500) {\n  const isProd = apiHelpers.isProduction();\n  const sanitized = {\n    error: isProd ? 'An error occurred' : (error?.message || 'An error occurred'),\n    message: isProd ? 'Please try again later or contact support if the problem persists.' : (error?.message || 'An error occurred'),\n  };\n  \n  if (!isProd && error?.stack) {\n    sanitized.stack = error.stack;\n  }\n  \n  const response = NextResponse.json(sanitized, { status: statusCode });\n  return setCORSHeaders(response);\n}\n\n/**\n * Send success response for Next.js\n */\nexport function sendSuccessResponse(data, statusCode = 200) {\n  const response = NextResponse.json(data, { status: statusCode });\n  return setCORSHeaders(response);\n}\n\n/**\n * Get client IP from Next.js Request\n */\nexport function getClientIP(request) {\n  const forwarded = request.headers.get('x-forwarded-for');\n  if (forwarded) {\n    return forwarded.split(',')[0].trim();\n  }\n  return request.headers.get('x-real-ip') || 'unknown';\n}\n\n/**\n * Validate Supabase client for Next.js\n */\nexport function validateSupabase(supabase) {\n  if (!supabase) {\n    return {\n      valid: false,\n      error: { status: 503, message: 'Database not configured' }\n    };\n  }\n  return { valid: true };\n}\n\n/**\n * Check rate limit\n */\nexport function checkRateLimit(ip, windowMs, maxRequests) {\n  return apiHelpers.checkRateLimit(ip, windowMs, maxRequests);\n}\n\n// Re-export other helpers\nexport const log = apiHelpers.log;\nexport const logError = apiHelpers.logError;\nexport const logWarn = apiHelpers.logWarn;\nexport const logDebug = apiHelpers.logDebug;\nexport const isProduction = apiHelpers.isProduction;\n\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAED;;AAEA,6DAA6D;AAC7D,wEAAwE;AACxE,MAAM;AACN,MAAM,EAAE,gBAAgB,EAAE,eAAe,EAAE,UAAU,EAAE;AAKhD,SAAS,eAAe,QAAQ,EAAE,UAAU;IAAC;IAAO;IAAQ;CAAU;IAC3E,SAAS,OAAO,CAAC,GAAG,CAAC,+BAA+B;IACpD,SAAS,OAAO,CAAC,GAAG,CAAC,gCAAgC,QAAQ,IAAI,CAAC;IAClE,SAAS,OAAO,CAAC,GAAG,CAAC,gCAAgC;IACrD,OAAO;AACT;AAKO,eAAe,gBAAgB,OAAO;IAC3C,IAAI,QAAQ,MAAM,KAAK,WAAW;QAChC,MAAM,WAAW,IAAI,gJAAY,CAAC,MAAM;YAAE,QAAQ;QAAI;QACtD,OAAO,eAAe;IACxB;IACA,OAAO;AACT;AAKO,SAAS,oBAAoB,OAAO,EAAE,UAAU,iBAAiB,OAAO;IAC7E,MAAM,gBAAgB,QAAQ,OAAO,CAAC,GAAG,CAAC;IAC1C,IAAI,iBAAiB,SAAS,iBAAiB,SAAS;QACtD,OAAO;YACL,OAAO;YACP,OAAO;gBACL,QAAQ;gBACR,SAAS;YACX;QACF;IACF;IACA,OAAO;QAAE,OAAO;IAAK;AACvB;AAKO,SAAS,kBAAkB,KAAK,EAAE,aAAa,GAAG;IACvD,MAAM,SAAS,WAAW,YAAY;IACtC,MAAM,YAAY;QAChB,OAAO,SAAS,sBAAuB,OAAO,WAAW;QACzD,SAAS,SAAS,uEAAwE,OAAO,WAAW;IAC9G;IAEA,IAAI,CAAC,UAAU,OAAO,OAAO;QAC3B,UAAU,KAAK,GAAG,MAAM,KAAK;IAC/B;IAEA,MAAM,WAAW,gJAAY,CAAC,IAAI,CAAC,WAAW;QAAE,QAAQ;IAAW;IACnE,OAAO,eAAe;AACxB;AAKO,SAAS,oBAAoB,IAAI,EAAE,aAAa,GAAG;IACxD,MAAM,WAAW,gJAAY,CAAC,IAAI,CAAC,MAAM;QAAE,QAAQ;IAAW;IAC9D,OAAO,eAAe;AACxB;AAKO,SAAS,YAAY,OAAO;IACjC,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC;IACtC,IAAI,WAAW;QACb,OAAO,UAAU,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI;IACrC;IACA,OAAO,QAAQ,OAAO,CAAC,GAAG,CAAC,gBAAgB;AAC7C;AAKO,SAAS,iBAAiB,QAAQ;IACvC,IAAI,CAAC,UAAU;QACb,OAAO;YACL,OAAO;YACP,OAAO;gBAAE,QAAQ;gBAAK,SAAS;YAA0B;QAC3D;IACF;IACA,OAAO;QAAE,OAAO;IAAK;AACvB;AAKO,SAAS,eAAe,EAAE,EAAE,QAAQ,EAAE,WAAW;IACtD,OAAO,WAAW,cAAc,CAAC,IAAI,UAAU;AACjD;AAGO,MAAM,MAAM,WAAW,GAAG;AAC1B,MAAM,WAAW,WAAW,QAAQ;AACpC,MAAM,UAAU,WAAW,OAAO;AAClC,MAAM,WAAW,WAAW,QAAQ;AACpC,MAAM,eAAe,WAAW,YAAY"}},
    {"offset": {"line": 466, "column": 0}, "map": {"version":3,"sources":["file:///Users/ron.feathers/GitHub/LUCI/src/app/api/sentiment-analysis/route.js"],"sourcesContent":["/**\n * Next.js App Router API Route for Sentiment Analysis Data\n * \n * Returns sentiment history for a given account, with optional filtering\n * OR returns a single sentiment analysis by ID\n * Supports both single account view and admin \"all analyses\" view\n */\n\nimport { NextRequest } from 'next/server';\nimport { getSupabaseClient, validateSupabase } from '../../../lib/supabase-server';\nimport { sendErrorResponse, sendSuccessResponse } from '../../../lib/next-api-helpers';\n\n// Can use require for lib files in Next.js API routes\nconst { log, logError, isProduction } = require('../../../../lib/api-helpers');\n\n// Handle OPTIONS preflight\nexport async function OPTIONS() {\n  const response = new Response(null, { status: 200 });\n  response.headers.set('Access-Control-Allow-Origin', '*');\n  response.headers.set('Access-Control-Allow-Methods', 'GET, OPTIONS');\n  response.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization');\n  return response;\n}\n\n// GET /api/sentiment-analysis\nexport async function GET(request) {\n  try {\n    const supabase = getSupabaseClient();\n    const validation = validateSupabase(supabase);\n    \n    if (!validation.valid) {\n      return sendErrorResponse(new Error(validation.error.message), validation.error.status);\n    }\n\n    const { searchParams } = new URL(request.url);\n    const id = searchParams.get('id');\n    const accountId = searchParams.get('accountId');\n    const salesforceAccountId = searchParams.get('salesforceAccountId');\n    const limit = searchParams.get('limit') || '50';\n    const offset = searchParams.get('offset') || '0';\n    const days = searchParams.get('days') || '365';\n    const all = searchParams.get('all');\n    const cached = searchParams.get('cached');\n    \n    // SINGLE ANALYSIS BY ID\n    if (id) {\n      const { data: analysis, error } = await supabase\n        .from('sentiment_history')\n        .select(`\n          *,\n          accounts:account_id (\n            id,\n            name,\n            salesforce_id\n          ),\n          users:user_id (\n            id,\n            email,\n            name\n          )\n        `)\n        .eq('id', id)\n        .single();\n\n      if (error) {\n        if (error.code === 'PGRST116') {\n          return sendErrorResponse(new Error('Sentiment analysis not found'), 404);\n        }\n        logError('Error fetching sentiment analysis:', error);\n        return sendErrorResponse(new Error(`Failed to fetch sentiment analysis: ${error.message}`), 500);\n      }\n\n      if (!analysis) {\n        return sendErrorResponse(new Error('Sentiment analysis not found'), 404);\n      }\n\n      return sendSuccessResponse({\n        analysis: analysis,\n      });\n    }\n\n    // HISTORY/ANALYSES LIST\n    const isAdminView = all === 'true';\n\n    // Calculate date filter\n    const daysAgo = new Date();\n    daysAgo.setDate(daysAgo.getDate() - parseInt(days));\n\n    if (isAdminView) {\n      // ADMIN VIEW: All analyses across all accounts\n      let query = supabase\n        .from('sentiment_history')\n        .select(`\n          *,\n          accounts:account_id (\n            id,\n            name,\n            salesforce_id\n          ),\n          users:user_id (\n            id,\n            email,\n            name\n          )\n        `)\n        .gte('analyzed_at', daysAgo.toISOString())\n        .order('analyzed_at', { ascending: false });\n\n      if (accountId) {\n        query = query.eq('account_id', accountId);\n      }\n\n      if (cached === 'true') {\n        query = query.not('input_hash', 'is', null);\n      }\n\n      query = query.range(parseInt(offset), parseInt(offset) + parseInt(limit) - 1);\n\n      let countQuery = supabase\n        .from('sentiment_history')\n        .select('id', { count: 'exact', head: true })\n        .gte('analyzed_at', daysAgo.toISOString());\n\n      if (accountId) {\n        countQuery = countQuery.eq('account_id', accountId);\n      }\n\n      if (cached === 'true') {\n        countQuery = countQuery.not('input_hash', 'is', null);\n      }\n\n      const [queryResult, countResult] = await Promise.all([\n        query,\n        countQuery\n      ]);\n\n      const { data: analyses, error } = queryResult;\n      \n      if (error) {\n        logError('Error fetching all analyses', error);\n        return sendErrorResponse(new Error(`Failed to fetch analyses: ${error.message}`), 500);\n      }\n      \n      if (analyses && analyses.length > 0) {\n        log(`Fetched ${analyses.length} analyses`);\n      }\n\n      const { count, error: countError } = countResult;\n\n      if (countError) {\n        logError('Error counting analyses', countError);\n      }\n\n      const stats = {\n        total: count || analyses?.length || 0,\n        cached: 0,\n        unique: 0,\n        averageScore: 0,\n        byScore: {\n          high: 0,\n          medium: 0,\n          low: 0,\n        },\n      };\n\n      if (analyses && analyses.length > 0) {\n        stats.cached = analyses.filter(a => a.input_hash).length;\n        const uniqueHashes = new Set(analyses.filter(a => a.input_hash).map(a => a.input_hash));\n        stats.unique = uniqueHashes.size;\n        const scores = analyses.map(a => a.score);\n        stats.averageScore = scores.reduce((a, b) => a + b, 0) / scores.length;\n        scores.forEach(score => {\n          if (score >= 8) stats.byScore.high++;\n          else if (score >= 5) stats.byScore.medium++;\n          else stats.byScore.low++;\n        });\n      }\n\n      return sendSuccessResponse({\n        analyses: analyses || [],\n        stats,\n        pagination: {\n          limit: parseInt(limit),\n          offset: parseInt(offset),\n          total: count || analyses?.length || 0,\n        },\n      });\n\n    } else {\n      // SINGLE ACCOUNT VIEW\n      if (!accountId && !salesforceAccountId) {\n        return sendErrorResponse(new Error('Missing required parameter: accountId or salesforceAccountId'), 400);\n      }\n\n      let resolvedAccountId = accountId;\n      const isUUID = accountId && accountId.includes('-') && accountId.length === 36;\n      \n      if (!isUUID) {\n        const lookupId = accountId || salesforceAccountId;\n        if (lookupId) {\n          const { data: account, error: accountError } = await supabase\n            .from('accounts')\n            .select('id')\n            .eq('salesforce_id', lookupId)\n            .single();\n          \n          if (accountError || !account) {\n            logError('Account lookup error:', accountError);\n            return sendErrorResponse(new Error('Account not found'), 404);\n          }\n          \n          resolvedAccountId = account.id;\n        }\n      }\n      \n      if (!resolvedAccountId) {\n        return sendErrorResponse(new Error('Could not resolve account ID'), 400);\n      }\n\n      let query = supabase\n        .from('sentiment_history')\n        .select('*')\n        .eq('account_id', resolvedAccountId)\n        .gte('analyzed_at', daysAgo.toISOString())\n        .order('analyzed_at', { ascending: false })\n        .limit(parseInt(limit));\n\n      const { data: history, error } = await query;\n\n      if (error) {\n        logError('Error fetching sentiment history:', error);\n        return sendErrorResponse(new Error(`Failed to fetch sentiment history: ${error.message}`), 500);\n      }\n\n      const stats = {\n        total: history?.length || 0,\n        average: 0,\n        min: 10,\n        max: 1,\n        trend: 'stable',\n        recentAverage: 0,\n        previousAverage: 0,\n      };\n\n      if (history && history.length > 0) {\n        const scores = history.map(h => h.score);\n        stats.average = scores.reduce((a, b) => a + b, 0) / scores.length;\n        stats.min = Math.min(...scores);\n        stats.max = Math.max(...scores);\n\n        if (history.length >= 10) {\n          const recent = history.slice(0, 5);\n          const previous = history.slice(5, 10);\n          stats.recentAverage = recent.reduce((a, b) => a + b.score, 0) / recent.length;\n          stats.previousAverage = previous.reduce((a, b) => a + b.score, 0) / previous.length;\n          \n          const diff = stats.recentAverage - stats.previousAverage;\n          if (diff > 0.5) {\n            stats.trend = 'improving';\n          } else if (diff < -0.5) {\n            stats.trend = 'declining';\n          }\n        } else if (history.length >= 5) {\n          const recent = history.slice(0, 3);\n          const previous = history.slice(3, 5);\n          stats.recentAverage = recent.reduce((a, b) => a + b.score, 0) / recent.length;\n          stats.previousAverage = previous.reduce((a, b) => a + b.score, 0) / previous.length;\n          \n          const diff = stats.recentAverage - stats.previousAverage;\n          if (diff > 0.5) {\n            stats.trend = 'improving';\n          } else if (diff < -0.5) {\n            stats.trend = 'declining';\n          }\n        }\n      }\n\n      return sendSuccessResponse({\n        history: history || [],\n        stats,\n      });\n    }\n\n  } catch (error) {\n    logError('Error in sentiment-analysis function:', error);\n    return sendErrorResponse(error, 500);\n  }\n}\n\n"],"names":[],"mappings":"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"}}]
}