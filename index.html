<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="L.U.C.I. - LeanData Unified Customer Intelligence. Analyze customer sentiment from Avoma transcripts and Salesforce context using AI-powered sentiment analysis">
  <meta name="keywords" content="customer sentiment, sentiment analysis, customer experience, Avoma, Salesforce">
  <meta name="author" content="LeanData">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="L.U.C.I. - LeanData Unified Customer Intelligence">
  <meta property="og:description" content="AI-powered customer sentiment analysis from Avoma transcripts and Salesforce context">
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="L.U.C.I. - LeanData Unified Customer Intelligence">
  <meta name="twitter:description" content="AI-powered customer sentiment analysis">
  
  <title>L.U.C.I. - LeanData Unified Customer Intelligence</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">
  <style>*,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/*! tailwindcss v3.4.18 | MIT License | https://tailwindcss.com*/*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}:after,:before{--tw-content:""}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}@media (min-width:1536px){.container{max-width:1536px}}.static{position:static}.relative{position:relative}.mx-2{margin-left:.5rem;margin-right:.5rem}.mx-auto{margin-left:auto;margin-right:auto}.mb-1{margin-bottom:.25rem}.mb-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.ml-2{margin-left:.5rem}.ml-3{margin-left:.75rem}.ml-7{margin-left:1.75rem}.mr-3{margin-right:.75rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mt-8{margin-top:2rem}.line-clamp-1{-webkit-line-clamp:1}.line-clamp-1,.line-clamp-2{overflow:hidden;display:-webkit-box;-webkit-box-orient:vertical}.line-clamp-2{-webkit-line-clamp:2}.block{display:block}.flex{display:flex}.grid{display:grid}.h-12{height:3rem}.h-3{height:.75rem}.h-4{height:1rem}.h-5{height:1.25rem}.h-6{height:1.5rem}.h-full{height:100%}.max-h-60{max-height:15rem}.max-h-64{max-height:16rem}.max-h-96{max-height:24rem}.min-h-screen{min-height:100vh}.w-12{width:3rem}.w-3{width:.75rem}.w-4{width:1rem}.w-5{width:1.25rem}.w-6{width:1.5rem}.w-full{width:100%}.min-w-0{min-width:0}.min-w-\[140px\]{min-width:140px}.max-w-4xl{max-width:56rem}.max-w-6xl{max-width:72rem}.max-w-md{max-width:28rem}.max-w-none{max-width:none}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.origin-top-left{transform-origin:top left}.-rotate-45{--tw-rotate:-45deg}.-rotate-45,.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.animate-spin{animation:spin 1s linear infinite}.list-inside{list-style-position:inside}.list-disc{list-style-type:disc}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-end{align-items:flex-end}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:.25rem}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.gap-x-3{-moz-column-gap:.75rem;column-gap:.75rem}.gap-x-4{-moz-column-gap:1rem;column-gap:1rem}.gap-y-1{row-gap:.25rem}.gap-y-2{row-gap:.5rem}.space-y-1>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.25rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.25rem*var(--tw-space-y-reverse))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem*var(--tw-space-y-reverse))}.space-y-3>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.75rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.75rem*var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem*var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem*var(--tw-space-y-reverse))}.overflow-y-auto{overflow-y:auto}.whitespace-nowrap{white-space:nowrap}.whitespace-pre-wrap{white-space:pre-wrap}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.rounded-md{border-radius:.375rem}.rounded-xl{border-radius:.75rem}.rounded-t{border-top-left-radius:.25rem;border-top-right-radius:.25rem}.border{border-width:1px}.border-2{border-width:2px}.border-l-4{border-left-width:4px}.border-t{border-top-width:1px}.border-blue-200{--tw-border-opacity:1;border-color:rgb(191 219 254/var(--tw-border-opacity,1))}.border-blue-500{--tw-border-opacity:1;border-color:rgb(59 130 246/var(--tw-border-opacity,1))}.border-gray-100{--tw-border-opacity:1;border-color:rgb(243 244 246/var(--tw-border-opacity,1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity,1))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219/var(--tw-border-opacity,1))}.border-green-200{--tw-border-opacity:1;border-color:rgb(187 247 208/var(--tw-border-opacity,1))}.border-green-500{--tw-border-opacity:1;border-color:rgb(34 197 94/var(--tw-border-opacity,1))}.border-purple-500{--tw-border-opacity:1;border-color:rgb(168 85 247/var(--tw-border-opacity,1))}.border-red-200{--tw-border-opacity:1;border-color:rgb(254 202 202/var(--tw-border-opacity,1))}.border-red-500{--tw-border-opacity:1;border-color:rgb(239 68 68/var(--tw-border-opacity,1))}.border-yellow-200{--tw-border-opacity:1;border-color:rgb(254 240 138/var(--tw-border-opacity,1))}.border-yellow-400{--tw-border-opacity:1;border-color:rgb(250 204 21/var(--tw-border-opacity,1))}.border-yellow-500{--tw-border-opacity:1;border-color:rgb(234 179 8/var(--tw-border-opacity,1))}.bg-blue-100{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.bg-blue-50{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity,1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity,1))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity,1))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231/var(--tw-bg-opacity,1))}.bg-green-50{--tw-bg-opacity:1;background-color:rgb(240 253 244/var(--tw-bg-opacity,1))}.bg-purple-50{--tw-bg-opacity:1;background-color:rgb(250 245 255/var(--tw-bg-opacity,1))}.bg-red-100{--tw-bg-opacity:1;background-color:rgb(254 226 226/var(--tw-bg-opacity,1))}.bg-red-50{--tw-bg-opacity:1;background-color:rgb(254 242 242/var(--tw-bg-opacity,1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.bg-yellow-100{--tw-bg-opacity:1;background-color:rgb(254 249 195/var(--tw-bg-opacity,1))}.bg-yellow-50{--tw-bg-opacity:1;background-color:rgb(254 252 232/var(--tw-bg-opacity,1))}.bg-gradient-to-br{background-image:linear-gradient(to bottom right,var(--tw-gradient-stops))}.from-blue-50{--tw-gradient-from:#eff6ff var(--tw-gradient-from-position);--tw-gradient-to:rgba(239,246,255,0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to)}.to-indigo-100{--tw-gradient-to:#e0e7ff var(--tw-gradient-to-position)}.p-2{padding:.5rem}.p-3{padding:.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.px-8{padding-left:2rem;padding-right:2rem}.py-0\.5{padding-top:.125rem;padding-bottom:.125rem}.py-12{padding-top:3rem;padding-bottom:3rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-8{padding-top:2rem;padding-bottom:2rem}.pr-2{padding-right:.5rem}.pt-2{padding-top:.5rem}.pt-4{padding-top:1rem}.pt-6{padding-top:1.5rem}.text-center{text-align:center}.text-right{text-align:right}.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-6xl{font-size:3.75rem;line-height:1}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.italic{font-style:italic}.leading-relaxed{line-height:1.625}.tracking-wide{letter-spacing:.025em}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246/var(--tw-text-opacity,1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1))}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216/var(--tw-text-opacity,1))}.text-blue-800{--tw-text-opacity:1;color:rgb(30 64 175/var(--tw-text-opacity,1))}.text-blue-900{--tw-text-opacity:1;color:rgb(30 58 138/var(--tw-text-opacity,1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity,1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity,1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity,1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity,1))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity,1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74/var(--tw-text-opacity,1))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52/var(--tw-text-opacity,1))}.text-red-400{--tw-text-opacity:1;color:rgb(248 113 113/var(--tw-text-opacity,1))}.text-red-500{--tw-text-opacity:1;color:rgb(239 68 68/var(--tw-text-opacity,1))}.text-red-600{--tw-text-opacity:1;color:rgb(220 38 38/var(--tw-text-opacity,1))}.text-red-700{--tw-text-opacity:1;color:rgb(185 28 28/var(--tw-text-opacity,1))}.text-red-800{--tw-text-opacity:1;color:rgb(153 27 27/var(--tw-text-opacity,1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.text-yellow-400{--tw-text-opacity:1;color:rgb(250 204 21/var(--tw-text-opacity,1))}.text-yellow-600{--tw-text-opacity:1;color:rgb(202 138 4/var(--tw-text-opacity,1))}.text-yellow-700{--tw-text-opacity:1;color:rgb(161 98 7/var(--tw-text-opacity,1))}.underline{text-decoration-line:underline}.shadow-lg{--tw-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color),0 4px 6px -4px var(--tw-shadow-color)}.shadow-lg,.shadow-md{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-md{--tw-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color),0 2px 4px -2px var(--tw-shadow-color)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgba(0,0,0,.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color)}.shadow-sm,.shadow-xl{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 8px 10px -6px rgba(0,0,0,.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color),0 8px 10px -6px var(--tw-shadow-color)}.outline-none{outline:2px solid transparent;outline-offset:2px}.outline{outline-style:solid}.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}@keyframes spin{to{transform:rotate(1turn)}}.animate-spin{animation:spin 1s linear infinite}.hover\:border-blue-300:hover{--tw-border-opacity:1;border-color:rgb(147 197 253/var(--tw-border-opacity,1))}.hover\:bg-blue-100:hover{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.hover\:bg-blue-50:hover{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216/var(--tw-bg-opacity,1))}.hover\:bg-gray-100:hover{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity,1))}.hover\:bg-gray-50:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity,1))}.hover\:text-blue-800:hover{--tw-text-opacity:1;color:rgb(30 64 175/var(--tw-text-opacity,1))}.hover\:text-blue-900:hover{--tw-text-opacity:1;color:rgb(30 58 138/var(--tw-text-opacity,1))}.hover\:text-gray-600:hover{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity,1))}.hover\:text-gray-700:hover{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.hover\:text-gray-900:hover{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity,1))}.hover\:text-red-800:hover{--tw-text-opacity:1;color:rgb(153 27 27/var(--tw-text-opacity,1))}.hover\:text-red-900:hover{--tw-text-opacity:1;color:rgb(127 29 29/var(--tw-text-opacity,1))}.hover\:underline:hover{text-decoration-line:underline}.hover\:opacity-80:hover{opacity:.8}.focus\:border-blue-500:focus{--tw-border-opacity:1;border-color:rgb(59 130 246/var(--tw-border-opacity,1))}.focus\:border-transparent:focus{border-color:transparent}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.focus\:ring-2:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow,0 0 #0000)}.focus\:ring-blue-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(59 130 246/var(--tw-ring-opacity,1))}.focus\:ring-offset-2:focus{--tw-ring-offset-width:2px}.disabled\:cursor-not-allowed:disabled{cursor:not-allowed}.disabled\:bg-gray-400:disabled{--tw-bg-opacity:1;background-color:rgb(156 163 175/var(--tw-bg-opacity,1))}.disabled\:opacity-50:disabled{opacity:.5}@media (min-width:640px){.sm\:flex-row{flex-direction:row}.sm\:px-6{padding-left:1.5rem;padding-right:1.5rem}.sm\:text-left{text-align:left}}@media (min-width:768px){.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.md\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}}@media (min-width:1024px){.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\:px-8{padding-left:2rem;padding-right:2rem}}</style>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useCallback, useEffect, useRef } = React;

    // Google OAuth Configuration
    // In production, consider moving this to an environment variable
    const GOOGLE_CLIENT_ID = window.GOOGLE_CLIENT_ID || '160384595408-625gmnr4j40cgjp44qkfljoeo6i0n7j9.apps.googleusercontent.com';
    
    // Constants
    const MAX_RETRIES = 50;
    const MAX_INIT_ATTEMPTS = 100;
    const RETRY_DELAY = 100;
    const INIT_DELAY = 100;
    
    // Production check
    const isProduction = window.location.hostname !== 'localhost' && !window.location.hostname.includes('127.0.0.1');
    
    // Version checking and cache busting
    const getBuildVersion = () => {
      const htmlTag = document.documentElement;
      return htmlTag.getAttribute('data-build-version') || 
             document.querySelector('meta[name="build-version"]')?.content || 
             'unknown';
    };
    
    const getStoredVersion = () => {
      try {
        return localStorage.getItem('luci-build-version');
      } catch (e) {
        return null;
      }
    };
    
    const storeVersion = (version) => {
      try {
        localStorage.setItem('luci-build-version', version);
      } catch (e) {
        // Ignore localStorage errors
      }
    };
    
    // Check for version updates on load
    const checkVersionUpdate = () => {
      const currentVersion = getBuildVersion();
      const storedVersion = getStoredVersion();
      
      if (storedVersion && storedVersion !== currentVersion && currentVersion !== 'unknown') {
        log('New version detected:', currentVersion, 'Previous:', storedVersion);
        // Clear all caches and reload
        if ('caches' in window) {
          caches.keys().then(cacheNames => {
            return Promise.all(
              cacheNames.map(cacheName => caches.delete(cacheName))
            );
          }).then(() => {
            // Unregister service worker if it exists
            if ('serviceWorker' in navigator) {
              navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(registration => registration.unregister());
              }).then(() => {
                // Clear localStorage and reload
                localStorage.clear();
                storeVersion(currentVersion);
                window.location.reload(true);
              });
            } else {
              localStorage.clear();
              storeVersion(currentVersion);
              window.location.reload(true);
            }
          });
        } else {
          localStorage.clear();
          storeVersion(currentVersion);
          window.location.reload(true);
        }
        return true; // Version changed, reloading
      } else if (!storedVersion) {
        // First time visit, store current version
        storeVersion(currentVersion);
      }
      return false; // No version change
    };
    
    // Run version check immediately
    if (checkVersionUpdate()) {
      // If version changed, we're reloading - don't continue
      // This return won't execute, but it's here for clarity
      return;
    }
    
    // Helper function to format currency as US dollars
    const formatCurrency = (value) => {
      if (!value || value === 'N/A' || value === null || value === undefined) {
        return 'N/A';
      }
      
      // If it's already a formatted string with $, return as is
      if (typeof value === 'string' && value.includes('$')) {
        return value;
      }
      
      // Convert to number if it's a string
      const numValue = typeof value === 'string' ? parseFloat(value.replace(/[^0-9.-]/g, '')) : value;
      
      // Check if it's a valid number
      if (isNaN(numValue)) {
        return value; // Return original if not a number
      }
      
      // Format as US currency
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      }).format(numValue);
    };
    
    // Console logging helper (disabled in production)
    const log = (...args) => {
      if (!isProduction) {
        console.log(...args);
      }
    };
    
    const logError = (...args) => {
      console.error(...args); // Always log errors
    };

    /**
     * Customer Sentiment Analyzer
     * 
     * Uses secure Vercel Serverless Function (/api/analyze-sentiment) to protect API keys
     */

    // Fetch Avoma transcription data (with caching)
    const fetchAvomaData = async (customerIdentifier, salesforceAccountId = null) => {
      try {
        const response = await fetch('/api/avoma-transcription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            customerIdentifier: customerIdentifier,
            salesforceAccountId: salesforceAccountId,
          }),
        });

        if (!response.ok) {
          // Only throw error for actual API errors, not missing transcriptions
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to fetch transcription');
        }

        const data = await response.json();
        // Return transcription, meeting counts, and any warning
        return {
          transcription: data.transcription || '',
          meetingCounts: data.meetingCounts || null,
          warning: data.warning || null,
        };
      } catch (error) {
        logError('Error fetching Avoma transcription:', error);
        // Return empty data instead of throwing - allow analysis to continue
        return {
          transcription: '',
          meetingCounts: null,
          warning: 'Unable to fetch Avoma transcription. Analysis will proceed with Salesforce data only.',
        };
      }
    };

    // Fetch Salesforce customer context (using real account data + cases)
    // Note: This function is defined outside component but doesn't use component state
    // Cases are fetched separately via fetchCasesForAccount
    const fetchSalesforceData = async (customerIdentifier, accountData = null) => {
      // Use account data if provided, otherwise return minimal context
      if (!accountData) {
        return {
          account_tier: "Unknown",
          contract_value: "Unknown",
          account_manager: "Unknown",
        };
      }
      
      // Fetch recent cases/tickets for the account
      let recentCases = [];
      let totalCasesCount = 0;
      if (accountData.salesforceId || accountData.id) {
        try {
          const salesforceAccountId = accountData.salesforceId || accountData.id;
          const params = new URLSearchParams({
            salesforceAccountId: salesforceAccountId,
            accountId: accountData.id,
          });
          
          const casesResponse = await fetch(`/api/salesforce-cases?${params}`);
          if (casesResponse.ok) {
            const casesData = await casesResponse.json();
            recentCases = casesData.cases || [];
            totalCasesCount = casesData.total || recentCases.length;
            // Note: Cases are set in state via fetchCasesForAccount, not here
          }
        } catch (err) {
          logError('Error fetching cases:', err);
          // Continue without cases - not critical
        }
      }
      
      // Return real Salesforce account data with cases
      // Include more case details for sentiment analysis (description, type, reason, etc.)
      return {
        account_tier: accountData.accountTier || null,
        contract_value: accountData.contractValue || null,
        account_id: accountData.id,
        account_name: accountData.name,
        industry: accountData.industry || null,
        annual_revenue: accountData.annualRevenue || null,
        account_manager: accountData.ownerName || null,
        recent_tickets: recentCases.map(c => ({
          id: c.caseNumber || c.id,
          subject: c.subject || null,
          status: c.status || null,
          priority: c.priority || null,
          type: c.type || null,
          reason: c.reason || null,
          origin: c.origin || null,
          created_date: c.createdDate || null,
          closed_date: c.closedDate || null,
          description: c.description || null, // Include description for sentiment analysis
        })),
        total_cases_count: totalCasesCount,
      };
    };

    // Analyze sentiment using secure Vercel Serverless Function
    const analyzeSentiment = async (transcription, salesforceContext, userId, accountId, salesforceAccountId, customerIdentifier) => {
      const response = await fetch('/api/analyze-sentiment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          transcription,
          salesforceContext,
          userId,
          accountId,
          salesforceAccountId,
          customerIdentifier
        })
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
        throw new Error(errorData.error || `Server error: ${response.status}`);
      }

      const result = await response.json();
      
      // Validate score is within range
      if (result.score < 1 || result.score > 10) {
        throw new Error('Invalid sentiment score returned from API');
      }

      return result;
    };

    // Icon Components
    const TrendingUpIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline>
        <polyline points="16 7 22 7 22 13"></polyline>
      </svg>
    );

    const TrendingDownIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="22 17 13.5 8.5 8.5 13.5 2 7"></polyline>
        <polyline points="16 17 22 17 22 11"></polyline>
      </svg>
    );

    const LoaderIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="2" x2="12" y2="6"></line>
        <line x1="12" y1="18" x2="12" y2="22"></line>
        <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
        <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
        <line x1="2" y1="12" x2="6" y2="12"></line>
        <line x1="18" y1="12" x2="22" y2="12"></line>
        <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
        <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
      </svg>
    );

    // Login Component
    const LoginPage = ({ onSignIn }) => {
      const buttonRef = useRef(null);
      const [isLoading, setIsLoading] = useState(true);
      const [error, setError] = useState(null);
      const retryCountRef = useRef(0);
      const [buttonReady, setButtonReady] = useState(false);

      const handleCredentialResponse = useCallback((response) => {
        // Decode the JWT token to get user info
        try {
          const base64Url = response.credential.split('.')[1];
          const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split('')
              .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
              .join('')
          );
          const userInfo = JSON.parse(jsonPayload);
          onSignIn(userInfo);
        } catch (error) {
          logError('Error decoding credential:', error);
          setError('Error signing in. Please try again.');
        }
      }, [onSignIn]);

      // Wait for Google Identity Services to load and initialize
      useEffect(() => {
        let isMounted = true;
        let initAttempts = 0;

        const waitForGoogleAndInit = () => {
          initAttempts++;
          
          if (window.google && window.google.accounts && window.google.accounts.id) {
            try {
              // Initialize Google Sign-In
              window.google.accounts.id.initialize({
                client_id: GOOGLE_CLIENT_ID,
                callback: handleCredentialResponse,
              });
              log('Google Sign-In initialized successfully');
              
              // Now try to render the button
              if (isMounted) {
                renderButton();
              }
            } catch (err) {
              logError('Error initializing Google Sign-In:', err);
              if (isMounted) {
                setError(`Failed to initialize: ${err.message}`);
                setIsLoading(false);
              }
            }
          } else if (initAttempts < MAX_INIT_ATTEMPTS) {
            // Keep waiting for Google Identity Services to load
            setTimeout(waitForGoogleAndInit, INIT_DELAY);
          } else {
            logError('Google Identity Services failed to load after', MAX_INIT_ATTEMPTS, 'attempts');
            if (isMounted) {
              setError('Google Sign-In script failed to load. Please check your internet connection and refresh the page.');
              setIsLoading(false);
            }
          }
        };

        const renderButton = () => {
          if (!isMounted || !buttonReady) {
            // Wait for button to be ready
            if (retryCountRef.current < MAX_RETRIES) {
              retryCountRef.current++;
              setTimeout(renderButton, RETRY_DELAY);
            }
            return;
          }
          
          if (buttonRef.current && window.google && window.google.accounts && window.google.accounts.id) {
            try {
              // Clear any existing content
              buttonRef.current.innerHTML = '';
              
              window.google.accounts.id.renderButton(
                buttonRef.current,
                {
                  theme: 'outline',
                  size: 'large',
                  width: buttonRef.current.offsetWidth || 320,
                  text: 'signin_with',
                }
              );
              log('Google Sign-In button rendered successfully');
              setIsLoading(false);
            } catch (err) {
              logError('Error rendering button:', err);
              if (isMounted) {
                setError(`Failed to render button: ${err.message}. Please check that your domain is authorized in Google OAuth settings.`);
                setIsLoading(false);
              }
            }
          } else if (retryCountRef.current < MAX_RETRIES) {
            retryCountRef.current++;
            setTimeout(renderButton, RETRY_DELAY);
          } else {
            if (!buttonRef.current) {
              logError('Button ref is null');
              if (isMounted) {
                setError('Button element not found. Please refresh the page.');
                setIsLoading(false);
              }
            } else if (!window.google || !window.google.accounts) {
              logError('Google Identity Services not loaded');
              if (isMounted) {
                setError('Google Sign-In script not loaded. Please check your connection.');
                setIsLoading(false);
              }
            } else {
              logError('Unknown error rendering button');
              if (isMounted) {
                setError('Failed to load sign-in button. Please refresh the page.');
                setIsLoading(false);
              }
            }
          }
        };

        // Start waiting for Google Identity Services
        waitForGoogleAndInit();

        return () => {
          isMounted = false;
        };
      }, [handleCredentialResponse, buttonReady]);

      // Set button ready when ref is attached
      useEffect(() => {
        if (buttonRef.current) {
          setButtonReady(true);
        }
      }, []);

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center px-4">
          <div className="max-w-md w-full bg-white rounded-lg shadow-xl p-8">
            <div className="text-center mb-8">
              <h1 className="text-3xl font-bold text-gray-900 mb-2">
                L.U.C.I.
              </h1>
              <p className="text-gray-600">
                Please sign in to continue
              </p>
            </div>
            <div className="space-y-4">
              {/* Always render the button container so ref is available */}
              <div ref={buttonRef} className="w-full" style={{ minHeight: '40px' }}></div>
              
              {isLoading && (
                <div className="flex flex-col items-center justify-center py-2">
                  <LoaderIcon className="w-5 h-5 animate-spin text-blue-600 mb-1" />
                  <p className="text-xs text-gray-500">Loading sign-in...</p>
                </div>
              )}
              
              {error && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                  <p className="text-sm text-red-700">{error}</p>
                  <button
                    onClick={() => window.location.reload()}
                    className="mt-2 text-sm text-red-600 hover:text-red-800 underline"
                  >
                    Refresh page
                  </button>
                </div>
              )}
            </div>
            <p className="text-xs text-gray-500 text-center mt-6">
              By signing in, you agree to our terms of service and privacy policy.
            </p>
          </div>
        </div>
      );
    };

    const SentimentAnalyzer = ({ user }) => {
      const [accounts, setAccounts] = useState([]);
      const [selectedAccount, setSelectedAccount] = useState(null);
      const [loadingAccounts, setLoadingAccounts] = useState(true);
      const [customerIdentifier, setCustomerIdentifier] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [sentiment, setSentiment] = useState(null);
      const [retryCount, setRetryCount] = useState(0);
      const [searchTerm, setSearchTerm] = useState('');
      const [isSearching, setIsSearching] = useState(false);
      const [isSearchMode, setIsSearchMode] = useState(false);
      const [dataSources, setDataSources] = useState(null); // Track data sources used
      const [analysisData, setAnalysisData] = useState(null); // Store actual data used for analysis
      const [showDataDetails, setShowDataDetails] = useState(false); // Toggle for showing data details
      const [cases, setCases] = useState([]); // Store cases for the selected account
      const [casesLoading, setCasesLoading] = useState(false); // Loading state for cases
      const [showCasesList, setShowCasesList] = useState(false); // Toggle for showing cases list
      const [contacts, setContacts] = useState([]); // Store contacts for the selected account
      const [contactsLoading, setContactsLoading] = useState(false); // Loading state for contacts
      const [showContactsList, setShowContactsList] = useState(false); // Toggle for showing contacts list
      const [showHelp, setShowHelp] = useState(false); // Toggle for showing help page
      const [showResultsPage, setShowResultsPage] = useState(false); // Navigate to results page
      const [sentimentHistory, setSentimentHistory] = useState(null); // Historical sentiment data
      const [historyLoading, setHistoryLoading] = useState(false); // Loading state for history
      const [avomaWarning, setAvomaWarning] = useState(null); // Warning message for missing Avoma data
      const maxRetries = 3;
      
      // Fetch cases for an account (can be called independently)
      const fetchCasesForAccount = useCallback(async (accountData) => {
        if (!accountData) {
          setCases([]);
          setCasesLoading(false);
          return;
        }

        // Use salesforceId if available, otherwise check if id is a Salesforce ID (no dashes, 15 or 18 chars)
        // UUIDs have dashes, Salesforce IDs don't
        const salesforceAccountId = accountData.salesforceId || 
                                   (accountData.id && !accountData.id.includes('-') && 
                                    (accountData.id.length === 15 || accountData.id.length === 18) 
                                    ? accountData.id : null);
        
        if (!salesforceAccountId) {
          if (!isProduction) {
            console.warn('Cannot fetch cases: No valid Salesforce Account ID found', { 
              accountData,
              hasSalesforceId: !!accountData.salesforceId,
              id: accountData.id 
            });
          }
          setCases([]);
          setCasesLoading(false);
          return;
        }

        setCasesLoading(true);
        try {
          const params = new URLSearchParams({
            salesforceAccountId: salesforceAccountId,
            accountId: accountData.id, // This might be a UUID, which is fine for the lookup
          });
          
          const casesResponse = await fetch(`/api/salesforce-cases?${params}`);
          if (casesResponse.ok) {
            const casesData = await casesResponse.json();
            const fetchedCases = casesData.cases || [];
            setCases(fetchedCases);
            if (!isProduction) {
              console.log(`Fetched ${fetchedCases.length} cases for account: ${salesforceAccountId}`);
            }
          } else {
            const errorData = await casesResponse.json().catch(() => ({}));
            logError('Error fetching cases:', new Error(errorData.message || errorData.error || `HTTP ${casesResponse.status}`));
            setCases([]);
          }
        } catch (err) {
          logError('Error fetching cases:', err);
          setCases([]);
        } finally {
          setCasesLoading(false);
        }
      }, []);

      // Fetch contacts for an account (can be called independently)
      const fetchContactsForAccount = useCallback(async (accountData) => {
        if (!accountData) {
          setContacts([]);
          setContactsLoading(false);
          return;
        }

        // Use salesforceId if available, otherwise check if id is a Salesforce ID (no dashes, 15 or 18 chars)
        // UUIDs have dashes, Salesforce IDs don't
        const salesforceAccountId = accountData.salesforceId || 
                                   (accountData.id && !accountData.id.includes('-') && 
                                    (accountData.id.length === 15 || accountData.id.length === 18) 
                                    ? accountData.id : null);
        
        if (!salesforceAccountId) {
          if (!isProduction) {
            console.warn('Cannot fetch contacts: No valid Salesforce Account ID found', { 
              accountData,
              hasSalesforceId: !!accountData.salesforceId,
              id: accountData.id 
            });
          }
          setContacts([]);
          setContactsLoading(false);
          return;
        }

        setContactsLoading(true);
        try {
          const params = new URLSearchParams({
            salesforceAccountId: salesforceAccountId,
            accountId: accountData.id, // This might be a UUID, which is fine for the lookup
          });
          
          const contactsResponse = await fetch(`/api/salesforce-contacts?${params}`);
          if (contactsResponse.ok) {
            const contactsData = await contactsResponse.json();
            const fetchedContacts = contactsData.contacts || [];
            
            // Enrich contacts with LinkedIn data (if URLs are available)
            // This is non-blocking - we'll use whatever LinkedIn data is available
            const enrichedContacts = await Promise.all(
              fetchedContacts.map(async (contact) => {
                if (contact.linkedinURL) {
                  try {
                    const enrichResponse = await fetch('/api/linkedin-enrich', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                        linkedinURL: contact.linkedinURL,
                        salesforceContactId: contact.id,
                      }),
                    });
                    
                    // Handle both 200 (success or graceful failure) and error responses
                    if (enrichResponse.ok || enrichResponse.status === 200) {
                      try {
                        const enrichData = await enrichResponse.json();
                        if (enrichData.success && enrichData.profile) {
                          return {
                            ...contact,
                            linkedinProfile: enrichData.profile,
                          };
                        }
                        // If enrichment not available, just continue with contact data
                      } catch (parseErr) {
                        // JSON parse error - continue with contact data only
                        if (!isProduction) {
                          console.warn('LinkedIn enrichment response parse error:', parseErr);
                        }
                      }
                    } else {
                      // Non-200 response - log but don't fail
                      if (!isProduction) {
                        console.warn('LinkedIn enrichment returned status:', enrichResponse.status);
                      }
                    }
                  } catch (err) {
                    // LinkedIn enrichment failed - continue with contact data only
                    // Silently fail - LinkedIn enrichment is optional
                    if (!isProduction) {
                      console.warn('LinkedIn enrichment failed for contact:', contact.name, err);
                    }
                  }
                }
                return contact;
              })
            );
            
            setContacts(enrichedContacts);
            if (!isProduction) {
              console.log(`Fetched ${enrichedContacts.length} contacts for account: ${salesforceAccountId}`);
            }
          } else {
            const errorData = await contactsResponse.json().catch(() => ({}));
            logError('Error fetching contacts:', new Error(errorData.message || errorData.error || `HTTP ${contactsResponse.status}`));
            setContacts([]);
          }
        } catch (err) {
          logError('Error fetching contacts:', err);
          setContacts([]);
        } finally {
          setContactsLoading(false);
        }
      }, []);
      
      // Fetch Salesforce accounts on mount
      useEffect(() => {
        const fetchAccounts = async () => {
          if (!user?.id && !user?.email) {
            setLoadingAccounts(false);
            return;
          }

          try {
            setLoadingAccounts(true);
            const params = new URLSearchParams({
              userId: user.id || '',
              email: user.email || '',
              role: user.role || '',
            });

            const response = await fetch(`/api/salesforce-accounts?${params}`);
            
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(errorData.message || errorData.error || 'Failed to fetch accounts');
            }

            const data = await response.json();
            setAccounts(data.accounts || []);
            
            // Auto-select first account if available
            if (data.accounts && data.accounts.length > 0) {
              setSelectedAccount(data.accounts[0]);
              setCustomerIdentifier(data.accounts[0].name);
            }
            
            analytics.track('accounts_loaded', { 
              count: data.accounts?.length || 0,
              userId: user.id 
            });
          } catch (err) {
            logError('Error fetching accounts:', err);
            setError(err.message || 'Failed to load accounts. Please refresh the page.');
          } finally {
            setLoadingAccounts(false);
          }
        };

        if (!isSearchMode) {
          fetchAccounts();
        }
      }, [user, isSearchMode]);

      // Fetch cases and contacts when selected account changes
      useEffect(() => {
        if (selectedAccount) {
          // Use the memoized functions to fetch data
          fetchCasesForAccount(selectedAccount);
          fetchContactsForAccount(selectedAccount);
        } else {
          setCases([]);
          setShowCasesList(false);
          setContacts([]);
          setShowContactsList(false);
        }
        // eslint-disable-next-line react-hooks/exhaustive-deps
      }, [selectedAccount]); // Functions are stable (useCallback with empty deps), so we can omit them

      // Fetch historical sentiment when results page is shown
      const fetchSentimentHistory = useCallback(async (accountData) => {
        if (!accountData) {
          setSentimentHistory(null);
          return;
        }

        const salesforceAccountId = accountData.salesforceId || 
                                   (accountData.id && !accountData.id.includes('-') && 
                                    (accountData.id.length === 15 || accountData.id.length === 18) 
                                    ? accountData.id : null);
        
        if (!salesforceAccountId && !accountData.id) {
          return;
        }

        setHistoryLoading(true);
        try {
          const params = new URLSearchParams({
            accountId: accountData.id || '',
            salesforceAccountId: salesforceAccountId || '',
            limit: '50',
            days: '365',
          });
          
          const response = await fetch(`/api/sentiment-history?${params}`);
          if (response.ok) {
            const data = await response.json();
            setSentimentHistory(data);
          } else {
            // Don't show error - historical data is optional
            setSentimentHistory(null);
          }
        } catch (err) {
          // Don't show error - historical data is optional
          setSentimentHistory(null);
        } finally {
          setHistoryLoading(false);
        }
      }, []);

      // Fetch history when results page is shown
      useEffect(() => {
        if (showResultsPage && selectedAccount) {
          fetchSentimentHistory(selectedAccount);
        }
      }, [showResultsPage, selectedAccount, fetchSentimentHistory]);

      // Search for accounts
      const handleSearch = async (searchQuery) => {
        if (!searchQuery || searchQuery.trim().length < 2) {
          setError('Please enter at least 2 characters to search');
          return;
        }

        try {
          setIsSearching(true);
          setError(null);
          
          const params = new URLSearchParams({
            search: searchQuery.trim(),
            userId: user?.id || '',
          });

          const response = await fetch(`/api/salesforce-accounts?${params}`);
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || errorData.error || 'Failed to search accounts');
          }

          const data = await response.json();
          setAccounts(data.accounts || []);
          setIsSearchMode(true);
          
          // Auto-select first result if available
          if (data.accounts && data.accounts.length > 0) {
            setSelectedAccount(data.accounts[0]);
            setCustomerIdentifier(data.accounts[0].name);
          } else {
            setSelectedAccount(null);
            setCustomerIdentifier('');
          }
          
          analytics.track('accounts_searched', { 
            searchTerm: searchQuery,
            count: data.accounts?.length || 0,
            userId: user?.id 
          });
        } catch (err) {
          logError('Error searching accounts:', err);
          setError(err.message || 'Failed to search accounts. Please try again.');
        } finally {
          setIsSearching(false);
        }
      };

      // Clear search and return to assigned accounts
      const handleClearSearch = () => {
        setSearchTerm('');
        setIsSearchMode(false);
        setSelectedAccount(null);
        setCustomerIdentifier('');
        setError(null);
        // Trigger useEffect to reload assigned accounts
        window.location.reload();
      };

      const handleAnalyze = useCallback(async (attempt = 0) => {
        setLoading(true);
        setError(null);
        setCasesLoading(true);
        if (attempt === 0) {
          setSentiment(null);
        }

        try {
          // Fetch data from both sources in parallel
          const [avomaData, salesforceContext] = await Promise.all([
            fetchAvomaData(customerIdentifier, selectedAccount?.salesforceId || selectedAccount?.id),
            fetchSalesforceData(customerIdentifier, selectedAccount)
          ]);
          
          // Cases are already set in fetchSalesforceData, just update loading state
          setCasesLoading(false);

          // Extract transcription and meeting counts
          const transcription = avomaData.transcription || '';
          const meetingCounts = avomaData.meetingCounts || null;
          
          // Show warning if no transcription available (but don't error out)
          if (avomaData.warning || !transcription) {
            const warningMessage = avomaData.warning || 'No Avoma transcription available. Analysis will proceed with Salesforce account data only.';
            setAvomaWarning(warningMessage);
            if (!isProduction) {
              console.warn('Avoma transcription warning:', warningMessage);
            }
          } else {
            setAvomaWarning(null);
          }

          // Enrich with LinkedIn data from contacts
          const linkedinData = {
            contacts: contacts
              .filter(c => c.linkedinURL || c.linkedinProfile)
              .map(c => ({
                name: c.name || `${c.firstName || ''} ${c.lastName || ''}`.trim(),
                linkedin_url: c.linkedinURL,
                current_title: c.title || c.linkedinProfile?.current_title,
                current_company: c.linkedinProfile?.current_company,
                job_changed_recently: c.linkedinProfile?.job_changed_recently || false,
                days_in_current_role: c.linkedinProfile?.days_in_current_role,
                profile_updated_recently: c.linkedinProfile?.profile_updated_at ? 
                  (new Date() - new Date(c.linkedinProfile.profile_updated_at)) < (30 * 24 * 60 * 60 * 1000) : false,
                engagement_with_company: {
                  posts_about_company: c.linkedinProfile?.posts_about_company || 0,
                  comments_on_company_posts: c.linkedinProfile?.comments_on_company_posts || 0,
                  shares_of_company_content: c.linkedinProfile?.shares_of_company_content || 0,
                  reactions_to_company_posts: c.linkedinProfile?.reactions_to_company_posts || 0,
                },
              })),
            total_contacts_with_linkedin: contacts.filter(c => c.linkedinURL).length,
            contacts_with_enriched_data: contacts.filter(c => c.linkedinProfile).length,
          };

          // Add counts to salesforce context for sentiment analysis
          const enrichedContext = {
            ...salesforceContext,
            total_cases_count: salesforceContext.total_cases_count || 0,
            total_avoma_calls: meetingCounts?.total || 0,
            ready_avoma_calls: meetingCounts?.ready || 0,
            linkedin_data: linkedinData.contacts.length > 0 ? linkedinData : null,
          };

          // Store the actual data used for analysis (for transparency)
          setAnalysisData({
            transcription: transcription,
            salesforceContext: enrichedContext,
            transcriptionPreview: transcription.length > 500 
              ? transcription.substring(0, 500) + '...' 
              : transcription,
          });
          
          // Analyze sentiment (pass account/user info for historical tracking)
          const salesforceAccountId = selectedAccount?.salesforceId || 
                                     (selectedAccount?.id && !selectedAccount.id.includes('-') && 
                                      (selectedAccount.id.length === 15 || selectedAccount.id.length === 18) 
                                      ? selectedAccount.id : null);
          
          const result = await analyzeSentiment(
            transcription, 
            enrichedContext,
            user?.id,
            selectedAccount?.id,
            salesforceAccountId,
            customerIdentifier
          );
          setSentiment(result);
          setRetryCount(0);
          
          // Track data sources used for this analysis
          setDataSources({
            hasTranscription: !!transcription && transcription.length > 0,
            transcriptionLength: transcription.length,
            hasAccountData: !!selectedAccount,
            accountName: selectedAccount?.name || customerIdentifier,
            casesCount: enrichedContext.total_cases_count || 0,
            avomaCallsTotal: enrichedContext.total_avoma_calls || 0,
            avomaCallsReady: enrichedContext.ready_avoma_calls || 0,
            hasCases: (enrichedContext.recent_tickets || []).length > 0,
            hasLinkedIn: !!enrichedContext.linkedin_data && enrichedContext.linkedin_data.contacts.length > 0,
            linkedinContactsCount: enrichedContext.linkedin_data?.contacts.length || 0,
            linkedinEnrichedCount: enrichedContext.linkedin_data?.contacts_with_enriched_data || 0,
          });
          
          // Navigate to results page
          setShowResultsPage(true);
          
          analytics.track('sentiment_analyzed', { 
            customerIdentifier,
            score: result.score,
            hasTranscription: !!transcription,
            casesCount: enrichedContext.total_cases_count || 0,
            avomaCallsCount: enrichedContext.total_avoma_calls || 0,
          });
        } catch (err) {
          const errorMessage = err.message || 'An error occurred while analyzing sentiment';
          setError(errorMessage);
          logError('Sentiment analysis error:', err);
          
          if (attempt < maxRetries && (err.message?.includes('timeout') || err.message?.includes('network'))) {
            setRetryCount(attempt + 1);
            analytics.track('sentiment_analysis_retry', { attempt: attempt + 1 });
          } else {
            setRetryCount(0);
            analytics.track('sentiment_analysis_failed', { error: errorMessage });
          }
        } finally {
          setLoading(false);
        }
      }, [customerIdentifier]);

      const getScoreColor = (score) => {
        if (score <= 4) return 'text-red-600 bg-red-50 border-red-200';
        if (score <= 7) return 'text-yellow-600 bg-yellow-50 border-yellow-200';
        return 'text-green-600 bg-green-50 border-green-200';
      };

      const getScoreBgColor = (score) => {
        if (score <= 4) return 'bg-red-100';
        if (score <= 7) return 'bg-yellow-100';
        return 'bg-green-100';
      };

      // Results Page Component
      const ResultsPage = ({ sentiment, dataSources, analysisData, selectedAccount, cases, contacts, sentimentHistory, historyLoading, avomaWarning, onBack, onShowHelp }) => {
        const [showDataDetails, setShowDataDetails] = useState(false);

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-12 px-4 sm:px-6 lg:px-8">
            <div className="max-w-6xl mx-auto">
              {/* Header with Back Button */}
              <div className="mb-8">
                <button
                  onClick={onBack}
                  className="mb-6 flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors"
                  aria-label="Back to account selection"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                  </svg>
                  <span className="font-medium">Back to Account Selection</span>
                </button>
                <div className="flex items-center justify-between">
                  <div>
                    <h1 className="text-3xl font-bold text-gray-900 mb-2">
                      Sentiment Analysis Results
                    </h1>
                    <p className="text-lg text-gray-600">
                      {selectedAccount?.name || 'Account Analysis'}
                    </p>
                  </div>
                  <button
                    onClick={onShowHelp}
                    className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                    aria-label="Show help and explanation"
                  >
                    Help
                  </button>
                </div>
              </div>

              {/* Avoma Warning Banner */}
              {avomaWarning && (
                <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-lg" role="alert">
                  <div className="flex">
                    <div className="flex-shrink-0">
                      <svg className="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                      </svg>
                    </div>
                    <div className="ml-3">
                      <p className="text-sm text-yellow-700">
                        <strong>Note:</strong> {avomaWarning}
                      </p>
                    </div>
                  </div>
                </div>
              )}

              {/* Sentiment Score Display */}
              <div className="bg-white rounded-lg shadow-lg p-8 mb-6" role="region" aria-live="polite" aria-label="Sentiment analysis results">
                {/* Score Display */}
                <div className={`text-center mb-6 p-8 rounded-xl border-2 ${getScoreColor(sentiment.score)}`} role="status">
                  <div className="text-6xl font-bold mb-2" aria-label={`Sentiment score: ${sentiment.score} out of 10`}>
                    {sentiment.score}
                  </div>
                  <div className="text-xl font-semibold text-gray-600">
                    / 10
                  </div>
                </div>

                {/* Summary Display */}
                <div className={`rounded-lg p-6 ${getScoreBgColor(sentiment.score)}`}>
                  <div className="flex items-start gap-3">
                    {sentiment.score >= 8 ? (
                      <TrendingUpIcon className="w-6 h-6 text-green-600 flex-shrink-0 mt-1" />
                    ) : (
                      <TrendingDownIcon className="w-6 h-6 text-red-600 flex-shrink-0 mt-1" />
                    )}
                    <div className="flex-1">
                      <h3 className="font-semibold text-gray-900 mb-2">Sentiment Summary</h3>
                      <p className="text-gray-700 leading-relaxed">{sentiment.summary}</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Historical Sentiment Section */}
              {sentimentHistory && sentimentHistory.history && sentimentHistory.history.length > 0 && (
                <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                  <h3 className="text-xl font-semibold text-gray-900 mb-4">Sentiment History</h3>
                  
                  {/* Statistics */}
                  {sentimentHistory.stats && (
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                      <div className="bg-gray-50 rounded-lg p-4">
                        <div className="text-sm text-gray-600 mb-1">Average Score</div>
                        <div className="text-2xl font-bold text-gray-900">{sentimentHistory.stats.average.toFixed(1)}</div>
                        <div className="text-xs text-gray-500">/ 10</div>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-4">
                        <div className="text-sm text-gray-600 mb-1">Range</div>
                        <div className="text-2xl font-bold text-gray-900">
                          {sentimentHistory.stats.min} - {sentimentHistory.stats.max}
                        </div>
                        <div className="text-xs text-gray-500">Min - Max</div>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-4">
                        <div className="text-sm text-gray-600 mb-1">Total Analyses</div>
                        <div className="text-2xl font-bold text-gray-900">{sentimentHistory.stats.total}</div>
                        <div className="text-xs text-gray-500">Last 365 days</div>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-4">
                        <div className="text-sm text-gray-600 mb-1">Trend</div>
                        <div className={`text-2xl font-bold ${
                          sentimentHistory.stats.trend === 'improving' ? 'text-green-600' :
                          sentimentHistory.stats.trend === 'declining' ? 'text-red-600' :
                          'text-yellow-600'
                        }`}>
                          {sentimentHistory.stats.trend === 'improving' ? 'â†‘ Improving' :
                           sentimentHistory.stats.trend === 'declining' ? 'â†“ Declining' :
                           'â†’ Stable'}
                        </div>
                        {sentimentHistory.stats.recentAverage > 0 && sentimentHistory.stats.previousAverage > 0 && (
                          <div className="text-xs text-gray-500">
                            {sentimentHistory.stats.recentAverage.toFixed(1)} vs {sentimentHistory.stats.previousAverage.toFixed(1)}
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Simple Line Chart Visualization */}
                  <div className="mb-6">
                    <h4 className="text-sm font-semibold text-gray-700 mb-3">Score Over Time</h4>
                    <div className="bg-gray-50 rounded-lg p-4" style={{ height: '200px', position: 'relative' }}>
                      {/* Simple bar chart representation */}
                      <div className="flex items-end justify-between h-full gap-1">
                        {sentimentHistory.history.slice(0, 20).reverse().map((entry, idx) => {
                          const height = (entry.score / 10) * 100;
                          const color = entry.score <= 4 ? '#ef4444' : entry.score <= 7 ? '#eab308' : '#22c55e';
                          return (
                            <div key={entry.id || idx} className="flex-1 flex flex-col items-center" title={`Score: ${entry.score} on ${new Date(entry.analyzed_at).toLocaleDateString()}`}>
                              <div
                                className="w-full rounded-t transition-all hover:opacity-80"
                                style={{
                                  height: `${height}%`,
                                  backgroundColor: color,
                                  minHeight: '4px'
                                }}
                              />
                              <div className="text-xs text-gray-500 mt-1 transform -rotate-45 origin-top-left whitespace-nowrap" style={{ writingMode: 'vertical-rl' }}>
                                {new Date(entry.analyzed_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>

                  {/* Recent History List */}
                  <div>
                    <h4 className="text-sm font-semibold text-gray-700 mb-3">Recent Analyses</h4>
                    <div className="space-y-2 max-h-60 overflow-y-auto">
                      {sentimentHistory.history.slice(0, 10).map((entry) => (
                        <div key={entry.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                          <div className="flex-1">
                            <div className="flex items-center gap-2">
                              <span className={`text-lg font-bold ${
                                entry.score <= 4 ? 'text-red-600' :
                                entry.score <= 7 ? 'text-yellow-600' :
                                'text-green-600'
                              }`}>
                                {entry.score}
                              </span>
                              <span className="text-sm text-gray-600">/ 10</span>
                              <span className="text-xs text-gray-500 ml-2">
                                {new Date(entry.analyzed_at).toLocaleString()}
                              </span>
                            </div>
                            <p className="text-xs text-gray-600 mt-1 line-clamp-1">{entry.summary}</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {historyLoading && (
                <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                  <div className="flex items-center justify-center">
                    <LoaderIcon className="w-6 h-6 animate-spin text-blue-600 mr-3" />
                    <p className="text-gray-600">Loading sentiment history...</p>
                  </div>
                </div>
              )}

              {/* Data Sources Section */}
              {dataSources && (
                <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                  <h3 className="text-xl font-semibold text-gray-900 mb-4">Analysis Data Sources</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-6">
                    <div className="space-y-2">
                      <div className="flex items-center gap-2">
                        {dataSources.hasTranscription ? (
                          <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                        ) : (
                          <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        )}
                        <span className="font-medium text-gray-700">Avoma Transcription</span>
                      </div>
                      {dataSources.hasTranscription ? (
                        <p className="text-gray-600 ml-7">
                          {dataSources.transcriptionLength.toLocaleString()} characters from customer call/meeting
                          {dataSources.avomaCallsTotal > 0 && (
                            <span className="block mt-1 text-xs text-gray-500">
                              Found {dataSources.avomaCallsTotal} meeting{dataSources.avomaCallsTotal !== 1 ? 's' : ''} 
                              {dataSources.avomaCallsReady > 0 && ` (${dataSources.avomaCallsReady} with ready transcripts)`}
                            </span>
                          )}
                        </p>
                      ) : (
                        <p className="text-gray-500 ml-7 text-xs">No transcription available</p>
                      )}
                    </div>

                    <div className="space-y-2">
                      <div className="flex items-center gap-2">
                        {dataSources.hasAccountData ? (
                          <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                        ) : (
                          <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        )}
                        <span className="font-medium text-gray-700">Salesforce Account</span>
                      </div>
                      {dataSources.hasAccountData ? (
                        <p className="text-gray-600 ml-7">
                          {dataSources.accountName}
                          {dataSources.casesCount > 0 && (
                            <span className="block mt-1 text-xs text-gray-500">
                              {dataSources.casesCount} support case{dataSources.casesCount !== 1 ? 's' : ''} found
                            </span>
                          )}
                        </p>
                      ) : (
                        <p className="text-gray-500 ml-7 text-xs">No account data available</p>
                      )}
                    </div>
                  </div>
                  <div className="mt-4 pt-4 border-t border-gray-100">
                    <p className="text-xs text-gray-500 mb-3">
                      <strong>AI Analysis:</strong> Powered by Google Gemini 2.5 Flash, analyzing conversation tone, 
                      customer language, and account context to generate sentiment score.
                    </p>
                    <button
                      onClick={() => setShowDataDetails(!showDataDetails)}
                      className="text-xs text-blue-600 hover:text-blue-800 font-medium underline flex items-center gap-1"
                      aria-expanded={showDataDetails}
                      aria-label={showDataDetails ? 'Hide data details' : 'Show data details'}
                    >
                      {showDataDetails ? (
                        <>
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                          </svg>
                          Hide Data Used in Analysis
                        </>
                      ) : (
                        <>
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          </svg>
                          Show Data Used in Analysis
                        </>
                      )}
                    </button>
                  </div>
                </div>
              )}

              {/* Detailed Data View */}
              {showDataDetails && analysisData && (
                <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                  <h4 className="text-lg font-semibold text-gray-900 mb-4">Detailed Data Used in Analysis</h4>
                  
                  {/* Avoma Transcription Details */}
                  <div className="bg-gray-50 rounded-lg p-4 mb-4">
                    <h5 className="text-sm font-semibold text-gray-800 mb-2">Avoma Transcription</h5>
                    {analysisData.transcription && analysisData.transcription.length > 0 ? (
                      <>
                        <p className="text-xs text-gray-700 mb-2">
                          <span className="font-medium">Characters:</span> {analysisData.transcription.length.toLocaleString()} | 
                          <span className="font-medium ml-2">Words:</span> {analysisData.transcription.split(/\s+/).filter(Boolean).length.toLocaleString()}
                        </p>
                        <div className="bg-white border border-gray-200 rounded-md p-3 text-xs text-gray-800 max-h-60 overflow-y-auto">
                          <pre className="whitespace-pre-wrap font-mono">{analysisData.transcription}</pre>
                        </div>
                      </>
                    ) : (
                      <p className="text-xs text-gray-500">No transcription data was available for analysis.</p>
                    )}
                  </div>

                  {/* Salesforce Context Details */}
                  <div className="bg-gray-50 rounded-lg p-4 mb-4">
                    <h5 className="text-sm font-semibold text-gray-800 mb-2">Salesforce Account Context</h5>
                    {analysisData.salesforceContext ? (
                      <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-xs">
                        <div>
                          <span className="font-medium text-gray-600">Account Name:</span>
                          <span className="ml-2 text-gray-900">{analysisData.salesforceContext.account_name || 'N/A'}</span>
                        </div>
                        <div>
                          <span className="font-medium text-gray-600">Tier:</span>
                          <span className="ml-2 text-gray-900">{analysisData.salesforceContext.account_tier || 'N/A'}</span>
                        </div>
                        <div>
                          <span className="font-medium text-gray-600">Contract Value:</span>
                          <span className="ml-2 text-gray-900">{formatCurrency(analysisData.salesforceContext.contract_value) || 'N/A'}</span>
                        </div>
                        <div>
                          <span className="font-medium text-gray-600">Industry:</span>
                          <span className="ml-2 text-gray-900">{analysisData.salesforceContext.industry || 'N/A'}</span>
                        </div>
                        <div>
                          <span className="font-medium text-gray-600">Annual Revenue:</span>
                          <span className="ml-2 text-gray-900">{analysisData.salesforceContext.annual_revenue ? `$${analysisData.salesforceContext.annual_revenue.toLocaleString()}` : 'N/A'}</span>
                        </div>
                        <div>
                          <span className="font-medium text-gray-600">Account Manager:</span>
                          <span className="ml-2 text-gray-900">{analysisData.salesforceContext.account_manager || 'N/A'}</span>
                        </div>
                        {analysisData.salesforceContext.total_cases_count !== undefined && (
                          <div>
                            <span className="font-medium text-gray-600">Support Cases:</span>
                            <span className="ml-2 text-gray-900">{analysisData.salesforceContext.total_cases_count}</span>
                          </div>
                        )}
                        {analysisData.salesforceContext.total_avoma_calls !== undefined && (
                          <div>
                            <span className="font-medium text-gray-600">Avoma Calls (Total):</span>
                            <span className="ml-2 text-gray-900">{analysisData.salesforceContext.total_avoma_calls}</span>
                          </div>
                        )}
                        {analysisData.salesforceContext.ready_avoma_calls !== undefined && (
                          <div>
                            <span className="font-medium text-gray-600">Avoma Calls (Ready):</span>
                            <span className="ml-2 text-gray-900">{analysisData.salesforceContext.ready_avoma_calls}</span>
                          </div>
                        )}
                      </div>
                    ) : (
                      <p className="text-xs text-gray-500">No Salesforce account context was available for analysis.</p>
                    )}
                  </div>

                  {/* Recent Support Cases Details */}
                  {analysisData.salesforceContext?.recent_tickets && 
                   analysisData.salesforceContext.recent_tickets.length > 0 && (
                    <div className="bg-gray-50 rounded-lg p-4 mb-4">
                      <h5 className="text-sm font-semibold text-gray-800 mb-2">
                        Recent Support Cases ({analysisData.salesforceContext.recent_tickets.length})
                      </h5>
                      <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                        {analysisData.salesforceContext.recent_tickets.map((ticket, idx) => (
                          <div key={idx} className="text-xs bg-white rounded p-2 border border-gray-200">
                            <a
                              href={`https://leandata.my.salesforce.com/500/o/Case/d?id=${ticket.id}`}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="font-medium text-blue-700 hover:text-blue-900 hover:underline flex items-center gap-1"
                              aria-label={`View case ${ticket.caseNumber} in Salesforce`}
                            >
                              {ticket.caseNumber || ticket.id} - {ticket.subject || 'No Subject'}
                              <svg className="w-3 h-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                              </svg>
                            </a>
                            <p className="text-gray-600 mt-1">
                              Status: <span className={`font-semibold ${ticket.status === 'Closed' ? 'text-green-600' : 'text-blue-600'}`}>{ticket.status}</span>
                              <span className="mx-2">|</span> Priority: <span className={`font-semibold ${['High', 'Critical'].includes(ticket.priority) ? 'text-red-600' : 'text-gray-600'}`}>{ticket.priority || 'N/A'}</span>
                            </p>
                            <p className="text-gray-500 mt-1">
                              Created: {new Date(ticket.created_date).toLocaleDateString()} {ticket.closed_date ? `| Closed: ${new Date(ticket.closed_date).toLocaleDateString()}` : ''}
                            </p>
                            {ticket.description && (
                              <p className="text-gray-700 mt-2 italic line-clamp-2" title={ticket.description}>
                                "{ticket.description}"
                              </p>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* LinkedIn Data Details */}
                  {analysisData.salesforceContext?.linkedin_data && 
                   analysisData.salesforceContext.linkedin_data.contacts.length > 0 && (
                    <div className="bg-gray-50 rounded-lg p-4 mb-4">
                      <h5 className="text-sm font-semibold text-gray-800 mb-2">
                        LinkedIn Professional Context ({analysisData.salesforceContext.linkedin_data.contacts.length} contacts)
                      </h5>
                      <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                        {analysisData.salesforceContext.linkedin_data.contacts.map((contact, idx) => (
                          <div key={idx} className="text-xs bg-white rounded p-2 border border-gray-200">
                            <div className="flex items-center gap-2 mb-1">
                              <span className="font-medium text-gray-900">{contact.name}</span>
                              {contact.linkedin_url && (
                                <a
                                  href={contact.linkedin_url}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="text-blue-600 hover:text-blue-800 hover:underline flex items-center gap-1"
                                  aria-label={`View ${contact.name} on LinkedIn`}
                                >
                                  <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                  </svg>
                                  LinkedIn
                                </a>
                              )}
                            </div>
                            {contact.current_title && (
                              <p className="text-gray-700 mt-1">
                                <span className="font-medium">Title:</span> {contact.current_title}
                                {contact.current_company && ` at ${contact.current_company}`}
                              </p>
                            )}
                            {contact.job_changed_recently && (
                              <p className="text-red-600 text-xs font-semibold mt-1">
                                âš ï¸ Recent job change detected
                              </p>
                            )}
                            {contact.profile_updated_recently && (
                              <p className="text-yellow-600 text-xs mt-1">
                                ðŸ“ Profile recently updated
                              </p>
                            )}
                            {contact.engagement_with_company && (
                              contact.engagement_with_company.posts_about_company > 0 ||
                              contact.engagement_with_company.comments_on_company_posts > 0 ||
                              contact.engagement_with_company.shares_of_company_content > 0 ||
                              contact.engagement_with_company.reactions_to_company_posts > 0
                            ) && (
                              <p className="text-gray-600 text-xs mt-1">
                                Engagement: {contact.engagement_with_company.posts_about_company} posts, 
                                {contact.engagement_with_company.comments_on_company_posts} comments, 
                                {contact.engagement_with_company.shares_of_company_content} shares, 
                                {contact.engagement_with_company.reactions_to_company_posts} reactions
                              </p>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Data Summary Statistics */}
                  <div className="bg-gray-50 rounded-lg p-4">
                    <h5 className="text-sm font-semibold text-blue-900 uppercase tracking-wide mb-2">
                      Data Summary
                    </h5>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                      <div>
                        <div className="text-blue-600 font-medium">Transcription</div>
                        <div className="text-blue-900">{analysisData.transcription.length.toLocaleString()} chars</div>
                      </div>
                      <div>
                        <div className="text-blue-600 font-medium">Account Fields</div>
                        <div className="text-blue-900">
                          {Object.keys(analysisData.salesforceContext).filter(k => 
                            !['recent_tickets', 'account_id', 'linkedin_data'].includes(k) && 
                            analysisData.salesforceContext[k] !== null
                          ).length} provided
                        </div>
                      </div>
                      <div>
                        <div className="text-blue-600 font-medium">Support Cases</div>
                        <div className="text-blue-900">
                          {analysisData.salesforceContext.recent_tickets?.length || 0} cases
                        </div>
                      </div>
                      <div>
                        <div className="text-blue-600 font-medium">LinkedIn Contacts</div>
                        <div className="text-blue-900">
                          {analysisData.salesforceContext.linkedin_data?.contacts.length || 0} profiles
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Cases and Contacts Section */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                {/* Cases Section */}
                {cases.length > 0 && (
                  <div className="bg-white rounded-lg shadow-lg p-6">
                    <h3 className="text-lg font-semibold text-gray-900 mb-4">Support Cases ({cases.length})</h3>
                    <div className="space-y-3 max-h-96 overflow-y-auto">
                      {cases.map((caseItem) => {
                        const salesforceUrl = caseItem.id 
                          ? `https://leandata.my.salesforce.com/${caseItem.id}`
                          : null;
                        
                        return (
                          <div key={caseItem.id} className="bg-gray-50 rounded-lg p-3 border border-gray-200">
                            <a
                              href={salesforceUrl}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="font-medium text-blue-700 hover:text-blue-900 hover:underline flex items-center gap-1 mb-1"
                            >
                              {caseItem.caseNumber || caseItem.id} - {caseItem.subject || 'No Subject'}
                              <svg className="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                              </svg>
                            </a>
                            <p className="text-xs text-gray-600 mt-1">
                              Status: <span className={`font-semibold ${caseItem.status === 'Closed' ? 'text-green-600' : 'text-blue-600'}`}>{caseItem.status}</span>
                              <span className="mx-2">|</span> Priority: <span className={`font-semibold ${['High', 'Critical'].includes(caseItem.priority) ? 'text-red-600' : 'text-gray-600'}`}>{caseItem.priority || 'N/A'}</span>
                            </p>
                            <p className="text-xs text-gray-500 mt-1">
                              Created: {new Date(caseItem.createdDate).toLocaleDateString()} {caseItem.closedDate ? `| Closed: ${new Date(caseItem.closedDate).toLocaleDateString()}` : ''}
                            </p>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}

                {/* Contacts Section */}
                {contacts.length > 0 && (
                  <div className="bg-white rounded-lg shadow-lg p-6">
                    <h3 className="text-lg font-semibold text-gray-900 mb-4">Account Contacts ({contacts.length})</h3>
                    <div className="space-y-3 max-h-96 overflow-y-auto">
                      {contacts.map((contact) => {
                        const salesforceUrl = contact.id 
                          ? `https://leandata.my.salesforce.com/${contact.id}`
                          : null;
                        
                        return (
                          <div key={contact.id} className="bg-gray-50 rounded-lg p-3 border border-gray-200">
                            <a
                              href={salesforceUrl}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="font-medium text-blue-700 hover:text-blue-900 hover:underline flex items-center gap-1 mb-1"
                            >
                              {contact.name || `${contact.firstName || ''} ${contact.lastName || ''}`.trim() || 'Contact'}
                              <svg className="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                              </svg>
                            </a>
                            {contact.title && (
                              <p className="text-xs text-gray-600 mt-1">{contact.title}</p>
                            )}
                            <div className="flex flex-wrap gap-x-3 gap-y-1 text-xs text-gray-500 mt-1">
                              {contact.email && (
                                <a href={`mailto:${contact.email}`} className="text-blue-600 hover:text-blue-800 hover:underline">
                                  {contact.email}
                                </a>
                              )}
                              {contact.phone && (
                                <a href={`tel:${contact.phone}`} className="text-blue-600 hover:text-blue-800 hover:underline">
                                  {contact.phone}
                                </a>
                              )}
                              {contact.linkedinURL && (
                                <a 
                                  href={contact.linkedinURL} 
                                  target="_blank" 
                                  rel="noopener noreferrer"
                                  className="text-blue-600 hover:text-blue-800 hover:underline flex items-center gap-1"
                                  aria-label={`View ${contact.name} on LinkedIn`}
                                >
                                  <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                  </svg>
                                  LinkedIn
                                </a>
                              )}
                            </div>
                            {contact.linkedinProfile && (
                              <div className="mt-2 pt-2 border-t border-gray-200">
                                {contact.linkedinProfile.job_changed_recently && (
                                  <p className="text-xs text-red-600 font-semibold mb-1">
                                    âš ï¸ Recent job change detected
                                  </p>
                                )}
                                {contact.linkedinProfile.current_title && (
                                  <p className="text-xs text-gray-600">
                                    <span className="font-medium">LinkedIn:</span> {contact.linkedinProfile.current_title}
                                    {contact.linkedinProfile.current_company && ` at ${contact.linkedinProfile.current_company}`}
                                  </p>
                                )}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      };

      // Show results page if analysis is complete
      if (showResultsPage && sentiment) {
        return (
          <>
            <ResultsPage
              sentiment={sentiment}
              dataSources={dataSources}
              analysisData={analysisData}
              selectedAccount={selectedAccount}
              cases={cases}
              contacts={contacts}
              sentimentHistory={sentimentHistory}
              historyLoading={historyLoading}
              avomaWarning={avomaWarning}
              onBack={() => {
                setShowResultsPage(false);
                setSentiment(null);
                setAnalysisData(null);
                setDataSources(null);
                setSentimentHistory(null);
                setAvomaWarning(null);
              }}
              onShowHelp={() => setShowHelp(true)}
            />
            {showHelp && <HelpPage onClose={() => setShowHelp(false)} />}
          </>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-12 px-4 sm:px-6 lg:px-8">
          <div className="max-w-4xl mx-auto">
            {/* Header with User Info and Logout */}
            <div className="mb-8">
              <div className="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
                <div className="text-center sm:text-left">
                  <h1 className="text-4xl font-bold text-gray-900 mb-2">
                    L.U.C.I.
                  </h1>
                  <p className="text-lg text-gray-600">
                    LeanData Unified Customer Intelligence
                  </p>
                </div>
                <div className="flex items-center gap-3">
                  <button
                    onClick={() => setShowHelp(!showHelp)}
                    className="px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all flex items-center gap-2"
                    aria-label="Show help and information"
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    {showHelp ? 'Hide Help' : 'Help'}
                  </button>
                  <div className="flex items-center gap-4 bg-white px-4 py-2 rounded-lg shadow-sm">
                    <div className="text-right">
                      <p className="text-sm font-medium text-gray-900">
                        {user?.name || 'User'}
                      </p>
                      <p className="text-xs text-gray-500">
                        {user?.email}
                      </p>
                      {user?.role && (
                        <p className="text-xs text-blue-600 font-medium">
                          {user.role}
                        </p>
                      )}
                    </div>
                    <button
                      onClick={() => {
                        window.google?.accounts?.id.disableAutoSelect();
                        localStorage.removeItem('userInfo');
                        window.location.reload();
                      }}
                      className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-50 border border-gray-300 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all whitespace-nowrap"
                    >
                      Sign Out
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {/* Help Page */}
            {showHelp && (
              <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                <div className="flex items-center justify-between mb-6">
                  <h2 className="text-2xl font-bold text-gray-900">How Sentiment Analysis Works</h2>
                  <button
                    onClick={() => setShowHelp(false)}
                    className="text-gray-400 hover:text-gray-600"
                    aria-label="Close help"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>

                <div className="prose max-w-none space-y-6">
                  <section>
                    <h3 className="text-xl font-semibold text-gray-900 mb-3">Overview</h3>
                    <p className="text-gray-700 leading-relaxed">
                      L.U.C.I. uses Google Gemini AI to analyze customer sentiment by combining conversation transcripts from Avoma meetings with comprehensive Salesforce account context. The analysis provides a score from 1-10 and detailed insights about the customer relationship.
                    </p>
                  </section>

                  <section>
                    <h3 className="text-xl font-semibold text-gray-900 mb-3">Data Sources Analyzed</h3>
                    <div className="space-y-4">
                      <div className="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
                        <h4 className="font-semibold text-gray-900 mb-2">1. Avoma Conversation Transcripts</h4>
                        <p className="text-gray-700 text-sm">
                          The AI analyzes the actual conversation between your team and the customer, looking for:
                        </p>
                        <ul className="list-disc list-inside text-gray-700 text-sm mt-2 space-y-1">
                          <li>Tone and emotional indicators (frustration, satisfaction, urgency)</li>
                          <li>Language patterns and sentiment signals</li>
                          <li>Initial concerns and how they were addressed</li>
                          <li>Resolution quality and final satisfaction level</li>
                        </ul>
                      </div>

                      <div className="bg-green-50 rounded-lg p-4 border-l-4 border-green-500">
                        <h4 className="font-semibold text-gray-900 mb-2">2. Salesforce Support Cases</h4>
                        <p className="text-gray-700 text-sm">
                          Recent support cases provide critical context:
                        </p>
                        <ul className="list-disc list-inside text-gray-700 text-sm mt-2 space-y-1">
                          <li><strong>Case Count:</strong> Number of recent cases (more cases may indicate issues)</li>
                          <li><strong>Case Descriptions:</strong> Customer feedback and issue details</li>
                          <li><strong>Priority & Status:</strong> High priority or unresolved cases signal risk</li>
                          <li><strong>Case Types & Reasons:</strong> Patterns in support needs</li>
                          <li><strong>Resolution Timelines:</strong> How quickly issues are resolved</li>
                        </ul>
                      </div>

                      <div className="bg-purple-50 rounded-lg p-4 border-l-4 border-purple-500">
                        <h4 className="font-semibold text-gray-900 mb-2">3. Account Profile Context</h4>
                        <p className="text-gray-700 text-sm">
                          Account characteristics help set appropriate expectations:
                        </p>
                        <ul className="list-disc list-inside text-gray-700 text-sm mt-2 space-y-1">
                          <li><strong>Account Tier:</strong> Higher tier accounts may have different expectations</li>
                          <li><strong>Contract Value:</strong> Expiring ARR indicates renewal risk</li>
                          <li><strong>Industry:</strong> Industry norms and standards</li>
                          <li><strong>Account Manager:</strong> Relationship context</li>
                        </ul>
                      </div>

                      <div className="bg-yellow-50 rounded-lg p-4 border-l-4 border-yellow-500">
                        <h4 className="font-semibold text-gray-900 mb-2">4. Engagement Metrics</h4>
                        <p className="text-gray-700 text-sm">
                          Meeting participation and frequency:
                        </p>
                        <ul className="list-disc list-inside text-gray-700 text-sm mt-2 space-y-1">
                          <li>Total Avoma calls/meetings with the customer</li>
                          <li>Number of meetings with ready transcripts</li>
                          <li>Engagement frequency and participation</li>
                        </ul>
                      </div>
                    </div>
                  </section>

                  <section>
                    <h3 className="text-xl font-semibold text-gray-900 mb-3">Sentiment Score Scale</h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div className="bg-red-50 rounded-lg p-4 border-2 border-red-200">
                        <div className="text-2xl font-bold text-red-600 mb-2">1-4</div>
                        <p className="text-sm font-semibold text-gray-900 mb-1">At Risk</p>
                        <p className="text-xs text-gray-700">Very negative sentiment. Customer may be at risk of churn. Immediate attention required.</p>
                      </div>
                      <div className="bg-yellow-50 rounded-lg p-4 border-2 border-yellow-200">
                        <div className="text-2xl font-bold text-yellow-600 mb-2">5-7</div>
                        <p className="text-sm font-semibold text-gray-900 mb-1">Neutral/Mixed</p>
                        <p className="text-xs text-gray-700">Mixed or neutral sentiment. Relationship is stable but needs attention to improve.</p>
                      </div>
                      <div className="bg-green-50 rounded-lg p-4 border-2 border-green-200">
                        <div className="text-2xl font-bold text-green-600 mb-2">8-10</div>
                        <p className="text-sm font-semibold text-gray-900 mb-1">Positive</p>
                        <p className="text-xs text-gray-700">Strong positive sentiment. Customer is satisfied and may be a strong advocate.</p>
                      </div>
                    </div>
                  </section>

                  <section>
                    <h3 className="text-xl font-semibold text-gray-900 mb-3">What the Analysis Includes</h3>
                    <p className="text-gray-700 leading-relaxed mb-3">
                      Each sentiment analysis summary provides:
                    </p>
                    <ul className="list-disc list-inside text-gray-700 space-y-2">
                      <li><strong>Key Factors:</strong> What most influenced the sentiment score</li>
                      <li><strong>Specific Concerns or Signals:</strong> Identified issues or positive indicators</li>
                      <li><strong>Relationship Trajectory:</strong> Whether sentiment is improving, declining, or stable</li>
                      <li><strong>Actionable Insights:</strong> Recommendations for account management</li>
                    </ul>
                  </section>

                  <section>
                    <h3 className="text-xl font-semibold text-gray-900 mb-3">Best Practices</h3>
                    <div className="bg-gray-50 rounded-lg p-4 space-y-2">
                      <p className="text-sm text-gray-700">
                        <strong>âœ“ Regular Monitoring:</strong> Check sentiment after important meetings or when support cases are resolved
                      </p>
                      <p className="text-sm text-gray-700">
                        <strong>âœ“ Context Matters:</strong> Review the detailed data sources to understand what influenced the score
                      </p>
                      <p className="text-sm text-gray-700">
                        <strong>âœ“ Action on Low Scores:</strong> Scores of 4 or below indicate immediate attention is needed
                      </p>
                      <p className="text-sm text-gray-700">
                        <strong>âœ“ Track Trends:</strong> Monitor sentiment over time to identify improving or declining relationships
                      </p>
                    </div>
                  </section>

                  <section className="pt-4 border-t border-gray-200">
                    <p className="text-sm text-gray-500">
                      <strong>AI Model:</strong> Google Gemini 2.5 Flash<br />
                      <strong>Analysis Framework:</strong> 5-dimensional analysis (Conversation, Support Context, Account Profile, Engagement, Overall Assessment)
                    </p>
                  </section>
                </div>
              </div>
            )}

            {/* Accounts Selection */}
            {loadingAccounts ? (
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div className="flex items-center justify-center py-8">
                  <LoaderIcon className="w-6 h-6 animate-spin text-blue-600 mr-3" />
                  <p className="text-gray-600">Loading your accounts...</p>
                </div>
              </div>
            ) : (
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                {/* My Accounts - Left Side */}
                <div className="bg-white rounded-lg shadow-lg p-6">
                  <label htmlFor="account-select" className="block text-sm font-semibold text-gray-900 mb-4">
                    ðŸ“‹ My Accounts
                  </label>
                  {accounts.length > 0 && !isSearchMode ? (
                    <select
                      id="account-select"
                      value={selectedAccount?.id || ''}
                      onChange={(e) => {
                        const account = accounts.find(acc => acc.id === e.target.value);
                        setSelectedAccount(account);
                        setCustomerIdentifier(account?.name || '');
                      }}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                      aria-label="Select Salesforce account"
                    >
                      <option value="">-- Select an account --</option>
                      {accounts.map((account) => (
                        <option key={account.id} value={account.id}>
                          {account.name} {account.accountTier ? `(${account.accountTier})` : ''}
                        </option>
                      ))}
                    </select>
                  ) : !isSearchMode ? (
                    <div className="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg" role="alert">
                      <p className="text-sm text-yellow-700">
                        No accounts assigned. Use the search to find accounts, or contact your administrator.
                      </p>
                    </div>
                  ) : (
                    <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg" role="alert">
                      <p className="text-sm text-blue-700">
                        Currently showing search results. Select an account from the search results on the right.
                      </p>
                    </div>
                  )}
                </div>

                {/* Search Section - Right Side */}
                <div className="bg-white rounded-lg shadow-lg p-6">
                  <div className="flex items-center justify-between mb-4">
                    <label htmlFor="account-search" className="block text-sm font-semibold text-gray-900">
                      {isSearchMode ? 'ðŸ” Search Results' : 'ðŸ” Search for Any Account'}
                    </label>
                    {isSearchMode && (
                      <button
                        onClick={handleClearSearch}
                        className="text-sm text-blue-600 hover:text-blue-800 underline"
                        aria-label="Clear search and show assigned accounts"
                      >
                        Show My Accounts
                      </button>
                    )}
                  </div>
                  <div className="flex gap-2 mb-4">
                    <input
                      id="account-search"
                      type="text"
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      onKeyPress={(e) => {
                        if (e.key === 'Enter') {
                          handleSearch(searchTerm);
                        }
                      }}
                      placeholder="Type account name to search (min 2 characters)..."
                      className="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                      aria-label="Search for Salesforce account"
                    />
                    <button
                      onClick={() => handleSearch(searchTerm)}
                      disabled={isSearching || !searchTerm || searchTerm.trim().length < 2}
                      className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors font-medium shadow-md"
                      aria-label="Search accounts"
                    >
                      {isSearching ? (
                        <LoaderIcon className="w-5 h-5 animate-spin" />
                      ) : (
                        'Search'
                      )}
                    </button>
                  </div>
                  {isSearchMode && accounts.length > 0 ? (
                    <>
                      <select
                        id="search-account-select"
                        value={selectedAccount?.id || ''}
                        onChange={(e) => {
                          const account = accounts.find(acc => acc.id === e.target.value);
                          setSelectedAccount(account);
                          setCustomerIdentifier(account?.name || '');
                          // useEffect will handle fetching cases and contacts when selectedAccount changes
                        }}
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                        aria-label="Select from search results"
                      >
                        <option value="">-- Select from search results --</option>
                        {accounts.map((account) => (
                          <option key={account.id} value={account.id}>
                            {account.name} {account.accountTier ? `(${account.accountTier})` : ''}
                          </option>
                        ))}
                      </select>
                      <p className="text-xs text-gray-500 mt-2">
                        Found {accounts.length} account{accounts.length !== 1 ? 's' : ''}. Select one to analyze.
                      </p>
                    </>
                  ) : isSearchMode ? (
                    <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                      <p className="text-sm text-gray-600">
                        No accounts found matching "{searchTerm}". Try a different search term.
                      </p>
                    </div>
                  ) : (
                    <p className="text-xs text-gray-500">
                      Search for any account in Salesforce by name. Results will appear here.
                    </p>
                  )}
                </div>
              </div>
            )}

            {/* Selected Account Details - Full Width Below Split */}
            {selectedAccount && (
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 className="text-sm font-semibold text-gray-900 mb-4">Selected Account Details</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4">
                  <div>
                    <span className="text-gray-600">Account:</span>
                    <span className="ml-2 font-medium text-gray-900 block">{selectedAccount.name}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">Tier:</span>
                    <span className="ml-2 font-medium text-gray-900">{selectedAccount.accountTier || 'N/A'}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">Contract Value:</span>
                    <span className="ml-2 font-medium text-gray-900">{formatCurrency(selectedAccount.contractValue)}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">Industry:</span>
                    <span className="ml-2 font-medium text-gray-900">{selectedAccount.industry || 'N/A'}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">Owner:</span>
                    <span className="ml-2 font-medium text-gray-900">{selectedAccount.ownerName || 'N/A'}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">Support Cases:</span>
                    <span className="ml-2 font-medium text-gray-900">
                      {casesLoading ? (
                        <span className="text-blue-600">Loading...</span>
                      ) : cases.length > 0 ? (
                        <button
                          onClick={() => setShowCasesList(!showCasesList)}
                          className="text-blue-600 hover:text-blue-800 underline font-semibold"
                          aria-label={`${cases.length} cases - click to ${showCasesList ? 'hide' : 'show'} list`}
                        >
                          {cases.length} case{cases.length !== 1 ? 's' : ''}
                        </button>
                      ) : (
                        '0'
                      )}
                    </span>
                  </div>
                  <div>
                    <span className="text-gray-600">Contacts:</span>
                    <span className="ml-2 font-medium text-gray-900">
                      {contactsLoading ? (
                        <span className="text-blue-600">Loading...</span>
                      ) : contacts.length > 0 ? (
                        <button
                          onClick={() => setShowContactsList(!showContactsList)}
                          className="text-blue-600 hover:text-blue-800 underline font-semibold"
                          aria-label={`${contacts.length} contacts - click to ${showContactsList ? 'hide' : 'show'} list`}
                        >
                          {contacts.length} contact{contacts.length !== 1 ? 's' : ''}
                        </button>
                      ) : (
                        '0'
                      )}
                    </span>
                  </div>
                </div>

                {/* Cases List - Expandable */}
                {cases.length > 0 && showCasesList && (
                  <div className="mt-4 pt-4 border-t border-gray-200">
                    <div className="flex items-center justify-between mb-3">
                      <h4 className="text-sm font-semibold text-gray-900">
                        Recent Support Cases ({cases.length})
                      </h4>
                      <button
                        onClick={() => setShowCasesList(false)}
                        className="text-xs text-gray-500 hover:text-gray-700"
                        aria-label="Hide cases list"
                      >
                        Hide
                      </button>
                    </div>
                    <div className="space-y-2 max-h-96 overflow-y-auto">
                      {cases.map((caseItem, idx) => {
                        // Build Salesforce URL if we have the case ID
                        const salesforceUrl = caseItem.id 
                          ? `https://leandata.my.salesforce.com/${caseItem.id}`
                          : null;
                        
                        return (
                          <div 
                            key={idx} 
                            className="bg-gray-50 rounded-lg p-3 border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-colors"
                          >
                            <div className="flex items-start justify-between gap-2">
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 mb-1">
                                  {salesforceUrl ? (
                                    <a
                                      href={salesforceUrl}
                                      target="_blank"
                                      rel="noopener noreferrer"
                                      className="font-semibold text-blue-600 hover:text-blue-800 hover:underline text-sm"
                                      onClick={(e) => e.stopPropagation()}
                                    >
                                      {caseItem.caseNumber || `Case ${idx + 1}`}
                                    </a>
                                  ) : (
                                    <span className="font-semibold text-gray-900 text-sm">
                                      {caseItem.caseNumber || `Case ${idx + 1}`}
                                    </span>
                                  )}
                                  <span className={`text-xs px-2 py-0.5 rounded-full ${
                                    caseItem.status === 'Closed' ? 'bg-green-100 text-green-800' :
                                    caseItem.status === 'Open' ? 'bg-blue-100 text-blue-800' :
                                    caseItem.priority === 'High' || caseItem.priority === 'Critical' ? 'bg-red-100 text-red-800' :
                                    'bg-gray-100 text-gray-800'
                                  }`}>
                                    {caseItem.status || 'Unknown'}
                                  </span>
                                  {caseItem.priority && (
                                    <span className="text-xs text-gray-600">
                                      {caseItem.priority} priority
                                    </span>
                                  )}
                                </div>
                                <p className="text-sm text-gray-900 font-medium mb-1">
                                  {caseItem.subject || 'No subject'}
                                </p>
                                {caseItem.createdDate && (
                                  <p className="text-xs text-gray-500">
                                    Created: {new Date(caseItem.createdDate).toLocaleDateString()}
                                    {caseItem.closedDate && (
                                      <span className="ml-2">
                                        â€¢ Closed: {new Date(caseItem.closedDate).toLocaleDateString()}
                                      </span>
                                    )}
                                  </p>
                                )}
                              </div>
                              {salesforceUrl && (
                                <a
                                  href={salesforceUrl}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="text-blue-600 hover:text-blue-800 flex-shrink-0"
                                  onClick={(e) => e.stopPropagation()}
                                  aria-label={`Open case ${caseItem.caseNumber} in Salesforce`}
                                >
                                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                  </svg>
                                </a>
                              )}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}

                {/* Contacts List - Expandable */}
                {contacts.length > 0 && showContactsList && (
                  <div className="mt-4 pt-4 border-t border-gray-200">
                    <div className="flex items-center justify-between mb-3">
                      <h4 className="text-sm font-semibold text-gray-900">
                        Account Contacts ({contacts.length})
                      </h4>
                      <button
                        onClick={() => setShowContactsList(false)}
                        className="text-xs text-gray-500 hover:text-gray-700"
                        aria-label="Hide contacts list"
                      >
                        Hide
                      </button>
                    </div>
                    <div className="space-y-2 max-h-96 overflow-y-auto">
                      {contacts.map((contact, idx) => {
                        // Build Salesforce URL if we have the contact ID
                        const salesforceUrl = contact.id 
                          ? `https://leandata.my.salesforce.com/${contact.id}`
                          : null;
                        
                        return (
                          <div 
                            key={idx} 
                            className="bg-gray-50 rounded-lg p-3 border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-colors"
                          >
                            <div className="flex items-start justify-between gap-2">
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 mb-1">
                                  {salesforceUrl ? (
                                    <a
                                      href={salesforceUrl}
                                      target="_blank"
                                      rel="noopener noreferrer"
                                      className="font-semibold text-blue-600 hover:text-blue-800 hover:underline text-sm"
                                      onClick={(e) => e.stopPropagation()}
                                    >
                                      {contact.name || `${contact.firstName || ''} ${contact.lastName || ''}`.trim() || 'Contact'}
                                    </a>
                                  ) : (
                                    <span className="font-semibold text-gray-900 text-sm">
                                      {contact.name || `${contact.firstName || ''} ${contact.lastName || ''}`.trim() || 'Contact'}
                                    </span>
                                  )}
                                  {contact.contactStatus && (
                                    <span className={`text-xs px-2 py-0.5 rounded-full ${
                                      contact.contactStatus === 'Unqualified' 
                                        ? 'bg-red-100 text-red-800' 
                                        : 'bg-green-100 text-green-800'
                                    }`}>
                                      {contact.contactStatus}
                                    </span>
                                  )}
                                </div>
                                {contact.title && (
                                  <p className="text-xs text-gray-600 mb-1">{contact.title}</p>
                                )}
                                <div className="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-500">
                                  {contact.email && (
                                    <a 
                                      href={`mailto:${contact.email}`}
                                      className="text-blue-600 hover:text-blue-800 hover:underline"
                                    >
                                      {contact.email}
                                    </a>
                                  )}
                                  {contact.phone && (
                                    <a 
                                      href={`tel:${contact.phone}`}
                                      className="text-blue-600 hover:text-blue-800 hover:underline"
                                    >
                                      {contact.phone}
                                    </a>
                                  )}
                                  {contact.mobilePhone && !contact.phone && (
                                    <a 
                                      href={`tel:${contact.mobilePhone}`}
                                      className="text-blue-600 hover:text-blue-800 hover:underline"
                                    >
                                      {contact.mobilePhone} (mobile)
                                    </a>
                                  )}
                                </div>
                              </div>
                              {salesforceUrl && (
                                <a
                                  href={salesforceUrl}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="text-blue-600 hover:text-blue-800 flex-shrink-0"
                                  onClick={(e) => e.stopPropagation()}
                                  aria-label={`Open contact ${contact.name} in Salesforce`}
                                >
                                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                  </svg>
                                </a>
                              )}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Input Section */}
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <label htmlFor="customer-id" className="block text-sm font-medium text-gray-700 mb-2">
                Customer ID or Account Name
              </label>
              <div className="flex gap-4">
                <input
                  id="customer-id"
                  type="text"
                  value={customerIdentifier}
                  onChange={(e) => setCustomerIdentifier(e.target.value)}
                  className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                  placeholder={selectedAccount ? selectedAccount.name : "Enter customer identifier"}
                  disabled={loading || !selectedAccount}
                  aria-label="Customer ID or Account Name"
                  aria-required="true"
                  maxLength={200}
                />
                <button
                  onClick={handleAnalyze}
                  disabled={loading || !selectedAccount || !customerIdentifier}
                  className="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2 min-w-[140px] justify-center"
                  aria-label={loading ? 'Analyzing sentiment' : 'Analyze customer sentiment'}
                  aria-busy={loading}
                >
                  {loading ? (
                    <>
                      <LoaderIcon className="w-5 h-5 animate-spin" />
                      <span>Analyzing...</span>
                    </>
                  ) : (
                    'Analyze Sentiment'
                  )}
                </button>
              </div>
            </div>

            {/* Error Display */}
            {error && (
              <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg mb-6" role="alert" aria-live="polite">
                <div className="flex">
                  <div className="flex-shrink-0" aria-hidden="true">
                    <svg className="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                      <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                    </svg>
                  </div>
                  <div className="ml-3 flex-1">
                    <p className="text-sm text-red-700 font-medium">Error</p>
                    <p className="text-sm text-red-600 mt-1">{error}</p>
                    {retryCount > 0 && retryCount < maxRetries && (
                      <div className="mt-3">
                        <button
                          onClick={() => handleAnalyze(retryCount)}
                          className="text-sm text-red-700 hover:text-red-900 font-medium underline"
                          aria-label={`Retry analysis (attempt ${retryCount + 1} of ${maxRetries})`}
                        >
                          Retry ({retryCount}/{maxRetries})
                        </button>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* Results Display - Now shown on separate Results Page */}
            {false && sentiment && (
              <div className="bg-white rounded-lg shadow-lg p-8" role="region" aria-live="polite" aria-label="Sentiment analysis results">
                {/* Score Display */}
                <div className={`text-center mb-6 p-8 rounded-xl border-2 ${getScoreColor(sentiment.score)}`} role="status">
                  <div className="text-6xl font-bold mb-2" aria-label={`Sentiment score: ${sentiment.score} out of 10`}>
                    {sentiment.score}
                  </div>
                  <div className="text-xl font-semibold text-gray-600">
                    / 10
                  </div>
                </div>

                {/* Summary Display */}
                <div className={`rounded-lg p-6 ${getScoreBgColor(sentiment.score)}`}>
                  <div className="flex items-start gap-3">
                    {sentiment.score >= 8 ? (
                      <TrendingUpIcon className="w-6 h-6 text-green-600 flex-shrink-0 mt-1" />
                    ) : (
                      <TrendingDownIcon className="w-6 h-6 text-red-600 flex-shrink-0 mt-1" />
                    )}
                    <div className="flex-1">
                      <h3 className="font-semibold text-gray-900 mb-2">Sentiment Summary</h3>
                      <p className="text-gray-700 leading-relaxed">{sentiment.summary}</p>
                    </div>
                  </div>
                </div>

                {/* Data Sources Explanation */}
                {dataSources && (
                  <div className="mt-6 pt-6 border-t border-gray-200">
                    <h4 className="text-sm font-semibold text-gray-900 mb-3">Analysis Data Sources</h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                      <div className="space-y-2">
                        <div className="flex items-center gap-2">
                          {dataSources.hasTranscription ? (
                            <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                          ) : (
                            <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          )}
                          <span className="font-medium text-gray-700">Avoma Transcription</span>
                        </div>
                        {dataSources.hasTranscription ? (
                          <p className="text-gray-600 ml-7">
                            {dataSources.transcriptionLength.toLocaleString()} characters from customer call/meeting
                            {dataSources.avomaCallsTotal > 0 && (
                              <span className="block mt-1 text-xs text-gray-500">
                                Found {dataSources.avomaCallsTotal} meeting{dataSources.avomaCallsTotal !== 1 ? 's' : ''} 
                                {dataSources.avomaCallsReady > 0 && ` (${dataSources.avomaCallsReady} with ready transcripts)`}
                              </span>
                            )}
                          </p>
                        ) : (
                          <p className="text-gray-500 ml-7 text-xs">No transcription available</p>
                        )}
                      </div>

                      <div className="space-y-2">
                        <div className="flex items-center gap-2">
                          {dataSources.hasAccountData ? (
                            <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                          ) : (
                            <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          )}
                          <span className="font-medium text-gray-700">Salesforce Account</span>
                        </div>
                        {dataSources.hasAccountData ? (
                          <p className="text-gray-600 ml-7">
                            {dataSources.accountName}
                            {dataSources.casesCount > 0 && (
                              <span className="block mt-1 text-xs text-gray-500">
                                {dataSources.casesCount} support case{dataSources.casesCount !== 1 ? 's' : ''} found
                              </span>
                            )}
                          </p>
                        ) : (
                          <p className="text-gray-500 ml-7 text-xs">No account data available</p>
                        )}
                      </div>
                    </div>
                    <div className="mt-4 pt-4 border-t border-gray-100">
                      <p className="text-xs text-gray-500 mb-3">
                        <strong>AI Analysis:</strong> Powered by Google Gemini 2.5 Flash, analyzing conversation tone, 
                        customer language, and account context to generate sentiment score.
                      </p>
                      <button
                        onClick={() => setShowDataDetails(!showDataDetails)}
                        className="text-xs text-blue-600 hover:text-blue-800 font-medium underline flex items-center gap-1"
                        aria-expanded={showDataDetails}
                        aria-label={showDataDetails ? 'Hide data details' : 'Show data details'}
                      >
                        {showDataDetails ? (
                          <>
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                            </svg>
                            Hide Data Used in Analysis
                          </>
                        ) : (
                          <>
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                            </svg>
                            Show Data Used in Analysis
                          </>
                        )}
                      </button>
                    </div>
                  </div>
                )}

                {/* Detailed Data View */}
                {showDataDetails && analysisData && (
                  <div className="mt-6 pt-6 border-t border-gray-300">
                    <h4 className="text-sm font-semibold text-gray-900 mb-4">Exact Data Analyzed</h4>
                    
                    <div className="space-y-4">
                      {/* Transcription Data */}
                      <div className="bg-gray-50 rounded-lg p-4">
                        <div className="flex items-center justify-between mb-2">
                          <h5 className="text-xs font-semibold text-gray-700 uppercase tracking-wide">
                            Avoma Transcription ({analysisData.transcription.length.toLocaleString()} characters)
                          </h5>
                          <span className="text-xs text-gray-500">
                            {Math.round(analysisData.transcription.length / 5)} words
                          </span>
                        </div>
                        <div className="bg-white rounded border border-gray-200 p-3 max-h-64 overflow-y-auto">
                          <pre className="text-xs text-gray-700 whitespace-pre-wrap font-mono">
                            {analysisData.transcriptionPreview}
                            {analysisData.transcription.length > 500 && (
                              <span className="text-gray-400 italic">
                                {'\n\n[... ' + (analysisData.transcription.length - 500).toLocaleString() + ' more characters ...]'}
                              </span>
                            )}
                          </pre>
                        </div>
                      </div>

                      {/* Salesforce Context */}
                      <div className="bg-gray-50 rounded-lg p-4">
                        <h5 className="text-xs font-semibold text-gray-700 uppercase tracking-wide mb-3">
                          Salesforce Account Context
                        </h5>
                        <div className="bg-white rounded border border-gray-200 p-3">
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
                            {analysisData.salesforceContext.account_name && (
                              <div>
                                <span className="font-medium text-gray-600">Account:</span>
                                <span className="ml-2 text-gray-900">{analysisData.salesforceContext.account_name}</span>
                              </div>
                            )}
                            {analysisData.salesforceContext.account_tier && (
                              <div>
                                <span className="font-medium text-gray-600">Tier:</span>
                                <span className="ml-2 text-gray-900">{analysisData.salesforceContext.account_tier}</span>
                              </div>
                            )}
                            {analysisData.salesforceContext.contract_value && (
                              <div>
                                <span className="font-medium text-gray-600">Contract Value:</span>
                                <span className="ml-2 text-gray-900">{formatCurrency(analysisData.salesforceContext.contract_value)}</span>
                              </div>
                            )}
                            {analysisData.salesforceContext.industry && (
                              <div>
                                <span className="font-medium text-gray-600">Industry:</span>
                                <span className="ml-2 text-gray-900">{analysisData.salesforceContext.industry}</span>
                              </div>
                            )}
                            {analysisData.salesforceContext.annual_revenue && (
                              <div>
                                <span className="font-medium text-gray-600">Annual Revenue:</span>
                                <span className="ml-2 text-gray-900">
                                  ${analysisData.salesforceContext.annual_revenue.toLocaleString()}
                                </span>
                              </div>
                            )}
                            {analysisData.salesforceContext.account_manager && (
                              <div>
                                <span className="font-medium text-gray-600">Account Manager:</span>
                                <span className="ml-2 text-gray-900">{analysisData.salesforceContext.account_manager}</span>
                              </div>
                            )}
                            {analysisData.salesforceContext.total_cases_count !== undefined && (
                              <div>
                                <span className="font-medium text-gray-600">Support Cases:</span>
                                <span className="ml-2 text-gray-900">{analysisData.salesforceContext.total_cases_count}</span>
                              </div>
                            )}
                            {analysisData.salesforceContext.total_avoma_calls !== undefined && (
                              <div>
                                <span className="font-medium text-gray-600">Avoma Meetings:</span>
                                <span className="ml-2 text-gray-900">
                                  {analysisData.salesforceContext.ready_avoma_calls || 0} ready / {analysisData.salesforceContext.total_avoma_calls} total
                                </span>
                              </div>
                            )}
                          </div>

                          {/* Recent Tickets */}
                          {analysisData.salesforceContext.recent_tickets && 
                           analysisData.salesforceContext.recent_tickets.length > 0 && (
                            <div className="mt-4 pt-4 border-t border-gray-200">
                              <div className="flex items-center justify-between mb-2">
                                <span className="text-xs font-semibold text-gray-700">
                                  Recent Support Cases ({analysisData.salesforceContext.recent_tickets.length})
                                </span>
                              </div>
                              <div className="space-y-2">
                                {analysisData.salesforceContext.recent_tickets.slice(0, 5).map((ticket, idx) => (
                                  <div key={idx} className="text-xs bg-gray-50 rounded p-2">
                                    <div className="flex items-center justify-between">
                                      <span className="font-medium text-gray-900">{ticket.subject || 'No subject'}</span>
                                      <span className="text-gray-500">{ticket.status || 'Unknown'}</span>
                                    </div>
                                    {ticket.priority && (
                                      <div className="text-gray-600 mt-1">
                                        Priority: <span className="font-medium">{ticket.priority}</span>
                                        {ticket.created_date && (
                                          <span className="ml-2 text-gray-500">
                                            â€¢ {new Date(ticket.created_date).toLocaleDateString()}
                                          </span>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                ))}
                                {analysisData.salesforceContext.recent_tickets.length > 5 && (
                                  <p className="text-xs text-gray-500 italic mt-2">
                                    ... and {analysisData.salesforceContext.recent_tickets.length - 5} more case{analysisData.salesforceContext.recent_tickets.length - 5 !== 1 ? 's' : ''}
                                  </p>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Data Summary Stats */}
                      <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <h5 className="text-xs font-semibold text-blue-900 uppercase tracking-wide mb-2">
                          Data Summary
                        </h5>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                          <div>
                            <div className="text-blue-600 font-medium">Transcription</div>
                            <div className="text-blue-900">{analysisData.transcription.length.toLocaleString()} chars</div>
                          </div>
                          <div>
                            <div className="text-blue-600 font-medium">Account Fields</div>
                            <div className="text-blue-900">
                              {Object.keys(analysisData.salesforceContext).filter(k => 
                                !['recent_tickets', 'account_id'].includes(k) && 
                                analysisData.salesforceContext[k] !== null
                              ).length} provided
                            </div>
                          </div>
                          <div>
                            <div className="text-blue-600 font-medium">Support Cases</div>
                            <div className="text-blue-900">
                              {analysisData.salesforceContext.recent_tickets?.length || 0} cases
                            </div>
                          </div>
                          <div>
                            <div className="text-blue-600 font-medium">Total Context</div>
                            <div className="text-blue-900">
                              {(
                                analysisData.transcription.length + 
                                JSON.stringify(analysisData.salesforceContext).length
                              ).toLocaleString()} chars
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Footer Note */}
            <div className="mt-8 text-center">
              <p className="text-xs text-gray-500">
                âœ… Sentiment analysis is securely handled via Vercel Serverless Function
              </p>
            </div>
          </div>
        </div>
      );
    };

    // Error Boundary Component
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }

      componentDidCatch(error, errorInfo) {
        logError('Error Boundary caught an error:', error, errorInfo);
      }

      render() {
        if (this.state.hasError) {
          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center px-4">
              <div className="max-w-md w-full bg-white rounded-lg shadow-xl p-8 text-center">
                <div className="mb-4">
                  <svg className="mx-auto h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                </div>
                <h1 className="text-2xl font-bold text-gray-900 mb-2">Something went wrong</h1>
                <p className="text-gray-600 mb-6">
                  An unexpected error occurred. Please refresh the page to try again.
                </p>
                <button
                  onClick={() => {
                    this.setState({ hasError: false, error: null });
                    window.location.reload();
                  }}
                  className="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                >
                  Refresh Page
                </button>
              </div>
            </div>
          );
        }

        return this.props.children;
      }
    }

    // Analytics helper (structure for future integration)
    const analytics = {
      track: (event, data) => {
        if (isProduction) {
          // In production, send to analytics service
          // Example: gtag('event', event, data);
          log('Analytics:', event, data);
        } else {
          log('Analytics (dev):', event, data);
        }
      },
      pageView: (page) => {
        analytics.track('page_view', { page });
      }
    };

    // Main App Component with Authentication
    const App = () => {
      const [user, setUser] = useState(() => {
        // Check if user is already logged in
        const savedUser = localStorage.getItem('userInfo');
        if (savedUser) {
          try {
            return JSON.parse(savedUser);
          } catch (error) {
            logError('Error parsing saved user info:', error);
            localStorage.removeItem('userInfo');
            return null;
          }
        }
        return null;
      });

      useEffect(() => {
        analytics.pageView(user ? 'dashboard' : 'login');
      }, [user]); // eslint-disable-line react-hooks/exhaustive-deps

      const handleSignIn = async (userInfo) => {
        try {
          // Create or get user from backend
          const response = await fetch('/api/users', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: userInfo.email,
              name: userInfo.name,
              picture: userInfo.picture,
              sub: userInfo.sub,
            }),
          });

          if (!response.ok) {
            throw new Error('Failed to create user');
          }

          const userData = await response.json();
          
          // Save user info to localStorage
          localStorage.setItem('userInfo', JSON.stringify(userData));
          setUser(userData);
          analytics.track('user_signed_in', { email: userData.email, userId: userData.id });
        } catch (error) {
          logError('Error creating user:', error);
          // Fallback to saving Google user info if API fails
          localStorage.setItem('userInfo', JSON.stringify(userInfo));
          setUser(userInfo);
          analytics.track('user_signed_in', { email: userInfo.email });
        }
      };

      if (!user) {
        return <LoginPage onSignIn={handleSignIn} />;
      }

      return <SentimentAnalyzer user={user} />;
    };

    // Register Service Worker for offline support
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            log('Service Worker registered:', registration.scope);
            
            // Check for service worker updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              if (newWorker) {
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // New service worker available, reload to use it
                    log('New service worker available, reloading...');
                    window.location.reload();
                  }
                });
              }
            });
            
            // Listen for messages from service worker
            navigator.serviceWorker.addEventListener('message', (event) => {
              if (event.data && event.data.type === 'SW_UPDATED') {
                log('Service worker updated, reloading...');
                window.location.reload();
              }
            });
          })
          .catch((error) => {
            logError('Service Worker registration failed:', error);
          });
      });
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
      <ErrorBoundary>
        <App />
      </ErrorBoundary>
    );
  </script>
</body>
</html>

