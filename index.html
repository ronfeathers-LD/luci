<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Customer Pulse Dashboard - Analyze customer sentiment from Avoma transcripts and Salesforce context using AI-powered sentiment analysis">
  <meta name="keywords" content="customer sentiment, sentiment analysis, customer experience, Avoma, Salesforce">
  <meta name="author" content="LeanData">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Customer Pulse Dashboard">
  <meta property="og:description" content="AI-powered customer sentiment analysis from Avoma transcripts and Salesforce context">
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Customer Pulse Dashboard">
  <meta name="twitter:description" content="AI-powered customer sentiment analysis">
  
  <title>Customer Pulse Dashboard</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useCallback, useEffect, useRef } = React;

    // Google OAuth Configuration
    // In production, consider moving this to an environment variable
    const GOOGLE_CLIENT_ID = window.GOOGLE_CLIENT_ID || '160384595408-625gmnr4j40cgjp44qkfljoeo6i0n7j9.apps.googleusercontent.com';
    
    // Constants
    const MAX_RETRIES = 50;
    const MAX_INIT_ATTEMPTS = 100;
    const RETRY_DELAY = 100;
    const INIT_DELAY = 100;
    
    // Production check
    const isProduction = window.location.hostname !== 'localhost' && !window.location.hostname.includes('127.0.0.1');
    
    // Console logging helper (disabled in production)
    const log = (...args) => {
      if (!isProduction) {
        console.log(...args);
      }
    };
    
    const logError = (...args) => {
      console.error(...args); // Always log errors
    };

    /**
     * Customer Sentiment Analyzer
     * 
     * âš ï¸ PRODUCTION NOTE: The analyzeSentiment function contains sensitive API logic
     * and should be moved to a secure Vercel Serverless Function in production
     * to protect your Gemini API key and prevent client-side exposure.
     */

    // Mock: Fetch Avoma transcription data
    const fetchAvomaData = async (customerIdentifier) => {
      // Simulate API delay
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Return hardcoded transcription showing customer journey from upset to placated
      return `[Avoma Transcription - ${customerIdentifier}]

Rep: Good morning, thank you for taking the time to speak with me today. How can I help you?

Customer: I'm really frustrated. We've been experiencing constant downtime with your service over the past two weeks, and it's impacting our operations significantly. This is unacceptable for an Enterprise account.

Rep: I completely understand your frustration, and I sincerely apologize for the inconvenience. Let me pull up your account details right away.

Customer: We're paying a premium for this service, and frankly, I'm considering looking at alternatives if this continues.

Rep: I absolutely hear you. I can see here that you're on our Enterprise Tier 1 plan with a $120,000 annual contract. I want to make sure we resolve this immediately. I'm going to escalate this to our technical team right now, and I'm also going to apply a $5,000 service credit to your account for the downtime you've experienced.

Customer: Well, that's a start, but I need to understand what's actually causing these issues.

Rep: Of course. Our technical team has identified that the issue was related to a recent infrastructure update that affected a small subset of Enterprise accounts. We've rolled back the changes and implemented additional monitoring. The root cause has been resolved, and we've added safeguards to prevent this from happening again.

Customer: Okay, that makes sense. And you're confident this won't happen again?

Rep: Yes, absolutely. We've implemented additional redundancy and monitoring specifically for Enterprise accounts. I'll also personally follow up with you in 48 hours to ensure everything is running smoothly. Is there anything else I can help you with today?

Customer: No, that addresses my concerns. Thank you for the quick response and the credit. I appreciate it.

Rep: You're very welcome. Thank you for your patience, and please don't hesitate to reach out if you need anything else.`;
    };

    // Mock: Fetch Salesforce customer context
    const fetchSalesforceData = async (customerIdentifier, accountData = null) => {
      // Simulate API delay
      await new Promise(resolve => setTimeout(resolve, 400));
      
      // Use account data if provided, otherwise use defaults
      const baseData = accountData ? {
        account_tier: accountData.accountTier || "Enterprise (Tier 1)",
        contract_value: accountData.contractValue || "$120,000/year",
        account_id: accountData.id,
        account_name: accountData.name,
        industry: accountData.industry,
        annual_revenue: accountData.annualRevenue,
        account_manager: accountData.ownerName || "Sarah Johnson",
      } : {
        account_tier: "Enterprise (Tier 1)",
        contract_value: "$120,000/year",
        account_manager: "Sarah Johnson",
      };
      
      // Return Salesforce context with account data
      return {
        ...baseData,
        contract_start_date: "2023-01-15",
        renewal_date: "2025-01-15",
        recent_tickets: [
          {
            id: "TKT-12345",
            subject: "Service Interruption - Multiple Outages",
            status: "Resolved",
            created_date: "2024-09-10",
            priority: "High"
          },
          {
            id: "TKT-12346",
            subject: "Performance Degradation",
            status: "Resolved",
            created_date: "2024-09-12",
            priority: "Medium"
          }
        ],
        customer_since: "2023-01-15",
        nps_score: 7,
        last_interaction: "2024-09-15"
      };
    };

    // Analyze sentiment using secure Vercel Serverless Function
    const analyzeSentiment = async (transcription, salesforceContext) => {
      const response = await fetch('/api/analyze-sentiment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          transcription,
          salesforceContext
        })
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
        throw new Error(errorData.error || `Server error: ${response.status}`);
      }

      const result = await response.json();
      
      // Validate score is within range
      if (result.score < 1 || result.score > 10) {
        throw new Error('Invalid sentiment score returned from API');
      }

      return result;
    };

    // Icon Components
    const TrendingUpIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline>
        <polyline points="16 7 22 7 22 13"></polyline>
      </svg>
    );

    const TrendingDownIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="22 17 13.5 8.5 8.5 13.5 2 7"></polyline>
        <polyline points="16 17 22 17 22 11"></polyline>
      </svg>
    );

    const LoaderIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="2" x2="12" y2="6"></line>
        <line x1="12" y1="18" x2="12" y2="22"></line>
        <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
        <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
        <line x1="2" y1="12" x2="6" y2="12"></line>
        <line x1="18" y1="12" x2="22" y2="12"></line>
        <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
        <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
      </svg>
    );

    // Login Component
    const LoginPage = ({ onSignIn }) => {
      const buttonRef = useRef(null);
      const [isLoading, setIsLoading] = useState(true);
      const [error, setError] = useState(null);
      const retryCountRef = useRef(0);
      const [buttonReady, setButtonReady] = useState(false);

      const handleCredentialResponse = useCallback((response) => {
        // Decode the JWT token to get user info
        try {
          const base64Url = response.credential.split('.')[1];
          const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split('')
              .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
              .join('')
          );
          const userInfo = JSON.parse(jsonPayload);
          onSignIn(userInfo);
        } catch (error) {
          logError('Error decoding credential:', error);
          setError('Error signing in. Please try again.');
        }
      }, [onSignIn]);

      // Wait for Google Identity Services to load and initialize
      useEffect(() => {
        let isMounted = true;
        let initAttempts = 0;

        const waitForGoogleAndInit = () => {
          initAttempts++;
          
          if (window.google && window.google.accounts && window.google.accounts.id) {
            try {
              // Initialize Google Sign-In
              window.google.accounts.id.initialize({
                client_id: GOOGLE_CLIENT_ID,
                callback: handleCredentialResponse,
              });
              log('Google Sign-In initialized successfully');
              
              // Now try to render the button
              if (isMounted) {
                renderButton();
              }
            } catch (err) {
              logError('Error initializing Google Sign-In:', err);
              if (isMounted) {
                setError(`Failed to initialize: ${err.message}`);
                setIsLoading(false);
              }
            }
          } else if (initAttempts < MAX_INIT_ATTEMPTS) {
            // Keep waiting for Google Identity Services to load
            setTimeout(waitForGoogleAndInit, INIT_DELAY);
          } else {
            logError('Google Identity Services failed to load after', MAX_INIT_ATTEMPTS, 'attempts');
            if (isMounted) {
              setError('Google Sign-In script failed to load. Please check your internet connection and refresh the page.');
              setIsLoading(false);
            }
          }
        };

        const renderButton = () => {
          if (!isMounted || !buttonReady) {
            // Wait for button to be ready
            if (retryCountRef.current < MAX_RETRIES) {
              retryCountRef.current++;
              setTimeout(renderButton, RETRY_DELAY);
            }
            return;
          }
          
          if (buttonRef.current && window.google && window.google.accounts && window.google.accounts.id) {
            try {
              // Clear any existing content
              buttonRef.current.innerHTML = '';
              
              window.google.accounts.id.renderButton(
                buttonRef.current,
                {
                  theme: 'outline',
                  size: 'large',
                  width: buttonRef.current.offsetWidth || 320,
                  text: 'signin_with',
                }
              );
              log('Google Sign-In button rendered successfully');
              setIsLoading(false);
            } catch (err) {
              logError('Error rendering button:', err);
              if (isMounted) {
                setError(`Failed to render button: ${err.message}. Please check that your domain is authorized in Google OAuth settings.`);
                setIsLoading(false);
              }
            }
          } else if (retryCountRef.current < MAX_RETRIES) {
            retryCountRef.current++;
            setTimeout(renderButton, RETRY_DELAY);
          } else {
            if (!buttonRef.current) {
              logError('Button ref is null');
              if (isMounted) {
                setError('Button element not found. Please refresh the page.');
                setIsLoading(false);
              }
            } else if (!window.google || !window.google.accounts) {
              logError('Google Identity Services not loaded');
              if (isMounted) {
                setError('Google Sign-In script not loaded. Please check your connection.');
                setIsLoading(false);
              }
            } else {
              logError('Unknown error rendering button');
              if (isMounted) {
                setError('Failed to load sign-in button. Please refresh the page.');
                setIsLoading(false);
              }
            }
          }
        };

        // Start waiting for Google Identity Services
        waitForGoogleAndInit();

        return () => {
          isMounted = false;
        };
      }, [handleCredentialResponse, buttonReady]);

      // Set button ready when ref is attached
      useEffect(() => {
        if (buttonRef.current) {
          setButtonReady(true);
        }
      }, []);

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center px-4">
          <div className="max-w-md w-full bg-white rounded-lg shadow-xl p-8">
            <div className="text-center mb-8">
              <h1 className="text-3xl font-bold text-gray-900 mb-2">
                Customer Pulse Dashboard
              </h1>
              <p className="text-gray-600">
                Please sign in to continue
              </p>
            </div>
            <div className="space-y-4">
              {/* Always render the button container so ref is available */}
              <div ref={buttonRef} className="w-full" style={{ minHeight: '40px' }}></div>
              
              {isLoading && (
                <div className="flex flex-col items-center justify-center py-2">
                  <LoaderIcon className="w-5 h-5 animate-spin text-blue-600 mb-1" />
                  <p className="text-xs text-gray-500">Loading sign-in...</p>
                </div>
              )}
              
              {error && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                  <p className="text-sm text-red-700">{error}</p>
                  <button
                    onClick={() => window.location.reload()}
                    className="mt-2 text-sm text-red-600 hover:text-red-800 underline"
                  >
                    Refresh page
                  </button>
                </div>
              )}
            </div>
            <p className="text-xs text-gray-500 text-center mt-6">
              By signing in, you agree to our terms of service and privacy policy.
            </p>
          </div>
        </div>
      );
    };

    const SentimentAnalyzer = ({ user }) => {
      const [accounts, setAccounts] = useState([]);
      const [selectedAccount, setSelectedAccount] = useState(null);
      const [loadingAccounts, setLoadingAccounts] = useState(true);
      const [customerIdentifier, setCustomerIdentifier] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [sentiment, setSentiment] = useState(null);
      const [retryCount, setRetryCount] = useState(0);
      const maxRetries = 3;

      // Fetch Salesforce accounts on mount
      useEffect(() => {
        const fetchAccounts = async () => {
          if (!user?.id && !user?.email) {
            setLoadingAccounts(false);
            return;
          }

          try {
            setLoadingAccounts(true);
            const params = new URLSearchParams({
              userId: user.id || '',
              email: user.email || '',
              role: user.role || '',
            });

            const response = await fetch(`/api/salesforce-accounts?${params}`);
            
            if (!response.ok) {
              throw new Error('Failed to fetch accounts');
            }

            const data = await response.json();
            setAccounts(data.accounts || []);
            
            // Auto-select first account if available
            if (data.accounts && data.accounts.length > 0) {
              setSelectedAccount(data.accounts[0]);
              setCustomerIdentifier(data.accounts[0].name);
            }
            
            analytics.track('accounts_loaded', { 
              count: data.accounts?.length || 0,
              userId: user.id 
            });
          } catch (err) {
            logError('Error fetching accounts:', err);
            setError('Failed to load accounts. Please refresh the page.');
          } finally {
            setLoadingAccounts(false);
          }
        };

        fetchAccounts();
      }, [user]);

      const handleAnalyze = useCallback(async (attempt = 0) => {
        setLoading(true);
        setError(null);
        if (attempt === 0) {
          setSentiment(null);
        }

        try {
          // Fetch data from both sources in parallel
          const [transcription, salesforceContext] = await Promise.all([
            fetchAvomaData(customerIdentifier),
            fetchSalesforceData(customerIdentifier, selectedAccount)
          ]);

          // Analyze sentiment
          const result = await analyzeSentiment(transcription, salesforceContext);
          setSentiment(result);
          setRetryCount(0);
          analytics.track('sentiment_analyzed', { 
            customerIdentifier,
            score: result.score 
          });
        } catch (err) {
          const errorMessage = err.message || 'An error occurred while analyzing sentiment';
          setError(errorMessage);
          logError('Sentiment analysis error:', err);
          
          if (attempt < maxRetries && (err.message?.includes('timeout') || err.message?.includes('network'))) {
            setRetryCount(attempt + 1);
            analytics.track('sentiment_analysis_retry', { attempt: attempt + 1 });
          } else {
            setRetryCount(0);
            analytics.track('sentiment_analysis_failed', { error: errorMessage });
          }
        } finally {
          setLoading(false);
        }
      }, [customerIdentifier]);

      const getScoreColor = (score) => {
        if (score <= 4) return 'text-red-600 bg-red-50 border-red-200';
        if (score <= 7) return 'text-yellow-600 bg-yellow-50 border-yellow-200';
        return 'text-green-600 bg-green-50 border-green-200';
      };

      const getScoreBgColor = (score) => {
        if (score <= 4) return 'bg-red-100';
        if (score <= 7) return 'bg-yellow-100';
        return 'bg-green-100';
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-12 px-4 sm:px-6 lg:px-8">
          <div className="max-w-4xl mx-auto">
            {/* Header with User Info and Logout */}
            <div className="mb-8">
              <div className="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
                <div className="text-center sm:text-left">
                  <h1 className="text-4xl font-bold text-gray-900 mb-2">
                    Customer Pulse Dashboard
                  </h1>
                  <p className="text-lg text-gray-600">
                    Avoma Transcript & Salesforce Context Sentiment Analysis
                  </p>
                </div>
                <div className="flex items-center gap-4 bg-white px-4 py-2 rounded-lg shadow-sm">
                  <div className="text-right">
                    <p className="text-sm font-medium text-gray-900">
                      {user?.name || 'User'}
                    </p>
                    <p className="text-xs text-gray-500">
                      {user?.email}
                    </p>
                    {user?.role && (
                      <p className="text-xs text-blue-600 font-medium">
                        {user.role}
                      </p>
                    )}
                  </div>
                  <button
                    onClick={() => {
                      window.google?.accounts?.id.disableAutoSelect();
                      localStorage.removeItem('userInfo');
                      window.location.reload();
                    }}
                    className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-50 border border-gray-300 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all whitespace-nowrap"
                  >
                    Sign Out
                  </button>
                </div>
              </div>
            </div>

            {/* Accounts Selection */}
            {loadingAccounts ? (
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div className="flex items-center justify-center py-8">
                  <LoaderIcon className="w-6 h-6 animate-spin text-blue-600 mr-3" />
                  <p className="text-gray-600">Loading your accounts...</p>
                </div>
              </div>
            ) : accounts.length > 0 ? (
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <label htmlFor="account-select" className="block text-sm font-medium text-gray-700 mb-2">
                  Select Account
                </label>
                <select
                  id="account-select"
                  value={selectedAccount?.id || ''}
                  onChange={(e) => {
                    const account = accounts.find(acc => acc.id === e.target.value);
                    setSelectedAccount(account);
                    setCustomerIdentifier(account?.name || '');
                  }}
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all mb-4"
                  aria-label="Select Salesforce account"
                >
                  <option value="">-- Select an account --</option>
                  {accounts.map((account) => (
                    <option key={account.id} value={account.id}>
                      {account.name} ({account.accountTier})
                    </option>
                  ))}
                </select>
                
                {selectedAccount && (
                  <div className="bg-gray-50 rounded-lg p-4 mb-4">
                    <h3 className="text-sm font-semibold text-gray-900 mb-2">Account Details</h3>
                    <div className="grid grid-cols-2 gap-4 text-sm">
                      <div>
                        <span className="text-gray-600">Tier:</span>
                        <span className="ml-2 font-medium text-gray-900">{selectedAccount.accountTier}</span>
                      </div>
                      <div>
                        <span className="text-gray-600">Contract Value:</span>
                        <span className="ml-2 font-medium text-gray-900">{selectedAccount.contractValue}</span>
                      </div>
                      <div>
                        <span className="text-gray-600">Industry:</span>
                        <span className="ml-2 font-medium text-gray-900">{selectedAccount.industry || 'N/A'}</span>
                      </div>
                      <div>
                        <span className="text-gray-600">Owner:</span>
                        <span className="ml-2 font-medium text-gray-900">{selectedAccount.ownerName || 'N/A'}</span>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            ) : (
              <div className="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg mb-6" role="alert">
                <p className="text-sm text-yellow-700">
                  No accounts found. Please contact your administrator to assign accounts to your role.
                </p>
              </div>
            )}

            {/* Input Section */}
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <label htmlFor="customer-id" className="block text-sm font-medium text-gray-700 mb-2">
                Customer ID or Account Name
              </label>
              <div className="flex gap-4">
                <input
                  id="customer-id"
                  type="text"
                  value={customerIdentifier}
                  onChange={(e) => setCustomerIdentifier(e.target.value)}
                  className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                  placeholder={selectedAccount ? selectedAccount.name : "Enter customer identifier"}
                  disabled={loading || !selectedAccount}
                  aria-label="Customer ID or Account Name"
                  aria-required="true"
                  maxLength={200}
                />
                <button
                  onClick={handleAnalyze}
                  disabled={loading || !selectedAccount || !customerIdentifier}
                  className="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2 min-w-[140px] justify-center"
                  aria-label={loading ? 'Analyzing sentiment' : 'Analyze customer sentiment'}
                  aria-busy={loading}
                >
                  {loading ? (
                    <>
                      <LoaderIcon className="w-5 h-5 animate-spin" />
                      <span>Analyzing...</span>
                    </>
                  ) : (
                    'Analyze Sentiment'
                  )}
                </button>
              </div>
            </div>

            {/* Error Display */}
            {error && (
              <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg mb-6" role="alert" aria-live="polite">
                <div className="flex">
                  <div className="flex-shrink-0" aria-hidden="true">
                    <svg className="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                      <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                    </svg>
                  </div>
                  <div className="ml-3 flex-1">
                    <p className="text-sm text-red-700 font-medium">Error</p>
                    <p className="text-sm text-red-600 mt-1">{error}</p>
                    {retryCount > 0 && retryCount < maxRetries && (
                      <div className="mt-3">
                        <button
                          onClick={() => handleAnalyze(retryCount)}
                          className="text-sm text-red-700 hover:text-red-900 font-medium underline"
                          aria-label={`Retry analysis (attempt ${retryCount + 1} of ${maxRetries})`}
                        >
                          Retry ({retryCount}/{maxRetries})
                        </button>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* Results Display */}
            {sentiment && (
              <div className="bg-white rounded-lg shadow-lg p-8" role="region" aria-live="polite" aria-label="Sentiment analysis results">
                {/* Score Display */}
                <div className={`text-center mb-6 p-8 rounded-xl border-2 ${getScoreColor(sentiment.score)}`} role="status">
                  <div className="text-6xl font-bold mb-2" aria-label={`Sentiment score: ${sentiment.score} out of 10`}>
                    {sentiment.score}
                  </div>
                  <div className="text-xl font-semibold text-gray-600">
                    / 10
                  </div>
                </div>

                {/* Summary Display */}
                <div className={`rounded-lg p-6 ${getScoreBgColor(sentiment.score)}`}>
                  <div className="flex items-start gap-3">
                    {sentiment.score >= 8 ? (
                      <TrendingUpIcon className="w-6 h-6 text-green-600 flex-shrink-0 mt-1" />
                    ) : (
                      <TrendingDownIcon className="w-6 h-6 text-red-600 flex-shrink-0 mt-1" />
                    )}
                    <div className="flex-1">
                      <h3 className="font-semibold text-gray-900 mb-2">Sentiment Summary</h3>
                      <p className="text-gray-700 leading-relaxed">{sentiment.summary}</p>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Footer Note */}
            <div className="mt-8 text-center">
              <p className="text-xs text-gray-500">
                âœ… Sentiment analysis is securely handled via Vercel Serverless Function
              </p>
            </div>
          </div>
        </div>
      );
    };

    // Error Boundary Component
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }

      componentDidCatch(error, errorInfo) {
        logError('Error Boundary caught an error:', error, errorInfo);
      }

      render() {
        if (this.state.hasError) {
          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center px-4">
              <div className="max-w-md w-full bg-white rounded-lg shadow-xl p-8 text-center">
                <div className="mb-4">
                  <svg className="mx-auto h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                </div>
                <h1 className="text-2xl font-bold text-gray-900 mb-2">Something went wrong</h1>
                <p className="text-gray-600 mb-6">
                  An unexpected error occurred. Please refresh the page to try again.
                </p>
                <button
                  onClick={() => {
                    this.setState({ hasError: false, error: null });
                    window.location.reload();
                  }}
                  className="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                >
                  Refresh Page
                </button>
              </div>
            </div>
          );
        }

        return this.props.children;
      }
    }

    // Analytics helper (structure for future integration)
    const analytics = {
      track: (event, data) => {
        if (isProduction) {
          // In production, send to analytics service
          // Example: gtag('event', event, data);
          log('Analytics:', event, data);
        } else {
          log('Analytics (dev):', event, data);
        }
      },
      pageView: (page) => {
        analytics.track('page_view', { page });
      }
    };

    // Main App Component with Authentication
    const App = () => {
      const [user, setUser] = useState(() => {
        // Check if user is already logged in
        const savedUser = localStorage.getItem('userInfo');
        if (savedUser) {
          try {
            return JSON.parse(savedUser);
          } catch (error) {
            logError('Error parsing saved user info:', error);
            localStorage.removeItem('userInfo');
            return null;
          }
        }
        return null;
      });

      useEffect(() => {
        analytics.pageView(user ? 'dashboard' : 'login');
      }, [user]); // eslint-disable-line react-hooks/exhaustive-deps

      const handleSignIn = async (userInfo) => {
        try {
          // Create or get user from backend
          const response = await fetch('/api/users', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: userInfo.email,
              name: userInfo.name,
              picture: userInfo.picture,
              sub: userInfo.sub,
            }),
          });

          if (!response.ok) {
            throw new Error('Failed to create user');
          }

          const userData = await response.json();
          
          // Save user info to localStorage
          localStorage.setItem('userInfo', JSON.stringify(userData));
          setUser(userData);
          analytics.track('user_signed_in', { email: userData.email, userId: userData.id });
        } catch (error) {
          logError('Error creating user:', error);
          // Fallback to saving Google user info if API fails
          localStorage.setItem('userInfo', JSON.stringify(userInfo));
          setUser(userInfo);
          analytics.track('user_signed_in', { email: userInfo.email });
        }
      };

      if (!user) {
        return <LoginPage onSignIn={handleSignIn} />;
      }

      return <SentimentAnalyzer user={user} />;
    };

    // Register Service Worker for offline support
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            log('Service Worker registered:', registration.scope);
          })
          .catch((error) => {
            logError('Service Worker registration failed:', error);
          });
      });
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
      <ErrorBoundary>
        <App />
      </ErrorBoundary>
    );
  </script>
</body>
</html>

