<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="L.U.C.I. - LeanData Unified Customer Intelligence. Analyze customer sentiment from Avoma transcripts and Salesforce context using AI-powered sentiment analysis">
  <meta name="keywords" content="customer sentiment, sentiment analysis, customer experience, Avoma, Salesforce">
  <meta name="author" content="LeanData">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="L.U.C.I. - LeanData Unified Customer Intelligence">
  <meta property="og:description" content="AI-powered customer sentiment analysis from Avoma transcripts and Salesforce context">
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="L.U.C.I. - LeanData Unified Customer Intelligence">
  <meta name="twitter:description" content="AI-powered customer sentiment analysis">
  
  <title>L.U.C.I. - LeanData Unified Customer Intelligence</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useCallback, useEffect, useRef } = React;

    // Google OAuth Configuration
    // In production, consider moving this to an environment variable
    const GOOGLE_CLIENT_ID = window.GOOGLE_CLIENT_ID || '160384595408-625gmnr4j40cgjp44qkfljoeo6i0n7j9.apps.googleusercontent.com';
    
    // Constants
    const MAX_RETRIES = 50;
    const MAX_INIT_ATTEMPTS = 100;
    const RETRY_DELAY = 100;
    const INIT_DELAY = 100;
    
    // Production check
    const isProduction = window.location.hostname !== 'localhost' && !window.location.hostname.includes('127.0.0.1');
    
    // Console logging helper (disabled in production)
    const log = (...args) => {
      if (!isProduction) {
        console.log(...args);
      }
    };
    
    const logError = (...args) => {
      console.error(...args); // Always log errors
    };

    /**
     * Customer Sentiment Analyzer
     * 
     * Uses secure Vercel Serverless Function (/api/analyze-sentiment) to protect API keys
     */

    // Fetch Avoma transcription data (with caching)
    const fetchAvomaData = async (customerIdentifier, salesforceAccountId = null) => {
      try {
        const response = await fetch('/api/avoma-transcription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            customerIdentifier: customerIdentifier,
            salesforceAccountId: salesforceAccountId,
          }),
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to fetch transcription');
        }

        const data = await response.json();
        // Return transcription and meeting counts
        return {
          transcription: data.transcription || '',
          meetingCounts: data.meetingCounts || null,
        };
      } catch (error) {
        logError('Error fetching Avoma transcription:', error);
        throw error;
      }
    };

    // Fetch Salesforce customer context (using real account data + cases)
    // Note: This function is defined outside component but doesn't use component state
    // Cases are fetched separately via fetchCasesForAccount
    const fetchSalesforceData = async (customerIdentifier, accountData = null) => {
      // Use account data if provided, otherwise return minimal context
      if (!accountData) {
        return {
          account_tier: "Unknown",
          contract_value: "Unknown",
          account_manager: "Unknown",
        };
      }
      
      // Fetch recent cases/tickets for the account
      let recentCases = [];
      let totalCasesCount = 0;
      if (accountData.salesforceId || accountData.id) {
        try {
          const salesforceAccountId = accountData.salesforceId || accountData.id;
          const params = new URLSearchParams({
            salesforceAccountId: salesforceAccountId,
            accountId: accountData.id,
          });
          
          const casesResponse = await fetch(`/api/salesforce-cases?${params}`);
          if (casesResponse.ok) {
            const casesData = await casesResponse.json();
            recentCases = casesData.cases || [];
            totalCasesCount = casesData.total || recentCases.length;
            // Note: Cases are set in state via fetchCasesForAccount, not here
          }
        } catch (err) {
          logError('Error fetching cases:', err);
          // Continue without cases - not critical
        }
      }
      
      // Return real Salesforce account data with cases
      // Include more case details for sentiment analysis (description, type, reason, etc.)
      return {
        account_tier: accountData.accountTier || null,
        contract_value: accountData.contractValue || null,
        account_id: accountData.id,
        account_name: accountData.name,
        industry: accountData.industry || null,
        annual_revenue: accountData.annualRevenue || null,
        account_manager: accountData.ownerName || null,
        recent_tickets: recentCases.map(c => ({
          id: c.caseNumber || c.id,
          subject: c.subject || null,
          status: c.status || null,
          priority: c.priority || null,
          type: c.type || null,
          reason: c.reason || null,
          origin: c.origin || null,
          created_date: c.createdDate || null,
          closed_date: c.closedDate || null,
          description: c.description || null, // Include description for sentiment analysis
        })),
        total_cases_count: totalCasesCount,
      };
    };

    // Analyze sentiment using secure Vercel Serverless Function
    const analyzeSentiment = async (transcription, salesforceContext) => {
      const response = await fetch('/api/analyze-sentiment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          transcription,
          salesforceContext
        })
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
        throw new Error(errorData.error || `Server error: ${response.status}`);
      }

      const result = await response.json();
      
      // Validate score is within range
      if (result.score < 1 || result.score > 10) {
        throw new Error('Invalid sentiment score returned from API');
      }

      return result;
    };

    // Icon Components
    const TrendingUpIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline>
        <polyline points="16 7 22 7 22 13"></polyline>
      </svg>
    );

    const TrendingDownIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="22 17 13.5 8.5 8.5 13.5 2 7"></polyline>
        <polyline points="16 17 22 17 22 11"></polyline>
      </svg>
    );

    const LoaderIcon = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="2" x2="12" y2="6"></line>
        <line x1="12" y1="18" x2="12" y2="22"></line>
        <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
        <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
        <line x1="2" y1="12" x2="6" y2="12"></line>
        <line x1="18" y1="12" x2="22" y2="12"></line>
        <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
        <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
      </svg>
    );

    // Login Component
    const LoginPage = ({ onSignIn }) => {
      const buttonRef = useRef(null);
      const [isLoading, setIsLoading] = useState(true);
      const [error, setError] = useState(null);
      const retryCountRef = useRef(0);
      const [buttonReady, setButtonReady] = useState(false);

      const handleCredentialResponse = useCallback((response) => {
        // Decode the JWT token to get user info
        try {
          const base64Url = response.credential.split('.')[1];
          const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split('')
              .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
              .join('')
          );
          const userInfo = JSON.parse(jsonPayload);
          onSignIn(userInfo);
        } catch (error) {
          logError('Error decoding credential:', error);
          setError('Error signing in. Please try again.');
        }
      }, [onSignIn]);

      // Wait for Google Identity Services to load and initialize
      useEffect(() => {
        let isMounted = true;
        let initAttempts = 0;

        const waitForGoogleAndInit = () => {
          initAttempts++;
          
          if (window.google && window.google.accounts && window.google.accounts.id) {
            try {
              // Initialize Google Sign-In
              window.google.accounts.id.initialize({
                client_id: GOOGLE_CLIENT_ID,
                callback: handleCredentialResponse,
              });
              log('Google Sign-In initialized successfully');
              
              // Now try to render the button
              if (isMounted) {
                renderButton();
              }
            } catch (err) {
              logError('Error initializing Google Sign-In:', err);
              if (isMounted) {
                setError(`Failed to initialize: ${err.message}`);
                setIsLoading(false);
              }
            }
          } else if (initAttempts < MAX_INIT_ATTEMPTS) {
            // Keep waiting for Google Identity Services to load
            setTimeout(waitForGoogleAndInit, INIT_DELAY);
          } else {
            logError('Google Identity Services failed to load after', MAX_INIT_ATTEMPTS, 'attempts');
            if (isMounted) {
              setError('Google Sign-In script failed to load. Please check your internet connection and refresh the page.');
              setIsLoading(false);
            }
          }
        };

        const renderButton = () => {
          if (!isMounted || !buttonReady) {
            // Wait for button to be ready
            if (retryCountRef.current < MAX_RETRIES) {
              retryCountRef.current++;
              setTimeout(renderButton, RETRY_DELAY);
            }
            return;
          }
          
          if (buttonRef.current && window.google && window.google.accounts && window.google.accounts.id) {
            try {
              // Clear any existing content
              buttonRef.current.innerHTML = '';
              
              window.google.accounts.id.renderButton(
                buttonRef.current,
                {
                  theme: 'outline',
                  size: 'large',
                  width: buttonRef.current.offsetWidth || 320,
                  text: 'signin_with',
                }
              );
              log('Google Sign-In button rendered successfully');
              setIsLoading(false);
            } catch (err) {
              logError('Error rendering button:', err);
              if (isMounted) {
                setError(`Failed to render button: ${err.message}. Please check that your domain is authorized in Google OAuth settings.`);
                setIsLoading(false);
              }
            }
          } else if (retryCountRef.current < MAX_RETRIES) {
            retryCountRef.current++;
            setTimeout(renderButton, RETRY_DELAY);
          } else {
            if (!buttonRef.current) {
              logError('Button ref is null');
              if (isMounted) {
                setError('Button element not found. Please refresh the page.');
                setIsLoading(false);
              }
            } else if (!window.google || !window.google.accounts) {
              logError('Google Identity Services not loaded');
              if (isMounted) {
                setError('Google Sign-In script not loaded. Please check your connection.');
                setIsLoading(false);
              }
            } else {
              logError('Unknown error rendering button');
              if (isMounted) {
                setError('Failed to load sign-in button. Please refresh the page.');
                setIsLoading(false);
              }
            }
          }
        };

        // Start waiting for Google Identity Services
        waitForGoogleAndInit();

        return () => {
          isMounted = false;
        };
      }, [handleCredentialResponse, buttonReady]);

      // Set button ready when ref is attached
      useEffect(() => {
        if (buttonRef.current) {
          setButtonReady(true);
        }
      }, []);

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center px-4">
          <div className="max-w-md w-full bg-white rounded-lg shadow-xl p-8">
            <div className="text-center mb-8">
              <h1 className="text-3xl font-bold text-gray-900 mb-2">
                L.U.C.I.
              </h1>
              <p className="text-gray-600">
                Please sign in to continue
              </p>
            </div>
            <div className="space-y-4">
              {/* Always render the button container so ref is available */}
              <div ref={buttonRef} className="w-full" style={{ minHeight: '40px' }}></div>
              
              {isLoading && (
                <div className="flex flex-col items-center justify-center py-2">
                  <LoaderIcon className="w-5 h-5 animate-spin text-blue-600 mb-1" />
                  <p className="text-xs text-gray-500">Loading sign-in...</p>
                </div>
              )}
              
              {error && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                  <p className="text-sm text-red-700">{error}</p>
                  <button
                    onClick={() => window.location.reload()}
                    className="mt-2 text-sm text-red-600 hover:text-red-800 underline"
                  >
                    Refresh page
                  </button>
                </div>
              )}
            </div>
            <p className="text-xs text-gray-500 text-center mt-6">
              By signing in, you agree to our terms of service and privacy policy.
            </p>
          </div>
        </div>
      );
    };

    const SentimentAnalyzer = ({ user }) => {
      const [accounts, setAccounts] = useState([]);
      const [selectedAccount, setSelectedAccount] = useState(null);
      const [loadingAccounts, setLoadingAccounts] = useState(true);
      const [customerIdentifier, setCustomerIdentifier] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [sentiment, setSentiment] = useState(null);
      const [retryCount, setRetryCount] = useState(0);
      const [searchTerm, setSearchTerm] = useState('');
      const [isSearching, setIsSearching] = useState(false);
      const [isSearchMode, setIsSearchMode] = useState(false);
      const [dataSources, setDataSources] = useState(null); // Track data sources used
      const [analysisData, setAnalysisData] = useState(null); // Store actual data used for analysis
      const [showDataDetails, setShowDataDetails] = useState(false); // Toggle for showing data details
      const [cases, setCases] = useState([]); // Store cases for the selected account
      const [casesLoading, setCasesLoading] = useState(false); // Loading state for cases
      const [showCasesList, setShowCasesList] = useState(false); // Toggle for showing cases list
      const maxRetries = 3;
      
      // Fetch cases for an account (can be called independently)
      const fetchCasesForAccount = useCallback(async (accountData) => {
        if (!accountData || (!accountData.salesforceId && !accountData.id)) {
          setCases([]);
          setCasesLoading(false);
          return;
        }

        setCasesLoading(true);
        try {
          const salesforceAccountId = accountData.salesforceId || accountData.id;
          const params = new URLSearchParams({
            salesforceAccountId: salesforceAccountId,
            accountId: accountData.id,
          });
          
          const casesResponse = await fetch(`/api/salesforce-cases?${params}`);
          if (casesResponse.ok) {
            const casesData = await casesResponse.json();
            const fetchedCases = casesData.cases || [];
            setCases(fetchedCases);
          } else {
            setCases([]);
          }
        } catch (err) {
          logError('Error fetching cases:', err);
          setCases([]);
        } finally {
          setCasesLoading(false);
        }
      }, []);
      
      // Fetch Salesforce accounts on mount
      useEffect(() => {
        const fetchAccounts = async () => {
          if (!user?.id && !user?.email) {
            setLoadingAccounts(false);
            return;
          }

          try {
            setLoadingAccounts(true);
            const params = new URLSearchParams({
              userId: user.id || '',
              email: user.email || '',
              role: user.role || '',
            });

            const response = await fetch(`/api/salesforce-accounts?${params}`);
            
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(errorData.message || errorData.error || 'Failed to fetch accounts');
            }

            const data = await response.json();
            setAccounts(data.accounts || []);
            
            // Auto-select first account if available
            if (data.accounts && data.accounts.length > 0) {
              setSelectedAccount(data.accounts[0]);
              setCustomerIdentifier(data.accounts[0].name);
            }
            
            analytics.track('accounts_loaded', { 
              count: data.accounts?.length || 0,
              userId: user.id 
            });
          } catch (err) {
            logError('Error fetching accounts:', err);
            setError(err.message || 'Failed to load accounts. Please refresh the page.');
          } finally {
            setLoadingAccounts(false);
          }
        };

        if (!isSearchMode) {
          fetchAccounts();
        }
      }, [user, isSearchMode]);

      // Search for accounts
      const handleSearch = async (searchQuery) => {
        if (!searchQuery || searchQuery.trim().length < 2) {
          setError('Please enter at least 2 characters to search');
          return;
        }

        try {
          setIsSearching(true);
          setError(null);
          
          const params = new URLSearchParams({
            search: searchQuery.trim(),
            userId: user?.id || '',
          });

          const response = await fetch(`/api/salesforce-accounts?${params}`);
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || errorData.error || 'Failed to search accounts');
          }

          const data = await response.json();
          setAccounts(data.accounts || []);
          setIsSearchMode(true);
          
          // Auto-select first result if available
          if (data.accounts && data.accounts.length > 0) {
            setSelectedAccount(data.accounts[0]);
            setCustomerIdentifier(data.accounts[0].name);
          } else {
            setSelectedAccount(null);
            setCustomerIdentifier('');
          }
          
          analytics.track('accounts_searched', { 
            searchTerm: searchQuery,
            count: data.accounts?.length || 0,
            userId: user?.id 
          });
        } catch (err) {
          logError('Error searching accounts:', err);
          setError(err.message || 'Failed to search accounts. Please try again.');
        } finally {
          setIsSearching(false);
        }
      };

      // Clear search and return to assigned accounts
      const handleClearSearch = () => {
        setSearchTerm('');
        setIsSearchMode(false);
        setSelectedAccount(null);
        setCustomerIdentifier('');
        setError(null);
        // Trigger useEffect to reload assigned accounts
        window.location.reload();
      };

      const handleAnalyze = useCallback(async (attempt = 0) => {
        setLoading(true);
        setError(null);
        setCasesLoading(true);
        if (attempt === 0) {
          setSentiment(null);
        }

        try {
          // Fetch data from both sources in parallel
          const [avomaData, salesforceContext] = await Promise.all([
            fetchAvomaData(customerIdentifier, selectedAccount?.salesforceId || selectedAccount?.id),
            fetchSalesforceData(customerIdentifier, selectedAccount)
          ]);
          
          // Cases are already set in fetchSalesforceData, just update loading state
          setCasesLoading(false);

          // Extract transcription and meeting counts
          const transcription = avomaData.transcription || '';
          const meetingCounts = avomaData.meetingCounts || null;

          // Add counts to salesforce context for sentiment analysis
          const enrichedContext = {
            ...salesforceContext,
            total_cases_count: salesforceContext.total_cases_count || 0,
            total_avoma_calls: meetingCounts?.total || 0,
            ready_avoma_calls: meetingCounts?.ready || 0,
          };

          // Store the actual data used for analysis (for transparency)
          setAnalysisData({
            transcription: transcription,
            salesforceContext: enrichedContext,
            transcriptionPreview: transcription.length > 500 
              ? transcription.substring(0, 500) + '...' 
              : transcription,
          });
          
          // Analyze sentiment
          const result = await analyzeSentiment(transcription, enrichedContext);
          setSentiment(result);
          setRetryCount(0);
          
          // Track data sources used for this analysis
          setDataSources({
            hasTranscription: !!transcription && transcription.length > 0,
            transcriptionLength: transcription.length,
            hasAccountData: !!selectedAccount,
            accountName: selectedAccount?.name || customerIdentifier,
            casesCount: enrichedContext.total_cases_count || 0,
            avomaCallsTotal: enrichedContext.total_avoma_calls || 0,
            avomaCallsReady: enrichedContext.ready_avoma_calls || 0,
            hasCases: (enrichedContext.recent_tickets || []).length > 0,
          });
          
          analytics.track('sentiment_analyzed', { 
            customerIdentifier,
            score: result.score,
            hasTranscription: !!transcription,
            casesCount: enrichedContext.total_cases_count || 0,
            avomaCallsCount: enrichedContext.total_avoma_calls || 0,
          });
        } catch (err) {
          const errorMessage = err.message || 'An error occurred while analyzing sentiment';
          setError(errorMessage);
          logError('Sentiment analysis error:', err);
          
          if (attempt < maxRetries && (err.message?.includes('timeout') || err.message?.includes('network'))) {
            setRetryCount(attempt + 1);
            analytics.track('sentiment_analysis_retry', { attempt: attempt + 1 });
          } else {
            setRetryCount(0);
            analytics.track('sentiment_analysis_failed', { error: errorMessage });
          }
        } finally {
          setLoading(false);
        }
      }, [customerIdentifier]);

      const getScoreColor = (score) => {
        if (score <= 4) return 'text-red-600 bg-red-50 border-red-200';
        if (score <= 7) return 'text-yellow-600 bg-yellow-50 border-yellow-200';
        return 'text-green-600 bg-green-50 border-green-200';
      };

      const getScoreBgColor = (score) => {
        if (score <= 4) return 'bg-red-100';
        if (score <= 7) return 'bg-yellow-100';
        return 'bg-green-100';
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-12 px-4 sm:px-6 lg:px-8">
          <div className="max-w-4xl mx-auto">
            {/* Header with User Info and Logout */}
            <div className="mb-8">
              <div className="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
                <div className="text-center sm:text-left">
                  <h1 className="text-4xl font-bold text-gray-900 mb-2">
                    L.U.C.I.
                  </h1>
                  <p className="text-lg text-gray-600">
                    LeanData Unified Customer Intelligence
                  </p>
                </div>
                <div className="flex items-center gap-4 bg-white px-4 py-2 rounded-lg shadow-sm">
                  <div className="text-right">
                    <p className="text-sm font-medium text-gray-900">
                      {user?.name || 'User'}
                    </p>
                    <p className="text-xs text-gray-500">
                      {user?.email}
                    </p>
                    {user?.role && (
                      <p className="text-xs text-blue-600 font-medium">
                        {user.role}
                      </p>
                    )}
                  </div>
                  <button
                    onClick={() => {
                      window.google?.accounts?.id.disableAutoSelect();
                      localStorage.removeItem('userInfo');
                      window.location.reload();
                    }}
                    className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-50 border border-gray-300 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all whitespace-nowrap"
                  >
                    Sign Out
                  </button>
                </div>
              </div>
            </div>

            {/* Accounts Selection */}
            {loadingAccounts ? (
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div className="flex items-center justify-center py-8">
                  <LoaderIcon className="w-6 h-6 animate-spin text-blue-600 mr-3" />
                  <p className="text-gray-600">Loading your accounts...</p>
                </div>
              </div>
            ) : (
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                {/* My Accounts - Left Side */}
                <div className="bg-white rounded-lg shadow-lg p-6">
                  <label htmlFor="account-select" className="block text-sm font-semibold text-gray-900 mb-4">
                    üìã My Accounts
                  </label>
                  {accounts.length > 0 && !isSearchMode ? (
                    <select
                      id="account-select"
                      value={selectedAccount?.id || ''}
                      onChange={(e) => {
                        const account = accounts.find(acc => acc.id === e.target.value);
                        setSelectedAccount(account);
                        setCustomerIdentifier(account?.name || '');
                      }}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                      aria-label="Select Salesforce account"
                    >
                      <option value="">-- Select an account --</option>
                      {accounts.map((account) => (
                        <option key={account.id} value={account.id}>
                          {account.name} {account.accountTier ? `(${account.accountTier})` : ''}
                        </option>
                      ))}
                    </select>
                  ) : !isSearchMode ? (
                    <div className="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg" role="alert">
                      <p className="text-sm text-yellow-700">
                        No accounts assigned. Use the search to find accounts, or contact your administrator.
                      </p>
                    </div>
                  ) : (
                    <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg" role="alert">
                      <p className="text-sm text-blue-700">
                        Currently showing search results. Select an account from the search results on the right.
                      </p>
                    </div>
                  )}
                </div>

                {/* Search Section - Right Side */}
                <div className="bg-white rounded-lg shadow-lg p-6">
                  <div className="flex items-center justify-between mb-4">
                    <label htmlFor="account-search" className="block text-sm font-semibold text-gray-900">
                      {isSearchMode ? 'üîç Search Results' : 'üîç Search for Any Account'}
                    </label>
                    {isSearchMode && (
                      <button
                        onClick={handleClearSearch}
                        className="text-sm text-blue-600 hover:text-blue-800 underline"
                        aria-label="Clear search and show assigned accounts"
                      >
                        Show My Accounts
                      </button>
                    )}
                  </div>
                  <div className="flex gap-2 mb-4">
                    <input
                      id="account-search"
                      type="text"
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      onKeyPress={(e) => {
                        if (e.key === 'Enter') {
                          handleSearch(searchTerm);
                        }
                      }}
                      placeholder="Type account name to search (min 2 characters)..."
                      className="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                      aria-label="Search for Salesforce account"
                    />
                    <button
                      onClick={() => handleSearch(searchTerm)}
                      disabled={isSearching || !searchTerm || searchTerm.trim().length < 2}
                      className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors font-medium shadow-md"
                      aria-label="Search accounts"
                    >
                      {isSearching ? (
                        <LoaderIcon className="w-5 h-5 animate-spin" />
                      ) : (
                        'Search'
                      )}
                    </button>
                  </div>
                  {isSearchMode && accounts.length > 0 ? (
                    <>
                      <select
                        id="search-account-select"
                        value={selectedAccount?.id || ''}
                        onChange={(e) => {
                          const account = accounts.find(acc => acc.id === e.target.value);
                          setSelectedAccount(account);
                          setCustomerIdentifier(account?.name || '');
                          // Fetch cases when account is selected
                          if (account) {
                            fetchCasesForAccount(account);
                          } else {
                            setCases([]);
                          }
                        }}
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                        aria-label="Select from search results"
                      >
                        <option value="">-- Select from search results --</option>
                        {accounts.map((account) => (
                          <option key={account.id} value={account.id}>
                            {account.name} {account.accountTier ? `(${account.accountTier})` : ''}
                          </option>
                        ))}
                      </select>
                      <p className="text-xs text-gray-500 mt-2">
                        Found {accounts.length} account{accounts.length !== 1 ? 's' : ''}. Select one to analyze.
                      </p>
                    </>
                  ) : isSearchMode ? (
                    <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                      <p className="text-sm text-gray-600">
                        No accounts found matching "{searchTerm}". Try a different search term.
                      </p>
                    </div>
                  ) : (
                    <p className="text-xs text-gray-500">
                      Search for any account in Salesforce by name. Results will appear here.
                    </p>
                  )}
                </div>
              </div>
            )}

            {/* Selected Account Details - Full Width Below Split */}
            {selectedAccount && (
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 className="text-sm font-semibold text-gray-900 mb-4">Selected Account Details</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4">
                  <div>
                    <span className="text-gray-600">Account:</span>
                    <span className="ml-2 font-medium text-gray-900 block">{selectedAccount.name}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">Tier:</span>
                    <span className="ml-2 font-medium text-gray-900">{selectedAccount.accountTier || 'N/A'}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">Contract Value:</span>
                    <span className="ml-2 font-medium text-gray-900">{selectedAccount.contractValue || 'N/A'}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">Industry:</span>
                    <span className="ml-2 font-medium text-gray-900">{selectedAccount.industry || 'N/A'}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">Owner:</span>
                    <span className="ml-2 font-medium text-gray-900">{selectedAccount.ownerName || 'N/A'}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">Support Cases:</span>
                    <span className="ml-2 font-medium text-gray-900">
                      {casesLoading ? (
                        <span className="text-blue-600">Loading...</span>
                      ) : cases.length > 0 ? (
                        <button
                          onClick={() => setShowCasesList(!showCasesList)}
                          className="text-blue-600 hover:text-blue-800 underline font-semibold"
                          aria-label={`${cases.length} cases - click to ${showCasesList ? 'hide' : 'show'} list`}
                        >
                          {cases.length} case{cases.length !== 1 ? 's' : ''}
                        </button>
                      ) : (
                        '0'
                      )}
                    </span>
                  </div>
                </div>

                {/* Cases List - Expandable */}
                {cases.length > 0 && showCasesList && (
                  <div className="mt-4 pt-4 border-t border-gray-200">
                    <div className="flex items-center justify-between mb-3">
                      <h4 className="text-sm font-semibold text-gray-900">
                        Recent Support Cases ({cases.length})
                      </h4>
                      <button
                        onClick={() => setShowCasesList(false)}
                        className="text-xs text-gray-500 hover:text-gray-700"
                        aria-label="Hide cases list"
                      >
                        Hide
                      </button>
                    </div>
                    <div className="space-y-2 max-h-96 overflow-y-auto">
                      {cases.map((caseItem, idx) => {
                        // Build Salesforce URL if we have the case ID
                        const salesforceUrl = caseItem.id 
                          ? `https://leandata.my.salesforce.com/${caseItem.id}`
                          : null;
                        
                        return (
                          <div 
                            key={idx} 
                            className="bg-gray-50 rounded-lg p-3 border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-colors"
                          >
                            <div className="flex items-start justify-between gap-2">
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 mb-1">
                                  {salesforceUrl ? (
                                    <a
                                      href={salesforceUrl}
                                      target="_blank"
                                      rel="noopener noreferrer"
                                      className="font-semibold text-blue-600 hover:text-blue-800 hover:underline text-sm"
                                      onClick={(e) => e.stopPropagation()}
                                    >
                                      {caseItem.caseNumber || `Case ${idx + 1}`}
                                    </a>
                                  ) : (
                                    <span className="font-semibold text-gray-900 text-sm">
                                      {caseItem.caseNumber || `Case ${idx + 1}`}
                                    </span>
                                  )}
                                  <span className={`text-xs px-2 py-0.5 rounded-full ${
                                    caseItem.status === 'Closed' ? 'bg-green-100 text-green-800' :
                                    caseItem.status === 'Open' ? 'bg-blue-100 text-blue-800' :
                                    caseItem.priority === 'High' || caseItem.priority === 'Critical' ? 'bg-red-100 text-red-800' :
                                    'bg-gray-100 text-gray-800'
                                  }`}>
                                    {caseItem.status || 'Unknown'}
                                  </span>
                                  {caseItem.priority && (
                                    <span className="text-xs text-gray-600">
                                      {caseItem.priority} priority
                                    </span>
                                  )}
                                </div>
                                <p className="text-sm text-gray-900 font-medium mb-1">
                                  {caseItem.subject || 'No subject'}
                                </p>
                                {caseItem.createdDate && (
                                  <p className="text-xs text-gray-500">
                                    Created: {new Date(caseItem.createdDate).toLocaleDateString()}
                                    {caseItem.closedDate && (
                                      <span className="ml-2">
                                        ‚Ä¢ Closed: {new Date(caseItem.closedDate).toLocaleDateString()}
                                      </span>
                                    )}
                                  </p>
                                )}
                              </div>
                              {salesforceUrl && (
                                <a
                                  href={salesforceUrl}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="text-blue-600 hover:text-blue-800 flex-shrink-0"
                                  onClick={(e) => e.stopPropagation()}
                                  aria-label={`Open case ${caseItem.caseNumber} in Salesforce`}
                                >
                                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                  </svg>
                                </a>
                              )}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Input Section */}
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <label htmlFor="customer-id" className="block text-sm font-medium text-gray-700 mb-2">
                Customer ID or Account Name
              </label>
              <div className="flex gap-4">
                <input
                  id="customer-id"
                  type="text"
                  value={customerIdentifier}
                  onChange={(e) => setCustomerIdentifier(e.target.value)}
                  className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                  placeholder={selectedAccount ? selectedAccount.name : "Enter customer identifier"}
                  disabled={loading || !selectedAccount}
                  aria-label="Customer ID or Account Name"
                  aria-required="true"
                  maxLength={200}
                />
                <button
                  onClick={handleAnalyze}
                  disabled={loading || !selectedAccount || !customerIdentifier}
                  className="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2 min-w-[140px] justify-center"
                  aria-label={loading ? 'Analyzing sentiment' : 'Analyze customer sentiment'}
                  aria-busy={loading}
                >
                  {loading ? (
                    <>
                      <LoaderIcon className="w-5 h-5 animate-spin" />
                      <span>Analyzing...</span>
                    </>
                  ) : (
                    'Analyze Sentiment'
                  )}
                </button>
              </div>
            </div>

            {/* Error Display */}
            {error && (
              <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg mb-6" role="alert" aria-live="polite">
                <div className="flex">
                  <div className="flex-shrink-0" aria-hidden="true">
                    <svg className="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                      <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                    </svg>
                  </div>
                  <div className="ml-3 flex-1">
                    <p className="text-sm text-red-700 font-medium">Error</p>
                    <p className="text-sm text-red-600 mt-1">{error}</p>
                    {retryCount > 0 && retryCount < maxRetries && (
                      <div className="mt-3">
                        <button
                          onClick={() => handleAnalyze(retryCount)}
                          className="text-sm text-red-700 hover:text-red-900 font-medium underline"
                          aria-label={`Retry analysis (attempt ${retryCount + 1} of ${maxRetries})`}
                        >
                          Retry ({retryCount}/{maxRetries})
                        </button>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* Results Display */}
            {sentiment && (
              <div className="bg-white rounded-lg shadow-lg p-8" role="region" aria-live="polite" aria-label="Sentiment analysis results">
                {/* Score Display */}
                <div className={`text-center mb-6 p-8 rounded-xl border-2 ${getScoreColor(sentiment.score)}`} role="status">
                  <div className="text-6xl font-bold mb-2" aria-label={`Sentiment score: ${sentiment.score} out of 10`}>
                    {sentiment.score}
                  </div>
                  <div className="text-xl font-semibold text-gray-600">
                    / 10
                  </div>
                </div>

                {/* Summary Display */}
                <div className={`rounded-lg p-6 ${getScoreBgColor(sentiment.score)}`}>
                  <div className="flex items-start gap-3">
                    {sentiment.score >= 8 ? (
                      <TrendingUpIcon className="w-6 h-6 text-green-600 flex-shrink-0 mt-1" />
                    ) : (
                      <TrendingDownIcon className="w-6 h-6 text-red-600 flex-shrink-0 mt-1" />
                    )}
                    <div className="flex-1">
                      <h3 className="font-semibold text-gray-900 mb-2">Sentiment Summary</h3>
                      <p className="text-gray-700 leading-relaxed">{sentiment.summary}</p>
                    </div>
                  </div>
                </div>

                {/* Data Sources Explanation */}
                {dataSources && (
                  <div className="mt-6 pt-6 border-t border-gray-200">
                    <h4 className="text-sm font-semibold text-gray-900 mb-3">Analysis Data Sources</h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                      <div className="space-y-2">
                        <div className="flex items-center gap-2">
                          {dataSources.hasTranscription ? (
                            <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                          ) : (
                            <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          )}
                          <span className="font-medium text-gray-700">Avoma Transcription</span>
                        </div>
                        {dataSources.hasTranscription ? (
                          <p className="text-gray-600 ml-7">
                            {dataSources.transcriptionLength.toLocaleString()} characters from customer call/meeting
                            {dataSources.avomaCallsTotal > 0 && (
                              <span className="block mt-1 text-xs text-gray-500">
                                Found {dataSources.avomaCallsTotal} meeting{dataSources.avomaCallsTotal !== 1 ? 's' : ''} 
                                {dataSources.avomaCallsReady > 0 && ` (${dataSources.avomaCallsReady} with ready transcripts)`}
                              </span>
                            )}
                          </p>
                        ) : (
                          <p className="text-gray-500 ml-7 text-xs">No transcription available</p>
                        )}
                      </div>

                      <div className="space-y-2">
                        <div className="flex items-center gap-2">
                          {dataSources.hasAccountData ? (
                            <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                          ) : (
                            <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          )}
                          <span className="font-medium text-gray-700">Salesforce Account</span>
                        </div>
                        {dataSources.hasAccountData ? (
                          <p className="text-gray-600 ml-7">
                            {dataSources.accountName}
                            {dataSources.casesCount > 0 && (
                              <span className="block mt-1 text-xs text-gray-500">
                                {dataSources.casesCount} support case{dataSources.casesCount !== 1 ? 's' : ''} found
                              </span>
                            )}
                          </p>
                        ) : (
                          <p className="text-gray-500 ml-7 text-xs">No account data available</p>
                        )}
                      </div>
                    </div>
                    <div className="mt-4 pt-4 border-t border-gray-100">
                      <p className="text-xs text-gray-500 mb-3">
                        <strong>AI Analysis:</strong> Powered by Google Gemini 2.5 Flash, analyzing conversation tone, 
                        customer language, and account context to generate sentiment score.
                      </p>
                      <button
                        onClick={() => setShowDataDetails(!showDataDetails)}
                        className="text-xs text-blue-600 hover:text-blue-800 font-medium underline flex items-center gap-1"
                        aria-expanded={showDataDetails}
                        aria-label={showDataDetails ? 'Hide data details' : 'Show data details'}
                      >
                        {showDataDetails ? (
                          <>
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                            </svg>
                            Hide Data Used in Analysis
                          </>
                        ) : (
                          <>
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                            </svg>
                            Show Data Used in Analysis
                          </>
                        )}
                      </button>
                    </div>
                  </div>
                )}

                {/* Detailed Data View */}
                {showDataDetails && analysisData && (
                  <div className="mt-6 pt-6 border-t border-gray-300">
                    <h4 className="text-sm font-semibold text-gray-900 mb-4">Exact Data Analyzed</h4>
                    
                    <div className="space-y-4">
                      {/* Transcription Data */}
                      <div className="bg-gray-50 rounded-lg p-4">
                        <div className="flex items-center justify-between mb-2">
                          <h5 className="text-xs font-semibold text-gray-700 uppercase tracking-wide">
                            Avoma Transcription ({analysisData.transcription.length.toLocaleString()} characters)
                          </h5>
                          <span className="text-xs text-gray-500">
                            {Math.round(analysisData.transcription.length / 5)} words
                          </span>
                        </div>
                        <div className="bg-white rounded border border-gray-200 p-3 max-h-64 overflow-y-auto">
                          <pre className="text-xs text-gray-700 whitespace-pre-wrap font-mono">
                            {analysisData.transcriptionPreview}
                            {analysisData.transcription.length > 500 && (
                              <span className="text-gray-400 italic">
                                {'\n\n[... ' + (analysisData.transcription.length - 500).toLocaleString() + ' more characters ...]'}
                              </span>
                            )}
                          </pre>
                        </div>
                      </div>

                      {/* Salesforce Context */}
                      <div className="bg-gray-50 rounded-lg p-4">
                        <h5 className="text-xs font-semibold text-gray-700 uppercase tracking-wide mb-3">
                          Salesforce Account Context
                        </h5>
                        <div className="bg-white rounded border border-gray-200 p-3">
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
                            {analysisData.salesforceContext.account_name && (
                              <div>
                                <span className="font-medium text-gray-600">Account:</span>
                                <span className="ml-2 text-gray-900">{analysisData.salesforceContext.account_name}</span>
                              </div>
                            )}
                            {analysisData.salesforceContext.account_tier && (
                              <div>
                                <span className="font-medium text-gray-600">Tier:</span>
                                <span className="ml-2 text-gray-900">{analysisData.salesforceContext.account_tier}</span>
                              </div>
                            )}
                            {analysisData.salesforceContext.contract_value && (
                              <div>
                                <span className="font-medium text-gray-600">Contract Value:</span>
                                <span className="ml-2 text-gray-900">{analysisData.salesforceContext.contract_value}</span>
                              </div>
                            )}
                            {analysisData.salesforceContext.industry && (
                              <div>
                                <span className="font-medium text-gray-600">Industry:</span>
                                <span className="ml-2 text-gray-900">{analysisData.salesforceContext.industry}</span>
                              </div>
                            )}
                            {analysisData.salesforceContext.annual_revenue && (
                              <div>
                                <span className="font-medium text-gray-600">Annual Revenue:</span>
                                <span className="ml-2 text-gray-900">
                                  ${analysisData.salesforceContext.annual_revenue.toLocaleString()}
                                </span>
                              </div>
                            )}
                            {analysisData.salesforceContext.account_manager && (
                              <div>
                                <span className="font-medium text-gray-600">Account Manager:</span>
                                <span className="ml-2 text-gray-900">{analysisData.salesforceContext.account_manager}</span>
                              </div>
                            )}
                            {analysisData.salesforceContext.total_cases_count !== undefined && (
                              <div>
                                <span className="font-medium text-gray-600">Support Cases:</span>
                                <span className="ml-2 text-gray-900">{analysisData.salesforceContext.total_cases_count}</span>
                              </div>
                            )}
                            {analysisData.salesforceContext.total_avoma_calls !== undefined && (
                              <div>
                                <span className="font-medium text-gray-600">Avoma Meetings:</span>
                                <span className="ml-2 text-gray-900">
                                  {analysisData.salesforceContext.ready_avoma_calls || 0} ready / {analysisData.salesforceContext.total_avoma_calls} total
                                </span>
                              </div>
                            )}
                          </div>

                          {/* Recent Tickets */}
                          {analysisData.salesforceContext.recent_tickets && 
                           analysisData.salesforceContext.recent_tickets.length > 0 && (
                            <div className="mt-4 pt-4 border-t border-gray-200">
                              <div className="flex items-center justify-between mb-2">
                                <span className="text-xs font-semibold text-gray-700">
                                  Recent Support Cases ({analysisData.salesforceContext.recent_tickets.length})
                                </span>
                              </div>
                              <div className="space-y-2">
                                {analysisData.salesforceContext.recent_tickets.slice(0, 5).map((ticket, idx) => (
                                  <div key={idx} className="text-xs bg-gray-50 rounded p-2">
                                    <div className="flex items-center justify-between">
                                      <span className="font-medium text-gray-900">{ticket.subject || 'No subject'}</span>
                                      <span className="text-gray-500">{ticket.status || 'Unknown'}</span>
                                    </div>
                                    {ticket.priority && (
                                      <div className="text-gray-600 mt-1">
                                        Priority: <span className="font-medium">{ticket.priority}</span>
                                        {ticket.created_date && (
                                          <span className="ml-2 text-gray-500">
                                            ‚Ä¢ {new Date(ticket.created_date).toLocaleDateString()}
                                          </span>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                ))}
                                {analysisData.salesforceContext.recent_tickets.length > 5 && (
                                  <p className="text-xs text-gray-500 italic mt-2">
                                    ... and {analysisData.salesforceContext.recent_tickets.length - 5} more case{analysisData.salesforceContext.recent_tickets.length - 5 !== 1 ? 's' : ''}
                                  </p>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Data Summary Stats */}
                      <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <h5 className="text-xs font-semibold text-blue-900 uppercase tracking-wide mb-2">
                          Data Summary
                        </h5>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                          <div>
                            <div className="text-blue-600 font-medium">Transcription</div>
                            <div className="text-blue-900">{analysisData.transcription.length.toLocaleString()} chars</div>
                          </div>
                          <div>
                            <div className="text-blue-600 font-medium">Account Fields</div>
                            <div className="text-blue-900">
                              {Object.keys(analysisData.salesforceContext).filter(k => 
                                !['recent_tickets', 'account_id'].includes(k) && 
                                analysisData.salesforceContext[k] !== null
                              ).length} provided
                            </div>
                          </div>
                          <div>
                            <div className="text-blue-600 font-medium">Support Cases</div>
                            <div className="text-blue-900">
                              {analysisData.salesforceContext.recent_tickets?.length || 0} cases
                            </div>
                          </div>
                          <div>
                            <div className="text-blue-600 font-medium">Total Context</div>
                            <div className="text-blue-900">
                              {(
                                analysisData.transcription.length + 
                                JSON.stringify(analysisData.salesforceContext).length
                              ).toLocaleString()} chars
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Footer Note */}
            <div className="mt-8 text-center">
              <p className="text-xs text-gray-500">
                ‚úÖ Sentiment analysis is securely handled via Vercel Serverless Function
              </p>
            </div>
          </div>
        </div>
      );
    };

    // Error Boundary Component
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }

      componentDidCatch(error, errorInfo) {
        logError('Error Boundary caught an error:', error, errorInfo);
      }

      render() {
        if (this.state.hasError) {
          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center px-4">
              <div className="max-w-md w-full bg-white rounded-lg shadow-xl p-8 text-center">
                <div className="mb-4">
                  <svg className="mx-auto h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                </div>
                <h1 className="text-2xl font-bold text-gray-900 mb-2">Something went wrong</h1>
                <p className="text-gray-600 mb-6">
                  An unexpected error occurred. Please refresh the page to try again.
                </p>
                <button
                  onClick={() => {
                    this.setState({ hasError: false, error: null });
                    window.location.reload();
                  }}
                  className="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                >
                  Refresh Page
                </button>
              </div>
            </div>
          );
        }

        return this.props.children;
      }
    }

    // Analytics helper (structure for future integration)
    const analytics = {
      track: (event, data) => {
        if (isProduction) {
          // In production, send to analytics service
          // Example: gtag('event', event, data);
          log('Analytics:', event, data);
        } else {
          log('Analytics (dev):', event, data);
        }
      },
      pageView: (page) => {
        analytics.track('page_view', { page });
      }
    };

    // Main App Component with Authentication
    const App = () => {
      const [user, setUser] = useState(() => {
        // Check if user is already logged in
        const savedUser = localStorage.getItem('userInfo');
        if (savedUser) {
          try {
            return JSON.parse(savedUser);
          } catch (error) {
            logError('Error parsing saved user info:', error);
            localStorage.removeItem('userInfo');
            return null;
          }
        }
        return null;
      });

      useEffect(() => {
        analytics.pageView(user ? 'dashboard' : 'login');
      }, [user]); // eslint-disable-line react-hooks/exhaustive-deps

      const handleSignIn = async (userInfo) => {
        try {
          // Create or get user from backend
          const response = await fetch('/api/users', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: userInfo.email,
              name: userInfo.name,
              picture: userInfo.picture,
              sub: userInfo.sub,
            }),
          });

          if (!response.ok) {
            throw new Error('Failed to create user');
          }

          const userData = await response.json();
          
          // Save user info to localStorage
          localStorage.setItem('userInfo', JSON.stringify(userData));
          setUser(userData);
          analytics.track('user_signed_in', { email: userData.email, userId: userData.id });
        } catch (error) {
          logError('Error creating user:', error);
          // Fallback to saving Google user info if API fails
          localStorage.setItem('userInfo', JSON.stringify(userInfo));
          setUser(userInfo);
          analytics.track('user_signed_in', { email: userInfo.email });
        }
      };

      if (!user) {
        return <LoginPage onSignIn={handleSignIn} />;
      }

      return <SentimentAnalyzer user={user} />;
    };

    // Register Service Worker for offline support
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            log('Service Worker registered:', registration.scope);
          })
          .catch((error) => {
            logError('Service Worker registration failed:', error);
          });
      });
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
      <ErrorBoundary>
        <App />
      </ErrorBoundary>
    );
  </script>
</body>
</html>

